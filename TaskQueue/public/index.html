<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>TaskQueue ‚Äì Open Tasks</title>
  <style>
    body { font-family: sans-serif; margin: 2rem; }
    h1   { margin-top: 0; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 8px; border: 1px solid #ddd; }
    th { background: #f0f0f0; text-align: left; }
    tr:nth-child(even) { background: #fafafa; }
    a { color: #0366d6; text-decoration: none; }
    button.arrow,
    button.eye,
    button.fib-btn,
    #addTaskBtn,#gearBtn,#instrBtn,#repoBtn,#defaultsBtn{
      border:none;background:none;cursor:pointer;font-size:1rem;line-height:1;padding:0 4px;
    }
    #addTaskBtn{margin-left:1rem;font-size:1.1rem;}
    #gearBtn,#instrBtn,#repoBtn,#defaultsBtn{margin-left:.6rem;font-size:1.2rem;}
    tr.hidden{opacity:.4;}
    .project-cell,.sprint-cell,.priority-cell,.status-cell{cursor:pointer;color:#333;}
    .project-cell:hover,.sprint-cell:hover,.priority-cell:hover,.status-cell:hover{text-decoration:underline dotted;}
    .inline-input{width:100%;box-sizing:border-box;font:inherit;padding:4px;}
    #controls{margin-bottom:1rem;}

    /* ------------ modal ------------ */
    .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.25);align-items:center;justify-content:center;}
    .modal-content{background:#fff;padding:1rem 1.5rem;border-radius:6px;min-width:220px;max-width:600px;max-height:90vh;overflow:auto;}
    .modal-content h2{margin-top:0;}
    .modal-buttons{text-align:right;margin-top:8px;}
    textarea{font-family:monospace;}
  </style>
</head>
<body>
<h1>Open Tasks</h1>

<p>
  <a href="/projects">üìÇ Projects overview</a> ‚Ä¢
  <a href="/sprints">üèÉ‚Äç‚ôÇÔ∏è Sprints overview</a>
</p>

<div id="controls">
  <label><input type="checkbox" id="showHidden" /> Show hidden tasks</label>

  <label style="margin-left:1rem;">Project:
    <select id="projectFilter"><option value="">All projects</option></select>
  </label>

  <label style="margin-left:1rem;">Sprint:
    <select id="sprintFilter"><option value="">All sprints</option></select>
  </label>

  <button id="addTaskBtn">‚ûï New Task</button>
  <button id="instrBtn" title="Agent instructions">üìù</button>
  <button id="gearBtn"  title="Configure columns">‚öôÔ∏è</button>
  <button id="defaultsBtn" title="Default project/sprint">‚≠ê</button>
  <button id="repoBtn" title="Edit Git repository">üîÄ</button>
</div>

<table id="tasks">
  <thead><tr id="headerRow"></tr></thead>
  <tbody></tbody>
</table>

<!-- Column picker modal -->
<div id="colModal" class="modal">
  <div class="modal-content">
    <h2>Visible columns</h2>
    <div id="colCheckboxes"></div>
    <div class="modal-buttons">
      <button id="colSaveBtn">Save</button>
      <button id="colCancelBtn">Cancel</button>
    </div>
  </div>
</div>

<!-- Agent instructions modal -->
<div id="instrModal" class="modal">
  <div class="modal-content">
    <h2>Agent Instructions</h2>
    <textarea id="instrText" rows="10" style="width:100%;"></textarea>
    <div class="modal-buttons">
      <button id="instrSaveBtn">Save</button>
      <button id="instrCancelBtn">Cancel</button>
    </div>
  </div>
</div>

<!-- Git repo modal -->
<div id="repoModal" class="modal">
  <div class="modal-content">
    <h2>Edit Git repository</h2>
    <label>Repository (owner/repo):
      <input type="text" id="repoInput" style="width:100%;" />
    </label>
    <div class="modal-buttons">
      <button id="repoSaveBtn">Save</button>
      <button id="repoCancelBtn">Cancel</button>
    </div>
  </div>
</div>

<!-- Defaults modal -->
<div id="defaultsModal" class="modal">
  <div class="modal-content">
    <h2>Default project / sprint</h2>
    <label>Default project:
      <input type="text" id="defProjectInput" style="width:100%;" />
    </label>
    <label>Default sprint:
      <input type="text" id="defSprintInput" style="width:100%;" />
    </label>
    <div class="modal-buttons">
      <button id="defSaveBtn">Save</button>
      <button id="defCancelBtn">Cancel</button>
    </div>
  </div>
</div>

<!-- New Task modal -->
<div id="newTaskModal" class="modal">
  <div class="modal-content">
    <h2>Create New Task</h2>
    <label>Title:<br/>
      <input type="text" id="newTaskTitle" style="width:100%;" />
    </label>
    <label style="margin-top:8px;">Description:<br/>
      <textarea id="newTaskBody" rows="5" style="width:100%;"></textarea>
    </label>
    <div class="modal-buttons">
      <button id="createTaskBtn">Create</button>
      <button id="cancelTaskBtn">Cancel</button>
    </div>
  </div>
</div>

<script>
/* ---------------- constants ---------------- */
const columns = [
  { key: "order",      label: "P"      },
  { key: "reorder",    label: "‚Üï"     },
  { key: "visibility", label: ""       },
  { key: "priority",   label: "Prio"   },
  { key: "status",     label: "Status" },
  { key: "slug",       label: "Slug"   },
  { key: "repo",       label: "Repo"   },
  { key: "number",     label: "#"      },
  { key: "title",      label: "Title"  },
  { key: "project",    label: "Project"},
  { key: "sprint",     label: "Sprint" },
  { key: "points",     label: "Pts"    },
  { key: "assignee",   label: "Assignee"},
  { key: "created",    label: "Created"}
];

/* --------------- state --------------------- */
let visibleCols = new Set(columns.map(c => c.key));
let allTasks     = [];

/* --------------- helpers ------------------- */
const $  = (sel, ctx=document) => ctx.querySelector(sel);
const $$ = (sel, ctx=document) => [...ctx.querySelectorAll(sel)];
const isoDate = (d) => new Date(d).toLocaleDateString();

/* --------------- modals -------------------- */
function showModal(modal){ modal.style.display="flex"; }
function hideModal(modal){ modal.style.display="none"; }
$$(".modal").forEach(m=>m.addEventListener("click",e=>{ if(e.target===m)hideModal(m);}));

/* ------------------------------------------------------------------
 * Settings helpers
 * ------------------------------------------------------------------ */
async function loadSettings(){
  const r = await fetch("/api/settings/visible_columns");
  if(r.ok){
    const { value } = await r.json();
    if(Array.isArray(value)) visibleCols = new Set(value);
  }
}

async function saveSettings(){
  await fetch("/api/settings",{method:"POST",headers:{"Content-Type":"application/json"},
    body:JSON.stringify({key:"visible_columns",value:[...visibleCols]})});
}

/* ------------------------------------------------------------------
 * Load / render tasks
 * ------------------------------------------------------------------ */
async function fetchTasks(){
  const includeHidden = $("#showHidden").checked;
  const url = `/api/tasks?includeHidden=${includeHidden?1:0}`;
  const res = await fetch(url);
  return res.json();
}
function renderHeader(){
  const tr = $("#headerRow");
  tr.innerHTML = "";
  columns.forEach(col=>{
    if(!visibleCols.has(col.key))return;
    const th = document.createElement("th");
    th.textContent = col.label;
    tr.appendChild(th);
  });
}
function renderBody(){
  const tbody = $("#tasks tbody");
  tbody.innerHTML = "";

  const selectedProj  = $("#projectFilter").value;
  const selectedSprint= $("#sprintFilter").value;

  const rows = allTasks.filter(t=>{
    if(selectedProj && t.project!==selectedProj) return false;
    if(selectedSprint && t.sprint!==selectedSprint) return false;
    return true;
  });

  rows.forEach(t=>{
    const tr = document.createElement("tr");
    tr.dataset.taskId = t.id;
    if(t.hidden) tr.classList.add("hidden");

    columns.forEach(col=>{
      if(!visibleCols.has(col.key))return;
      const td = document.createElement("td");

      switch(col.key){
        case "order":   td.textContent = t.priority_number; break;
        case "priority":
          td.textContent = t.priority;
          td.className="priority-cell";
          break;
        case "status":
          td.textContent = t.status;
          td.className="status-cell";
          break;
        case "slug":    td.textContent = t.task_id_slug; break;
        case "repo":    td.textContent = t.repository; break;
        case "reorder":
          td.innerHTML = `
            <button class="arrow" data-id="${t.id}" data-dir="up">‚¨ÜÔ∏è</button>
            <button class="arrow" data-id="${t.id}" data-dir="down">‚¨áÔ∏è</button>`;
          break;
        case "visibility":
          td.innerHTML = `<button class="eye" data-id="${t.id}">${t.hidden?"üôà":"üëÅÔ∏è"}</button>`;
          break;
        case "number":
          td.innerHTML = `<a href="${t.html_url}" target="_blank">#${t.number}</a>`;
          break;
        case "title":
          td.innerHTML = `<a href="${t.html_url}" target="_blank">${t.title}</a>`;
          break;
        case "project":
          td.textContent = t.project; 
          td.className="project-cell";
          break;
        case "sprint":
          td.textContent = t.sprint;  
          td.className="sprint-cell";
          break;
        case "points":
          td.textContent = t.fib_points ?? ""; 
          break;
        case "assignee":
          td.textContent = t.assignee ?? ""; 
          break;
        case "created":
          td.textContent = isoDate(t.created_at); 
          break;
        default: 
          td.textContent = t[col.key]??"";
      }
      tr.appendChild(td);
    });
    tbody.appendChild(tr);
  });
}
async function loadTasks(){
  allTasks = await fetchTasks();
  renderHeader();
  renderBody();
}

/* ------------------------------------------------------------------
 * Filters (projects / sprints)
 * ------------------------------------------------------------------ */
async function populateFilters(){
  const projRes = await fetch("/api/projects");
  const projects = await projRes.json();
  $("#projectFilter").innerHTML =
    '<option value="">All projects</option>' +
    projects.map(p=>`<option value="${p.project}">${p.project}</option>`).join("");

  const sprintRes = await fetch("/api/sprints");
  const sprints = await sprintRes.json();
  $("#sprintFilter").innerHTML =
    '<option value="">All sprints</option>' +
    sprints.map(s=>`<option value="${s.sprint}">${s.sprint}</option>`).join("");
}

/* ------------------------------------------------------------------
 * Column picker modal logic
 * ------------------------------------------------------------------ */
function openColModal(){
  $("#colCheckboxes").innerHTML = columns.map(c=>`
      <label>
        <input type="checkbox" value="${c.key}" ${visibleCols.has(c.key)?"checked":""}/>
        ${c.label||c.key}
      </label>
    `).join("<br/>");
  showModal($("#colModal"));
}
$("#gearBtn").addEventListener("click",openColModal);
$("#colSaveBtn").addEventListener("click", async ()=>{
  const checked = $$("#colCheckboxes input:checked").map(el=>el.value);
  visibleCols = new Set(checked);
  await saveSettings();
  hideModal($("#colModal"));
  await loadTasks();
});
$("#colCancelBtn").addEventListener("click", ()=>hideModal($("#colModal")));

/* ------------------------------------------------------------------
 * Row interactions (visibility / reorder / priority / status)
 * ------------------------------------------------------------------ */
$("#tasks").addEventListener("click", async (e)=>{
  const btn = e.target.closest("button");
  if(btn){
    /* visibility toggle */
    if(btn.classList.contains("eye")){
      const id = +btn.dataset.id;
      const hiddenNow = btn.textContent==="üëÅÔ∏è";
      await fetch("/api/tasks/hidden",{method:"POST",headers:{"Content-Type":"application/json"},
        body:JSON.stringify({id, hidden:hiddenNow})});
      await loadTasks();
    }

    /* reorder */
    if(btn.classList.contains("arrow")){
      const id = +btn.dataset.id;
      const direction = btn.dataset.dir;
      await fetch("/api/tasks/reorder",{method:"POST",headers:{"Content-Type":"application/json"},
        body:JSON.stringify({id,direction})});
      await loadTasks();
    }
  }

  /* Priority cell click */
  if(e.target.classList.contains("priority-cell")){
    const row = e.target.closest("tr");
    const taskId = +row.dataset.taskId;
    const currentPrio = e.target.textContent.trim();

    const select = document.createElement("select");
    ["Low","Medium","High"].forEach(optVal=>{
      const o = document.createElement("option");
      o.value=optVal; o.textContent=optVal;
      if(optVal===currentPrio) o.selected=true;
      select.appendChild(o);
    });

    e.target.textContent="";
    e.target.appendChild(select);
    select.focus();

    select.addEventListener("change", async ()=>{
      const chosen = select.value;
      await fetch("/api/tasks/priority", {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({id:taskId, priority:chosen})
      });
      await loadTasks();
    });

    select.addEventListener("blur", async ()=>{
      await loadTasks();
    });
  }

  /* Status cell click */
  if(e.target.classList.contains("status-cell")){
    const row = e.target.closest("tr");
    const taskId = +row.dataset.taskId;
    const currentStatus = e.target.textContent.trim();

    const statusSelect = document.createElement("select");
    ["Not Started","In Progress","Done"].forEach(optVal=>{
      const o = document.createElement("option");
      o.value=optVal; o.textContent=optVal;
      if(optVal===currentStatus) o.selected=true;
      statusSelect.appendChild(o);
    });

    e.target.textContent="";
    e.target.appendChild(statusSelect);
    statusSelect.focus();

    statusSelect.addEventListener("change", async ()=>{
      const chosen = statusSelect.value;
      await fetch("/api/tasks/status", {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({id:taskId, status:chosen})
      });
      await loadTasks();
    });

    statusSelect.addEventListener("blur", async ()=>{
      await loadTasks();
    });
  }
});

/* ------------------------------------------------------------------
 * Basic controls
 * ------------------------------------------------------------------ */
$("#showHidden").addEventListener("change", loadTasks);
$("#projectFilter").addEventListener("change", renderBody);
$("#sprintFilter").addEventListener("change", renderBody);

/* ------------------------------------------------------------------
 * Modal hooking (instructions)
 * ------------------------------------------------------------------ */
$("#instrBtn").addEventListener("click", async ()=>{
  const r = await fetch("/api/settings/agent_instructions");
  if(r.ok){
    const { value } = await r.json();
    $("#instrText").value = value || "";
  }
  showModal($("#instrModal"));
});
$("#instrSaveBtn").addEventListener("click", async ()=>{
  const val = $("#instrText").value;
  await fetch("/api/settings",{
    method:"POST",headers:{"Content-Type":"application/json"},
    body:JSON.stringify({key:"agent_instructions",value:val})
  });
  hideModal($("#instrModal"));
});
$("#instrCancelBtn").addEventListener("click", ()=>{
  hideModal($("#instrModal"));
});

/* ------------------------------------------------------------------
 * Modal hooking (repo)
 * ------------------------------------------------------------------ */
$("#repoBtn").addEventListener("click", async ()=>{
  const r = await fetch("/api/settings/github_repo");
  if(r.ok){
    const { value } = await r.json();
    $("#repoInput").value = value || "";
  }
  showModal($("#repoModal"));
});
$("#repoSaveBtn").addEventListener("click", async ()=>{
  const val = $("#repoInput").value;
  await fetch("/api/settings",{
    method:"POST",headers:{"Content-Type":"application/json"},
    body:JSON.stringify({key:"github_repo",value:val})
  });
  hideModal($("#repoModal"));
});
$("#repoCancelBtn").addEventListener("click", ()=>{
  hideModal($("#repoModal"));
});

/* ------------------------------------------------------------------
 * Modal hooking (defaults)
 * ------------------------------------------------------------------ */
$("#defaultsBtn").addEventListener("click", async ()=>{
  let r = await fetch("/api/settings/default_project");
  if(r.ok){
    const { value } = await r.json();
    $("#defProjectInput").value = value || "";
  }
  r = await fetch("/api/settings/default_sprint");
  if(r.ok){
    const { value } = await r.json();
    $("#defSprintInput").value = value || "";
  }
  showModal($("#defaultsModal"));
});
$("#defSaveBtn").addEventListener("click", async ()=>{
  const dp = $("#defProjectInput").value;
  const ds = $("#defSprintInput").value;
  await fetch("/api/settings",{
    method:"POST",headers:{"Content-Type":"application/json"},
    body:JSON.stringify({key:"default_project",value:dp})
  });
  await fetch("/api/settings",{
    method:"POST",headers:{"Content-Type":"application/json"},
    body:JSON.stringify({key:"default_sprint",value:ds})
  });
  hideModal($("#defaultsModal"));
});
$("#defCancelBtn").addEventListener("click", ()=>{
  hideModal($("#defaultsModal"));
});

/* ------------------------------------------------------------------
 * Modal hooking (new task)
 * ------------------------------------------------------------------ */
$("#addTaskBtn").addEventListener("click", ()=>{
  $("#newTaskTitle").value = "";
  $("#newTaskBody").value = "";
  showModal($("#newTaskModal"));
});
$("#createTaskBtn").addEventListener("click", async ()=>{
  const title = $("#newTaskTitle").value.trim();
  const body = $("#newTaskBody").value.trim();
  if(!title) {
    alert("Please enter a title for the new task.");
    return;
  }
  const res = await fetch("/api/tasks/new", {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({ title, body })
  });
  if(!res.ok){
    alert("Error creating task. Check console/logs.");
    return;
  }
  hideModal($("#newTaskModal"));
  await loadTasks();
});
$("#cancelTaskBtn").addEventListener("click", ()=>{
  hideModal($("#newTaskModal"));
});

/* ------------------------------------------------------------------
 * Init sequence
 * ------------------------------------------------------------------ */
(async function init(){
  await loadSettings();
  await populateFilters();
  await loadTasks();
})();
</script>
</body>
</html>

