<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Alfe: Task Queue</title>
  <link rel="stylesheet" href="styles.css" />
  <link
          id="favicon"
          rel="icon"
          type="image/x-icon"
          href="alfe_favicon_clean_64x64.ico"
  />
</head>
<body>

<div class="app">
  <aside class="sidebar">
    <!-- Tree-style menu with sections -->
    <nav class="tree-menu">
      <ul>
        <li>
          <details open>
            <summary>Project Tools</summary>
            <ul>
              <li><button id="navTasksBtn" class="tree-button active">Tasks</button></li>
              <li><button id="navUploaderBtn" class="tree-button">Uploader</button></li>
              <li><button id="navFileTreeBtn" class="tree-button">File Tree</button></li>
              <li><a href="/ai_models" class="tree-button" style="text-decoration:none; color:inherit;">AI Models</a></li>
            </ul>
          </details>
        </li>
        <li>
          <details>
            <summary>Collaboration</summary>
            <ul>
              <li><button id="navChatTabsBtn" class="tree-button">Chat Tabs</button></li>
              <li><button id="navActivityIframeBtn" class="tree-button">Activity IFrame</button></li>
            </ul>
          </details>
        </li>
        <li>
          <details>
            <summary>Options</summary>
            <ul>
              <li><button id="toggleSidebarBtn" class="tree-button">Hide sidebar</button></li>
            </ul>
          </details>
        </li>
      </ul>
    </nav>

    <!-- Tasks view panel -->
    <div id="sidebarViewTasks">
      <h2 style="font-size:1.2rem; margin-top:0;">Tasks</h2>
      <p><a href="/activity" target="_blank">Activity timeline</a></p>
      <p><a href="/test_projects" target="_blank">API test page</a></p>

      <details id="toolbarCollapsible" open>
        <summary>Toolbar & Filters</summary>
        <div id="controls">
          <label><input type="checkbox" id="showHidden" /> Show hidden tasks</label>
          <label style="margin-left:1rem;">Project:
            <select id="projectFilter"><option value="">All projects</option></select>
          </label>
          <label style="margin-left:1rem;">Sprint:
            <select id="sprintFilter"><option value="">All sprints</option></select>
          </label>
          <button id="addTaskBtn" style="margin-top:4px;">‚ûï New Task</button>
          <button id="instrBtn" title="Agent instructions">üìù</button>
          <button id="colBtn" title="Configure columns">üîß</button>
          <button id="gearBtn" title="Task List Config">‚öôÔ∏è</button>
          <button id="defaultsBtn" title="Default project/sprint">‚≠ê</button>
          <button id="repoBtn" title="Edit Git repository">üîÄ</button>
          <button id="projConfigBtn" title="Configure Projects">Configure Projects</button>
          <button id="toggleTasksBtn">Hide tasks</button>
        </div>
      </details>

      <table id="tasks">
        <thead><tr id="headerRow"></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Uploader view panel (hidden by default) -->
    <div id="sidebarViewUploader" style="display:none;">
      <h2>Secure File Uploader</h2>
      <form id="secureUploadForm" enctype="multipart/form-data" method="POST">
        <input type="file" id="fileInput"/>
        <button type="submit">Upload</button>
      </form>
      <ul id="secureFilesList"></ul>
    </div>

    <!-- New File Tree view panel (hidden by default) -->
    <div id="sidebarViewFileTree" style="display:none;">
      <h2>Sterling File Tree</h2>
      <p>Expand or collapse directories. Select files with checkboxes.</p>
      <div id="fileTreeContainer" style="margin-top:1rem; max-height:60vh; overflow:auto;"></div>
    </div>

    <!-- New Chat Tabs view panel -->
    <div id="sidebarViewChatTabs" style="display:none;">
      <h2>Chat Tabs</h2>
      <div id="verticalTabsContainer" style="display:flex;flex-direction:column;gap:4px;"></div>
      <button id="newSideTabBtn">‚ûï Tab</button>
      <button id="toggleTopChatTabsBtn">Hide chat tabs bar</button>
    </div>

    <!-- New Activity IFrame panel -->
    <div id="sidebarViewActivityIframe" style="display:none;">
      <h2>Activity IFrame</h2>
      <iframe src="http://localhost:3000/activity" style="width:100%; height:800px; border:none;"></iframe>
    </div>
  </aside>

  <div id="divider" class="divider"></div>

  <div class="exclamation-icon" title="Placeholder tooltip">!</div>

  <div id="expandSidebarBtn" style="position: absolute; top: 60px; left: 8px; background: #444; color: #ddd; padding: 4px 8px; cursor: pointer; z-index: 999; display: none;">
    Show Sidebar
  </div>

  <main class="chat-panel">
    <div id="chatTabs">
      <div id="tabsContainer" style="flex-wrap: wrap; display: flex; gap: 0.5rem;"></div>
      <button id="newTabBtn">‚ûï Tab</button>
      <button id="scrollDownBtn">Scroll to Bottom</button>
      <div id="projectInfo" style="font-size:0.9rem; color:#aaa; margin-bottom:4px;"></div>
      <button id="setProjectBtn">Set Project</button>
      <button id="createSterlingChatBtn">Create Sterling Chat</button>
      <button id="changeSterlingBranchBtn" style="margin-left:6px;">Change Sterling Branch</button>
      <span id="sterlingUrlLabel" style="margin-left:1rem; color:#0f0;"></span>
    </div>

    <!-- New Empty Task List Panel Above Chat UI -->
    <div id="taskListPanel" style="border:1px dashed #666; padding:8px; margin:8px 0;">
      <h2 style="margin:0;font-size:1.1rem;">Task List</h2>
      <!-- This panel is currently used for the global Markdown editing -->
      <div id="markdownContainer" style="margin-top:8px;border:1px solid #444; padding:8px;">
        <label for="markdownInput" style="font-weight:bold;">
          Markdown Contents:
          <button id="markdownGearIcon" title="Open Markdown Menu">‚öôÔ∏è</button>
        </label>
        <textarea id="markdownInput" name="markdownContent" style="width:100%; height:150px; background:#2b2b2b; color:#ddd;"></textarea>
        <div style="margin-top:8px;">
          <button id="saveMdBtn">Save</button>
        </div>
      </div>
    </div>

    <div id="chatPanel" style="position: relative;">
      <div style="display: flex; align-items: center; gap: 0.5rem;">
        <div id="modelHud" style="font-size:0.9rem; color:#aaa; margin-bottom:4px;"></div>
        <button id="chatSettingsBtn" title="Chat Settings">‚öôÔ∏è</button>
      </div>

      <!-- New 'model tabs' section -->
      <div id="modelTabs" style="display:flex; gap:0.5rem; align-items:center; margin-bottom:4px;">
        <div id="modelTabsContainer" style="flex-wrap: wrap;display:flex;gap:0.5rem;"></div>
        <button id="newModelTabBtn">‚ûï Model</button>
        <!-- Added toggle for model tabs bar -->
        <button id="toggleModelTabsBtn">Hide model tabs bar</button>
      </div>

      <div id="chatMessages"></div>

      <div id="waitingCounter"></div>
      <div class="chat-input-container">
        <textarea id="chatInput" placeholder="Type your message..."></textarea>
        <button id="chatSendBtn" class="send-btn">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
               stroke-linecap="round" stroke-linejoin="round" class="feather feather-send">
            <line x1="22" y1="2" x2="11" y2="13"></line>
            <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
          </svg>
        </button>
      </div>
    </div>
  </main>
</div>

<div id="colModal" class="modal">
  <div class="modal-content">
    <h2>Columns</h2>
    <div id="colList"></div>
    <div class="modal-buttons">
      <button id="colSaveBtn">Save</button>
      <button id="colCancelBtn">Cancel</button>
    </div>
  </div>
</div>

<div id="instrModal" class="modal">
  <div class="modal-content">
    <h2>Agent Instructions</h2>
    <label>Agent Name:
      <input type="text" id="agentNameInput" style="width:100%;" />
    </label>
    <br/><br/>
    <label>Instructions:<br/>
      <textarea id="instrText" rows="10" style="width:100%;"></textarea>
    </label>
    <div class="modal-buttons">
      <button id="instrSaveBtn">Save</button>
      <button id="instrCancelBtn">Cancel</button>
    </div>
  </div>
</div>

<div id="repoModal" class="modal">
  <div class="modal-content">
    <h2>TaskList Git SSH URL</h2>
    <label>Enter SSH URL:
      <input type="text" id="repoInput" style="width:100%;" />
    </label>
    <div class="modal-buttons">
      <button id="repoSaveBtn">Save</button>
      <button id="repoCancelBtn">Cancel</button>
    </div>
  </div>
</div>

<div id="defaultsModal" class="modal">
  <div class="modal-content">
    <h2>Default project / sprint</h2>
    <label>Default project:
      <input type="text" id="defProjectInput" style="width:100%;" />
    </label>
    <label>Default sprint:
      <input type="text" id="defSprintInput" style="width:100%;" />
    </label>
    <div class="modal-buttons">
      <button id="defSaveBtn">Save</button>
      <button id="defCancelBtn">Cancel</button>
    </div>
  </div>
</div>

<div id="newTaskModal" class="modal">
  <div class="modal-content">
    <h2>Create New Task</h2>
    <label>Title:<br/>
      <input type="text" id="newTaskTitle" style="width:100%;" />
    </label>
    <label style="margin-top:8px;">Description:<br/>
      <textarea id="newTaskBody" rows="5" style="width:100%;"></textarea>
    </label>
    <div class="modal-buttons">
      <button id="createTaskBtn">Create</button>
      <button id="cancelTaskBtn">Cancel</button>
    </div>
  </div>
</div>

<div id="chatSettingsModal" class="modal">
  <div class="modal-content">
    <h2>Chat Settings</h2>
    <label><input type="checkbox" id="hideMetadataCheck"/> Hide metadata expansions</label>
    <br/>
    <label><input type="checkbox" id="autoNamingCheck" checked/> Auto name new chat tabs using project</label>
    <br/>
    <label><input type="checkbox" id="subbubbleTokenCheck" checked/> Show token usage on each subbubble</label>
    <br/>
    <label><input type="checkbox" id="sterlingUrlCheck"/> Show Sterling chat URL</label>
    <br/>
    <label><input type="checkbox" id="chatStreamingCheck" checked/> Enable streaming completions</label>
    <br/>
    <div style="margin-top:8px;">
      <label>AI Service:
        <select id="aiServiceSelect">
          <option value="openai">OpenAI</option>
          <option value="openrouter">OpenRouter</option>
        </select>
      </label>
    </div>
    <div style="margin-top:8px;">
      <label>Provider:
        <select id="aiModelProviderSelect">
          <option value="">All Providers</option>
          <option value="openai">openai</option>
          <option value="openrouter">openrouter</option>
          <option value="deepseek">deepseek</option>
        </select>
      </label>
    </div>
    <div style="margin-top:8px;">
      <label>AI Model:
        <select id="aiModelSelect">
          <!-- populated dynamically -->
        </select>
      </label>
      <label style="margin-left:8px;"><input type="checkbox" id="favoritesOnlyModelCheck" /> Favorites Only</label>
    </div>
    <div class="modal-buttons">
      <button id="chatSettingsSaveBtn">Save</button>
      <button id="chatSettingsCancelBtn">Cancel</button>
    </div>
  </div>
</div>

<div id="projectsModal" class="modal">
  <div class="modal-content">
    <h2>Configure Projects</h2>
    <p>Specify the base branch for each project. Click the project name cell to rename it globally.</p>
    <table id="projectsTable" style="width:100%; border-collapse:collapse;">
      <thead>
      <tr>
        <th>Project</th>
        <th>Base Branch</th>
        <th></th>
      </tr>
      </thead>
      <tbody></tbody>
    </table>
    <div class="modal-buttons">
      <button id="projectsSaveBtn">Save</button>
      <button id="projectsCancelBtn">Cancel</button>
    </div>
  </div>
</div>

<div id="setProjectModal" class="modal">
  <div class="modal-content">
    <h2>Set Project</h2>
    <label>
      Project name:
      <input type="text" id="selectedProjectInput" style="width:100%;" />
    </label>
    <div class="modal-buttons">
      <button id="setProjectSaveBtn">Save</button>
      <button id="setProjectCancelBtn">Cancel</button>
    </div>
  </div>
</div>

<!-- New modal for changing the branch in Sterling chat -->
<div id="changeBranchModal" class="modal">
  <div class="modal-content">
    <h2>Change Sterling Branch</h2>
    <label>
      <input type="checkbox" id="createSterlingNewBranchCheck" />
      Create new branch?
    </label>
    <label style="margin-top:8px; display:block;">
      Existing or Branch Name:
      <input type="text" id="sterlingBranchNameInput" style="width:100%;" />
    </label>
    <div class="modal-buttons">
      <button id="sterlingBranchSaveBtn">Save</button>
      <button id="sterlingBranchCancelBtn">Cancel</button>
    </div>
    <p id="sterlingBranchMsg" style="margin-top:8px; color:#aaa;"></p>
  </div>
</div>

<!-- New Markdown Menu modal -->
<div id="mdMenuModal" class="modal">
  <div class="modal-content">
    <h2>Markdown Menu</h2>
    <ul>
      <li>Implemented a new task list configuration menu, opened via a gear icon button in the panel.</li>
      <li>Added input for specifying a remote Git repository (SSH URL).</li>
      <li>On every save of the global markdown file, the server now checks out (or updates) the repo in ~/.alfeai/tasklistRepo, copies markdown_global.txt there, then commits and pushes.</li>
    </ul>
    <div class="modal-buttons">
      <button id="mdMenuCloseBtn">Close</button>
    </div>
  </div>
</div>

<!-- New Task List Configuration modal -->
<div id="taskListConfigModal" class="modal">
  <div class="modal-content">
    <h2>Task List Configuration</h2>
    <p>Configure your task list options here.</p>
    <div class="modal-buttons">
      <button id="taskListConfigCloseBtn">Close</button>
    </div>
  </div>
</div>

<script src="main.js"></script>
</body>
</html>
