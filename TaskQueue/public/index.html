<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>TaskQueue ‚Äì Open Tasks</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 2rem;
    }
    h1 {
      margin-top: 0;
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th,
    td {
      padding: 8px;
      border: 1px solid #ddd;
    }
    th {
      background: #f0f0f0;
      text-align: left;
    }
    tr:nth-child(even) {
      background: #fafafa;
    }
    a {
      color: #0366d6;
      text-decoration: none;
    }
    button.arrow,
    button.eye,
    button.fib-btn,
    #addTaskBtn,
    #gearBtn,
    #instrBtn,
    #repoBtn,
    #defaultsBtn {
      border: none;
      background: none;
      cursor: pointer;
      font-size: 1rem;
      line-height: 1;
      padding: 0 4px;
    }
    #addTaskBtn {
      margin-left: 1rem;
      font-size: 1.1rem;
    }
    #gearBtn,
    #instrBtn,
    #repoBtn,
    #defaultsBtn {
      margin-left: 0.6rem;
      font-size: 1.2rem;
    }
    tr.hidden {
      opacity: 0.4;
    }
    .project-cell,
    .sprint-cell {
      cursor: pointer;
      color: #333;
    }
    .project-cell:hover,
    .sprint-cell:hover {
      text-decoration: underline dotted;
    }
    .inline-input {
      width: 100%;
      box-sizing: border-box;
      font: inherit;
      padding: 4px;
    }
    #controls {
      margin-bottom: 1rem;
    }

    /* ------------ modal ------------ */
    .modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.25);
      align-items: center;
      justify-content: center;
    }
    .modal-content {
      background: #fff;
      padding: 1rem 1.5rem;
      border-radius: 6px;
      min-width: 220px;
      max-width: 600px;
      max-height: 90vh;
      overflow: auto;
    }
    .modal-content h2 {
      margin-top: 0;
    }
    .modal-content label {
      display: block;
      margin: 4px 0;
    }
    .modal-buttons {
      text-align: right;
      margin-top: 8px;
    }
    textarea {
      font-family: monospace;
    }
  </style>
</head>
<body>
<h1>Open Tasks</h1>

<!-- navigation links -->
<p>
  <a href="/projects">üìÇ Projects overview</a> ‚Ä¢
  <a href="/sprints">üèÉ‚Äç‚ôÇÔ∏è Sprints overview</a>
</p>

<div id="controls">
  <label>
    <input type="checkbox" id="showHidden" />
    Show hidden tasks
  </label>

  <!-- project filter dropdown -->
  <label style="margin-left:1rem;">
    Project:
    <select id="projectFilter">
      <option value="">All projects</option>
    </select>
  </label>

  <!-- sprint filter dropdown -->
  <label style="margin-left:1rem;">
    Sprint:
    <select id="sprintFilter">
      <option value="">All sprints</option>
    </select>
  </label>

  <button id="addTaskBtn">‚ûï New Task</button>
  <button id="instrBtn" title="Agent instructions">üìù</button>
  <button id="gearBtn" title="Configure columns">‚öôÔ∏è</button>
  <button id="defaultsBtn" title="Default project/sprint">‚≠ê</button>
  <button id="repoBtn" title="Edit Git repository">üîÄ</button>
</div>

<table id="tasks">
  <thead>
  <tr id="headerRow"></tr>
  </thead>
  <tbody></tbody>
</table>

<!-- Column picker modal -->
<div id="colModal" class="modal">
  <div class="modal-content">
    <h2>Visible columns</h2>
    <div id="colCheckboxes"></div>
    <div class="modal-buttons">
      <button id="colSaveBtn">Save</button>
      <button id="colCancelBtn">Cancel</button>
    </div>
  </div>
</div>

<!-- Agent instructions modal -->
<div id="instrModal" class="modal">
  <div class="modal-content">
    <h2>Agent Instructions</h2>
    <textarea id="instrText" rows="10" style="width:100%;"></textarea>
    <div class="modal-buttons">
      <button id="instrSaveBtn">Save</button>
      <button id="instrCancelBtn">Cancel</button>
    </div>
  </div>
</div>

<!-- Git repo modal -->
<div id="repoModal" class="modal">
  <div class="modal-content">
    <h2>Edit Git repository</h2>
    <label>
      Repository (owner/repo):
      <input type="text" id="repoInput" style="width:100%;" />
    </label>
    <div class="modal-buttons">
      <button id="repoSaveBtn">Save</button>
      <button id="repoCancelBtn">Cancel</button>
    </div>
  </div>
</div>

<!-- Defaults modal -->
<div id="defaultsModal" class="modal">
  <div class="modal-content">
    <h2>Default project / sprint</h2>
    <label>
      Default project:
      <input type="text" id="defProjectInput" style="width:100%;" />
    </label>
    <label>
      Default sprint:
      <input type="text" id="defSprintInput" style="width:100%;" />
    </label>
    <div class="modal-buttons">
      <button id="defSaveBtn">Save</button>
      <button id="defCancelBtn">Cancel</button>
    </div>
  </div>
</div>

<script>
  /* ---------------- constants ---------------- */
  const columns = [
    { key: "order", label: "P" },
    { key: "reorder", label: "‚Üï" },
    { key: "visibility", label: "" },
    { key: "priority", label: "Prio" },
    { key: "slug", label: "Slug" },
    { key: "repo", label: "Repo" },
    { key: "number", label: "#" },
    { key: "title", label: "Title" },
    { key: "project", label: "Project" },
    { key: "sprint", label: "Sprint" },
    { key: "points", label: "Pts" },
    { key: "assignee", label: "Assignee" },
    { key: "created", label: "Created" }
  ];

  /* --------------- state --------------------- */
  let visibleCols = new Set(columns.map((c) => c.key));

  /* --------------- selectors ----------------- */
  const $ = (sel, ctx = document) => ctx.querySelector(sel);
  const $$ = (sel, ctx = document) => [...ctx.querySelectorAll(sel)];

  /* ------------------------------------------------------------------
   * Settings helpers (persist on server)
   * ------------------------------------------------------------------ */
  async function loadSettings() {
    const res = await fetch("/api/settings/visible_columns");
    if (res.ok) {
      const { value } = await res.json();
      if (Array.isArray(value)) visibleCols = new Set(value);
    }
  }

  async function saveSettings() {
    await fetch("/api/settings", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        key: "visible_columns",
        value: [...visibleCols]
      })
    });
  }

  /* ------------------------------------------------------------------
   * Default project / sprint helpers
   * ------------------------------------------------------------------ */
  async function loadDefaults() {
    let project = "";
    let sprint = "";
    try {
      const p = await fetch("/api/settings/default_project");
      if (p.ok) ({ value: project } = await p.json());
    } catch {}
    try {
      const s = await fetch("/api/settings/default_sprint");
      if (s.ok) ({ value: sprint } = await s.json());
    } catch {}
    return { project, sprint };
  }

  async function saveDefaults(project, sprint) {
    await Promise.all([
      fetch("/api/settings", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ key: "default_project", value: project })
      }),
      fetch("/api/settings", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ key: "default_sprint", value: sprint })
      })
    ]);
  }

  /* ------------------------------------------------------------------
   * Agent instructions helpers
   * ------------------------------------------------------------------ */
  async function loadInstructions() {
    const res = await fetch("/api/instructions");
    if (!res.ok) return "";
    const { instructions } = await res.json();
    return instructions;
  }

  async function saveInstructions(text) {
    await fetch("/api/instructions", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ instructions: text })
    });
  }

  /* ------------------------------------------------------------------
   * Git repo helpers
   * ------------------------------------------------------------------ */
  async function loadGitRepo() {
    const res = await fetch("/api/github");
    if (!res.ok) return "";
    const { owner, repo } = await res.json();
    return owner && repo ? `${owner}/${repo}` : "";
  }

  async function saveGitRepo(slug) {
    await fetch("/api/github", {
      method: "POST",
      headers:
              { "Content-Type": "application/json" },
      body: JSON.stringify({ slug })
    });
  }

  /* ------------------------------------------------------------------
   * Load & populate projects / sprints dropdown
   * ------------------------------------------------------------------ */
  async function loadProjects() {
    const res = await fetch("/api/projects");
    if (!res.ok) return;
    const projects = await res.json();
    const sel = $("#projectFilter");
    sel.innerHTML =
            '<option value="">All projects</option>' +
            projects
                    .map(
                            (p) =>
                                    `<option value="${p.project.replaceAll(
                                            '"',
                                            "&quot;"
                                    )}">${p.project}</option>`
                    )
                    .join("");
  }

  async function loadSprints() {
    const res = await fetch("/api/sprints");
    if (!res.ok) return;
    const sprints = await res.json();
    const sel = $("#sprintFilter");
    sel.innerHTML =
            '<option value="">All sprints</option>' +
            sprints
                    .map(
                            (p) =>
                                    `<option value="${p.sprint.replaceAll(
                                            '"',
                                            "&quot;"
                                    )}">${p.sprint}</option>`
                    )
                    .join(""\);
  }

  /* ------------------------------------------------------------------
   * Render table header & rows
   * ------------------------------------------------------------------ */
  function renderHeader() {
    const hdr = $("#headerRow");
    hdr.innerHTML = "";
    columns.forEach((c) => {
      if (!visibleCols.has(c.key)) return;
      const th = document.createElement("th");
      th.textContent = c.label;
      hdr.appendChild(th);
    });
  }

  async function loadTasks() {
    const includeHidden = $("#showHidden").checked;
    const res = await fetch(
            "/api/tasks" + (includeHidden ? "?includeHidden=1" : "")
    );
    const tasks = await res.json();

    /* filter by selected project/sprint */
    const selectedProject = $("#projectFilter").value;
    const selectedSprint = $("#sprintFilter").value;
    let displayTasks = tasks;
    if (selectedProject)
      displayTasks = displayTasks.filter((t) => t.project === selectedProject);
    if (selectedSprint)
      displayTasks = displayTasks.filter((t) => t.sprint === selectedSprint);

    renderHeader();
    const tbody = $("#tasks tbody");
    tbody.innerHTML = "";

    displayTasks.forEach((t, idx) => {
      const tr = document.createElement("tr");
      if (t.hidden) tr.classList.add("hidden");

      const cells = [];
      const push = (key, html) => {
        if (!visibleCols.has(key)) return;
        cells.push(html);
      };

      /* numeric order */
      push("order", `<td>${t.priority_number}</td>`);

      push(
              "reorder",
              `<td>
              <button class="arrow" title="Move up" ${
                      idx === 0 ? "disabled" : ""
              } onclick="reorder(${t.id}, 'up')">‚ñ≤</button>
              <button class="arrow" title="Move down" ${
                      idx === displayTasks.length - 1 ? "disabled" : ""
              } onclick="reorder(${t.id}, 'down')">‚ñº</button>
            </td>`
      );
      push(
              "visibility",
              `<td>
              <button class="eye" title="${
                      t.hidden ? "Unhide" : "Hide"
              }" onclick="toggleHidden(${t.id}, ${!t.hidden})">$ {
              t.hidden ? "üôà" : "üëÅÔ∏è"
            }</button>
            </td>`
      );

      /* textual priority */
      const priorityOpts = ["Low",
        "Medium",
        "High"
      ]
              .map(
                      (p) =>
                              `<option value="${p}" ${t.priority === p ? "selected" : ""}>${p}</option>`
              )
              .join("");
      push(
              "priority",
              `<td>
              <select onchange="setPriority(${t.id}, this.value)">
                ${priorityOpts}
              </select>
            </td>`
      );

      push(
              "slug",
              `<td><a href="${t.html_url}" target="_blank">${t.task_id_slug}</a></td>`
      );
      push("repo", `<td>${t.repository}</td>`);
      push(
              "number",
              `<td><a href="${t.html_url}" target="_blank">#${t.number}</a></td>`
      );
      push("title", `<td>${t.title}</td>`);
      push(
              "project",
              `<td class="project-cell" data-id="${t.id}" data-project="${encodeURIComponent(
                      t.project ?? ""
              )}">${t.project || "-"}</td>`
      );
      push(
              "sprint",
              `<td class="sprint-cell" data-id="${t.id}" data-sprint="${encodeURIComponent(
                      t.sprint ?? ""
              )}">${t.sprint || "-"}</td>`
      );
      push(
              "points",
              `<td>
              <span class="fib-display">${t.fib_points ?? "-"}</span>
              <div class="fib-buttons">
                ${[1, 2, 3, 5, 8]
                      .map(
                              (p) =>
                                      `<button class=\"fib-btn\" onclick=\"setPoints(${t.id}, ${p})\">${p}</button>`
                      )
                      .join(" ")}
              </div>
            </td>`
      );
      push("assignee", `<td>${t.assignee ?? "-"}</td>`);
      push(
              "created",
              `<td>${new Date(t.created_at).toLocaleString()}</td>`
      );

      tr.innerHTML = cells.join("");
      tbody.appendChild(tr);
    });
  }

  /* ------------------------------------------------------------------
   * Actions (existing)
   * ------------------------------------------------------------------ */
  async function reorder(id, direction) {
    await fetch("/api/tasks/reorder", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ id, direction })
    });
    await loadTasks();
  }

  async function toggleHidden(id, hidden) {
    await fetch("/api/tasks/hidden", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ id, hidden })
    });
    await loadTasks();
  }

  async function setPoints(id, points) {
    await fetch("/api/tasks/points", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ id, points })
    });
    await loadTasks();
  }

  /* ------------------------------------------------------------------
   * New priority action
   * ------------------------------------------------------------------ */
  async function setPriority(id, priority) {
    await fetch("/api/tasks/priority", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ id, priority })
    });
    await loadTasks();
  }

  /* ------------------------------------------------------------------
   * Add new task
   * ------------------------------------------------------------------ */
  $("#addTaskBtn").addEventListener("click", async () => {
    const title = prompt("New task title:");
    if (!title) return;
    const body = prompt("Optional description (leave blank if none):", "");
    await fetch("/api/tasks", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ title, body })
    });
    await loadTasks();
    await loadProjects();
    await loadSprints();
  });

  /* ------------------------------------------------------------------
   * Inline project / sprint editor
   * ------------------------------------------------------------------ */
  function startInline... (truncated for brevity)
</script>
</body>
</html>