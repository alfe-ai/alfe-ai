<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Task Queue</title>
  <style>
    /* chat panel */
    #chatPanel {
      margin-top: 2rem;
      max-width: 600px;
    }
    #chatMessages {
      margin-bottom: 0.5rem;
    }
    #waitingCounter {
      font-size: 0.9rem;
      color: #888;
      height: 1.2em;
      margin-bottom: 0.5rem;
    }

    /* sequence bubble + sub-bubbles */
    .chat-sequence {
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 8px;
      margin-bottom: 8px;
      background: #fefefe;
    }
    .chat-sequence .chat-user {
      background: #e6f7ff;
      padding: 6px 8px;
      border-radius: 4px;
      margin-bottom: 6px;
      color: #0066aa;
    }
    .chat-sequence .chat-bot {
      background: #f6ffed;
      padding: 6px 8px;
      border-radius: 4px;
      color: #009900;
    }

    /* remove old flat styles */
    .chat-user, .chat-bot { margin: 0; }
  </style>
</head>
<body>

<div id="controls">
  <label><input type="checkbox" id="showHidden" /> Show hidden tasks</label>

  <label style="margin-left:1rem;">Project:
    <select id="projectFilter"><option value="">All projects</option></select>
  </label>

  <label style="margin-left:1rem;">Sprint:
    <select id="sprintFilter"><option value="">All sprints</option></select>
  </label>

  <button id="addTaskBtn">‚ûï New Task</button>
  <button id="instrBtn" title="Agent instructions">üìù</button>
  <button id="gearBtn"  title="Configure columns">‚öôÔ∏è</button>
  <button id="defaultsBtn" title="Default project/sprint">‚≠ê</button>
  <button id="repoBtn" title="Edit Git repository">üîÄ</button>
</div>

<table id="tasks">
  <thead><tr id="headerRow"></tr></thead>
  <tbody></tbody>
</table>

<!-- Column picker modal -->
<div id="colModal" class="modal">
  <div class="modal-content">
    <h2>Columns</h2>
    <div id="colList"></div>
    <div class="modal-buttons">
      <button id="colSaveBtn">Save</button>
      <button id="colCancelBtn">Cancel</button>
    </div>
  </div>
</div>

<!-- Agent instructions modal -->
<div id="instrModal" class="modal">
  <div class="modal-content">
    <h2>Agent Instructions</h2>
    <textarea id="instrText" rows="10" style="width:100%;"></textarea>
    <div class="modal-buttons">
      <button id="instrSaveBtn">Save</button>
      <button id="instrCancelBtn">Cancel</button>
    </div>
  </div>
</div>

<!-- Git repo modal -->
<div id="repoModal" class="modal">
  <div class="modal-content">
    <h2>Edit Git repository</h2>
    <label>Repository (owner/repo):
      <input type="text" id="repoInput" style="width:100%;" />
    </label>
    <div class="modal-buttons">
      <button id="repoSaveBtn">Save</button>
      <button id="repoCancelBtn">Cancel</button>
    </div>
  </div>
</div>

<!-- Defaults modal -->
<div id="defaultsModal" class="modal">
  <div class="modal-content">
    <h2>Default project / sprint</h2>
    <label>Default project:
      <input type="text" id="defProjectInput" style="width:100%;" />
    </label>
    <label>Default sprint:
      <input type="text" id="defSprintInput" style="width:100%;" />
    </label>
    <div class="modal-buttons">
      <button id="defSaveBtn">Save</button>
      <button id="defCancelBtn">Cancel</button>
    </div>
  </div>
</div>

<!-- New Task modal -->
<div id="newTaskModal" class="modal">
  <div class="modal-content">
    <h2>Create New Task</h2>
    <label>Title:<br/>
      <input type="text" id="newTaskTitle" style="width:100%;" />
    </label>
    <label style="margin-top:8px;">Description:<br/>
      <textarea id="newTaskBody" rows="5" style="width:100%;"></textarea>
    </label>
    <div class="modal-buttons">
      <button id="createTaskBtn">Create</button>
      <button id="cancelTaskBtn">Cancel</button>
    </div>
  </div>
</div>

<!-- Chat panel -->
<div id="chatPanel">
  <div id="chatMessages"></div>
  <div id="waitingCounter"></div>
  <input type="text" id="chatInput" placeholder="Type your message..." />
  <button id="chatSendBtn">Send</button>
</div>

<script>
  /* ---------------- default column definitions ---------------- */
  let columnsOrder = [ /* ... same as before ... */ ];
  let visibleCols = new Set(columnsOrder.map(c=>c.key));
  let allTasks = [];
  let dragSrcRow = null;
  const $  = (sel, ctx=document) => ctx.querySelector(sel);
  const $$ = (sel, ctx=document) => [...ctx.querySelectorAll(sel)];
  const isoDate = d => new Date(d).toLocaleDateString();
  function showModal(m){ m.style.display="flex"; }
  function hideModal(m){ m.style.display="none"; }
  $$(".modal").forEach(m=>m.addEventListener("click",e=>{ if(e.target===m) hideModal(m); }));
  /* ------------------------------------------------------------------
   * Load & save settings, renderHeader, drag/drop, fetchTasks, renderBody,
   * loadTasks, populateFilters, column picker, row interactions,
   * basic controls, modal hooking for settings, new tasks...
   * (all code unchanged above)
   * ------------------------------------------------------------------ */

  /* ------------------------------------------------------------------
   * Chat logic with grouped bubbles
   * ------------------------------------------------------------------ */
  const chatMessagesEl = document.getElementById("chatMessages");
  const chatInputEl    = document.getElementById("chatInput");
  const chatSendBtnEl  = document.getElementById("chatSendBtn");

  chatSendBtnEl.addEventListener("click", async () => {
    const userMessage = chatInputEl.value.trim();
    if (!userMessage) return;

    // Sequence container
    const seqDiv = document.createElement("div");
    seqDiv.className = "chat-sequence";

    // User sub-bubble
    const userDiv = document.createElement("div");
    userDiv.className = "chat-user";
    userDiv.textContent = "You: " + userMessage;
    seqDiv.appendChild(userDiv);

    chatInputEl.value = "";

    // show waiting counter
    const waitingElem = document.getElementById("waitingCounter");
    let waitTime = 0;
    waitingElem.textContent = "Waiting: 0.0s";
    const waitInterval = setInterval(() => {
      waitTime += 0.1;
      waitingElem.textContent = `Waiting: ${waitTime.toFixed(1)}s`;
    }, 100);

    try {
      const resp = await fetch("/api/chat", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ message: userMessage })
      });
      clearInterval(waitInterval);
      waitingElem.textContent = "";

      // Bot sub-bubble
      const botDiv = document.createElement("div");
      botDiv.className = "chat-bot";

      if (!resp.ok) {
        botDiv.textContent = "AI: Error contacting AI.";
      } else {
        const data = await resp.json();
        botDiv.textContent = `AI (${data.model}): ${data.reply || ""}`;
      }

      seqDiv.appendChild(botDiv);
    } catch (e) {
      clearInterval(waitInterval);
      waitingElem.textContent = "";
      const botDiv = document.createElement("div");
      botDiv.className = "chat-bot";
      botDiv.textContent = "AI: Error occurred.";
      seqDiv.appendChild(botDiv);
    }

    chatMessagesEl.appendChild(seqDiv);
    chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight;
  });

  /* ------------------------------------------------------------------
   * Init sequence
   * ------------------------------------------------------------------ */
  (async function init(){
    await loadSettings();
    await populateFilters();
    await loadTasks();
  })();
</script>

</body>
</html>
