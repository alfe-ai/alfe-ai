<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Aurora: Open Tasks</title>
  <style>
    body { font-family: sans-serif; margin: 2rem; }
    h1   { margin-top: 0; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 8px; border: 1px solid #ddd; }
    th { background: #f0f0f0; text-align: left; }
    tr:nth-child(even) { background: #fafafa; }
    a { color: #0366d6; text-decoration: none; }
    button.arrow,
    button.eye,
    button.fib-btn,
    #addTaskBtn,#gearBtn,#instrBtn,#repoBtn,#defaultsBtn{
      border:none;background:none;cursor:pointer;font-size:1rem;line-height:1;padding:0 4px;
    }
    #addTaskBtn{margin-left:1rem;font-size:1.1rem;}
    #gearBtn,#instrBtn,#repoBtn,#defaultsBtn{margin-left:.6rem;font-size:1.2rem;}
    tr.hidden{opacity:.4;}
    .project-cell,.sprint-cell,.priority-cell,.status-cell,
    .dependencies-cell,.blocking-cell, .title-cell {
      cursor:pointer;color:#333;
    }
    .project-cell:hover,.sprint-cell:hover,.priority-cell:hover,.status-cell:hover,
    .dependencies-cell:hover,.blocking-cell:hover, .title-cell:hover {
      text-decoration:underline dotted;
    }
    .inline-input{width:100%;box-sizing:border-box;font:inherit;padding:4px;}
    #controls{margin-bottom:1rem;}

    /* ------------ modal ------------ */
    .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.25);align-items:center;justify-content:center;}
    .modal-content{background:#fff;padding:1rem 1.5rem;border-radius:6px;min-width:220px;max-width:600px;max-height:90vh;overflow:auto;}
    .modal-content h2{margin-top:0;}
    .modal-buttons{text-align:right;margin-top:8px;}
    textarea{font-family:monospace;}
    .col-item{display:flex;align-items:center;margin-bottom:6px;}
    .col-label{margin-left:6px;}
    .col-move{margin:0 4px;}

    /* drag handle styling */
    .drag-handle {
      cursor: move;
      user-select: none;
      font-size: 1.2rem;
    }
    tr.drag-over {
      outline: 2px dashed #888;
    }

    /* chat panel */
    #chatPanel {
      margin-top: 2rem;
      max-width: 600px;
    }
    #chatMessages {
      margin-bottom: 0.5rem;
    }
    #waitingCounter {
      font-size: 0.9rem;
      color: #888;
      height: 1.2em;
      margin-bottom: 0.5rem;
    }

    /* sequence bubble + sub-bubbles */
    .chat-sequence {
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 8px;
      margin-bottom: 8px;
      background: #fefefe;
    }
    .chat-sequence .chat-user {
      background: #e6f7ff;
      padding: 6px 8px;
      border-radius: 4px;
      margin-bottom: 6px;
      color: #0066aa;
    }
    .chat-sequence .chat-bot {
      background: #f6ffed;
      padding: 6px 8px;
      border-radius: 4px;
      color: #009900;
    }

    /* remove old flat styles */
    .chat-user, .chat-bot { margin: 0; }
  </style>
</head>
<body>
<h1>Aurora - Open Tasks</h1>

<p>
  <a href="/">üè† Home</a> ‚Ä¢
  <a href="/projects">üìÇ Projects overview</a> ‚Ä¢
  <a href="/sprints">üèÉ‚Äç‚ôÇÔ∏è Sprints overview</a> ‚Ä¢
  <a href="/test_projects">Test APIs page</a> ‚Ä¢
  <a href="/activity">üïí Activity Timeline</a>
</p>

<!-- ... rest of the page above chat panel unchanged ... -->

<!-- Chat panel -->
<div id="chatPanel">
  <h2>AI Chat</h2>
  <div id="chatMessages"></div>
  <div id="waitingCounter"></div>
  <div>
    <input type="text" id="chatInput" style="width:80%;" placeholder="Ask something..." />
    <button id="chatSendBtn">Send</button>
  </div>
</div>

<script>
  // ... all helper code above remains unchanged ...

  /* ------------------------------------------------------------------
   * Chat logic with grouped bubbles
   * ------------------------------------------------------------------ */
  const chatMessages = document.getElementById("chatMessages");
  const chatInput    = document.getElementById("chatInput");
  const chatSendBtn  = document.getElementById("chatSendBtn");

  chatSendBtn.addEventListener("click", async () => {
    const userMessage = chatInput.value.trim();
    if (!userMessage) return;

    // Sequence container
    const seqDiv = document.createElement("div");
    seqDiv.className = "chat-sequence";

    // User sub-bubble
    const userDiv = document.createElement("div");
    userDiv.className = "chat-user";
    userDiv.textContent = "You: " + userMessage;
    seqDiv.appendChild(userDiv);

    chatInput.value = "";

    // show waiting counter
    const waitingElem = document.getElementById("waitingCounter");
    let waitTime = 0;
    waitingElem.textContent = "Waiting: 0.0s";
    const waitInterval = setInterval(() => {
      waitTime += 0.1;
      waitingElem.textContent = `Waiting: ${waitTime.toFixed(1)}s`;
    }, 100);

    try {
      const resp = await fetch("/api/chat", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ message: userMessage })
      });
      clearInterval(waitInterval);
      waitingElem.textContent = "";

      const botDiv = document.createElement("div");
      botDiv.className = "chat-bot";

      if (!resp.ok) {
        botDiv.textContent = "AI: Error contacting AI.";
      } else {
        const data = await resp.json();
        botDiv.textContent = `AI (${data.model}): ${data.reply || ""}`;
      }

      seqDiv.appendChild(botDiv);
    } catch (e) {
      clearInterval(waitInterval);
      waitingElem.textContent = "";
      const botDiv = document.createElement("div");
      botDiv.className = "chat-bot";
      botDiv.textContent = "AI: Error occurred.";
      seqDiv.appendChild(botDiv);
    }

    chatMessages.appendChild(seqDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
  });

  /* ------------------------------------------------------------------
   * Init sequence
   * ------------------------------------------------------------------ */
  (async function init(){
    // ... load settings, filters, tasks ...
  })();
</script>
</body>
</html>
 // 