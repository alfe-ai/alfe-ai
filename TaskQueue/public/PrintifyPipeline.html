<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Printify Pipeline</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body style="padding:1rem;">
  <h2>PrintifyPipeline</h2>
  <ul id="stageList"></ul>
  <div id="fileContainer"></div>
  <button id="upscaleButton">Submit to Upscale</button>
  <pre id="upscaleTerminal" style="background:#000;color:#0f0;padding:0.5rem;margin-top:0.5rem;height:200px;overflow:auto;font-family:monospace;"></pre>
  <script>
    const params = new URLSearchParams(window.location.search);
    const file = params.get('file');
    const stageParam = parseInt(params.get('stage'));
    const stages = [
      { name: 'Generated (Initial Stage)' },
      { name: 'Upscaled' },
      { name: 'Background Removed' },
      { name: 'Border Added', disabled: true },
      { name: 'Printify Image Uploaded' },
      { name: 'Printify 2' },
      { name: 'Printify 3' },
      { name: 'Ebay Shipping Updated' },
      { name: 'Done' }
    ];

    const stageList = document.getElementById('stageList');
    const currentStage = isNaN(stageParam) ? 0 : Math.min(Math.max(stageParam, 0), stages.length - 1);
    stages.forEach((stage, idx) => {
      const li = document.createElement('li');
      li.textContent = stage.name;
      if (stage.disabled) li.classList.add('disabled');
      if (idx === currentStage) li.classList.add('current');
      stageList.appendChild(li);
    });

    const container = document.getElementById('fileContainer');
    if (file) {
      const ext = file.split('.').pop().toLowerCase();
      if (["png","jpg","jpeg","gif","webp","svg"].includes(ext)) {
        const img = document.createElement('img');
        img.src = `/uploads/${file}`;
        img.style.maxWidth = '100%';
        container.appendChild(img);
      } else {
        const link = document.createElement('a');
        link.href = `/uploads/${file}`;
        link.textContent = file;
        link.target = '_blank';
        container.appendChild(link);
      }
    } else {
      container.textContent = 'No file specified.';
    }

    const upscaleBtn = document.getElementById('upscaleButton');
    const terminalEl = document.getElementById('upscaleTerminal');
    if (file) {
      upscaleBtn.addEventListener('click', async () => {
        terminalEl.textContent = '';
        try {
          const res = await fetch('/api/upscale', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ file })
          });
          if (res.ok && res.body) {
            const reader = res.body.getReader();
            const decoder = new TextDecoder();
            while (true) {
              const { value, done } = await reader.read();
              if (done) break;
              terminalEl.textContent += decoder.decode(value);
              terminalEl.scrollTop = terminalEl.scrollHeight;
            }
          } else {
            const data = await res.json().catch(() => ({}));
            terminalEl.textContent = data.error || 'Upscale request failed.';
          }
        } catch (err) {
          terminalEl.textContent = 'Upscale request failed.';
        }
      });
    } else {
      upscaleBtn.disabled = true;
    }
  </script>
</body>
</html>
