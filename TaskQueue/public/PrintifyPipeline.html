<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Printify Pipeline</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body style="padding:1rem;">
  <h2>PrintifyPipeline</h2>
  <ul id="stageList"></ul>
  <div id="imageTabs" style="display:flex;gap:0.5rem;margin-bottom:0.5rem;">
    <button id="tabOriginal" class="view-tab active">Original</button>
    <button id="tabUpscaled" class="view-tab" style="display:none;">4096x4096</button>
  </div>
  <div id="fileContainer"></div>
  <div id="resolutionDisplay" style="margin-top:0.5rem;"></div>
  <h3>Jobs for this Image</h3>
  <table id="jobsTable" style="width:100%;border-collapse:collapse;">
    <thead>
      <tr>
        <th>Job ID</th>
        <th>Status</th>
        <th>4096 Path</th>
      </tr>
    </thead>
    <tbody id="jobsList"></tbody>
  </table>
  <h3>JobRunner Nodes</h3>
  <div id="nodesContainer" style="margin-bottom:0.5rem;">
    <ul id="nodesList"></ul>
    <input id="nodeHost" placeholder="host" style="width:140px;" />
    <input id="nodePort" placeholder="port" style="width:60px;" />
    <button id="addNodeBtn">Add Node</button>
  </div>
  <div style="margin-top:0.5rem;">
    <button id="upscaleButton">Submit to Upscale</button>
    <button id="printifyButton">Submit to Printify</button>
  </div>
  <pre id="upscaleTerminal" style="background:#000;color:#0f0;padding:0.5rem;margin-top:0.5rem;height:200px;overflow:auto;font-family:monospace;"></pre>
  <script>
    const params = new URLSearchParams(window.location.search);
    const file = params.get('file');
    const stageParam = parseInt(params.get('stage'));
    const stages = [
      { name: 'Generated' },
      { name: 'Border Added', disabled: true },
      { name: 'Upscaled' },
      { name: 'Printify Image Uploaded' },
      { name: 'Printify 2' },
      { name: 'Printify 3' },
      { name: 'Ebay Shipping Updated' },
      { name: 'Done' }
    ];

    const stageList = document.getElementById('stageList');
    const stageItems = [];
    const currentStage = isNaN(stageParam) ? null : Math.min(Math.max(stageParam, 0), stages.length - 1);
    stages.forEach((stage, idx) => {
      const li = document.createElement('li');
      li.textContent = stage.name;
      if (stage.disabled) li.classList.add('disabled');
      if (idx === 0) li.classList.add('completed');
      if (currentStage !== null && idx === currentStage && idx !== 0) li.classList.add('current');
      stageList.appendChild(li);
      stageItems.push(li);
    });

    const container = document.getElementById('fileContainer');
    const resEl = document.getElementById('resolutionDisplay');
    const origImg = document.createElement('img');
    const upscaledImg = document.createElement('img');
    origImg.style.maxWidth = '100%';
    upscaledImg.style.maxWidth = '100%';
    upscaledImg.style.display = 'none';
    container.appendChild(origImg);
    container.appendChild(upscaledImg);

    if (file) {
      const ext = file.split('.').pop().toLowerCase();
      if (["png","jpg","jpeg","gif","webp","svg"].includes(ext)) {
        origImg.src = `/uploads/${file}`;
        origImg.addEventListener('load', () => {
          resEl.textContent = `Resolution: ${origImg.naturalWidth} x ${origImg.naturalHeight}`;
        });
      } else {
        const link = document.createElement('a');
        link.href = `/uploads/${file}`;
        link.textContent = file;
        link.target = '_blank';
        container.appendChild(link);
      }
    } else {
      container.textContent = 'No file specified.';
    }

    function showOriginal() {
      origImg.style.display = '';
      upscaledImg.style.display = 'none';
      document.getElementById('tabOriginal').classList.add('active');
      document.getElementById('tabUpscaled').classList.remove('active');
    }

    function showUpscaled() {
      origImg.style.display = 'none';
      upscaledImg.style.display = '';
      document.getElementById('tabOriginal').classList.remove('active');
      document.getElementById('tabUpscaled').classList.add('active');
    }

    let upscaledFile = null;
    async function checkUpscaled(){
      if(!file) return;
      try {
        const res = await fetch(`/api/upscale/result?file=${encodeURIComponent(file)}`);
        const data = await res.json();
        if(data.url){
          if(upscaledImg.src !== data.url){
            upscaledImg.src = `${data.url}?t=${Date.now()}`;
            upscaledImg.addEventListener('load', () => {
              resEl.textContent = `Resolution: ${upscaledImg.naturalWidth} x ${upscaledImg.naturalHeight}`;
            }, { once: true });
          }
          upscaledFile = data.url.split(/[/\\]/).pop();
          document.getElementById('tabUpscaled').style.display = '';
          if(stageItems[2]) stageItems[2].classList.add('completed');
          showUpscaled();
        }
      } catch(err){
        console.error('Failed to check upscaled image =>', err);
      }
    }

    document.getElementById('tabOriginal').addEventListener('click', showOriginal);
    document.getElementById('tabUpscaled').addEventListener('click', showUpscaled);
    showOriginal();

    const upscaleBtn = document.getElementById('upscaleButton');
    const printifyBtn = document.getElementById('printifyButton');
    const terminalEl = document.getElementById('upscaleTerminal');
    const jobsListEl = document.getElementById('jobsList');
    const nodesListEl = document.getElementById('nodesList');
    const hostInput = document.getElementById('nodeHost');
    const portInput = document.getElementById('nodePort');
    let nodes = [];

    async function loadNodes(){
      try {
        const r = await fetch('/api/jobrunner/nodes');
        nodes = await r.json();
        renderNodes();
      } catch(e){ console.error('Failed to load nodes', e); }
    }

    async function addNode(){
      const host = hostInput.value.trim();
      const port = portInput.value.trim();
      if(!host || !port) return;
      await fetch('/api/jobrunner/nodes', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({host, port})
      });
      hostInput.value='';
      portInput.value='';
      loadNodes();
    }

    function renderNodes(){
      nodesListEl.innerHTML='';
      nodes.forEach(n=>{
        const li=document.createElement('li');
        li.textContent=`${n.host}:${n.port}`;
        const del=document.createElement('button');
        del.textContent='Delete';
        del.style.marginLeft='0.5rem';
        del.addEventListener('click', async()=>{
          await fetch(`/api/jobrunner/nodes/${n.id}`,{method:'DELETE'});
          loadNodes();
        });
        li.appendChild(del);
        nodesListEl.appendChild(li);
      });
    }

    document.getElementById('addNodeBtn').addEventListener('click', addNode);
    loadNodes();
    console.debug('Loaded PrintifyPipeline for file =>', file);
    if (file) {
      upscaleBtn.addEventListener('click', async () => {
        console.debug('Submit to Upscale clicked with file =>', file);
        terminalEl.textContent = '';
        try {
          console.debug('Sending POST /api/upscale');
          const res = await fetch('/api/upscale', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ file })
          });
          console.debug('Received response =>', res.status);
          const data = await res.json().catch(() => ({}));
          if (res.ok && data.jobId) {
            window.open(`jobs.html?jobId=${data.jobId}`, '_blank');
            terminalEl.textContent = `Job started with ID ${data.jobId}. Open the Jobs List to view progress.`;
          } else {
            terminalEl.textContent = data.error || 'Upscale request failed.';
            console.debug('Upscale failed =>', terminalEl.textContent);
          }
        } catch (err) {
          console.error('Upscale request error =>', err);
          terminalEl.textContent = 'Upscale request failed.';
        }
      });
      printifyBtn.addEventListener('click', async () => {
        console.debug('Submit to Printify clicked with file =>', upscaledFile);
        terminalEl.textContent = '';
        if(!upscaledFile){
          terminalEl.textContent = 'Upscaled 4096 image not available.';
          console.debug('Printify aborted => upscaled image missing');
          return;
        }
        try {
          console.debug('Sending POST /api/printify');
          const res = await fetch('/api/printify', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ file: upscaledFile })
          });
          console.debug('Received response =>', res.status);
          const data = await res.json().catch(() => ({}));
          if (res.ok && data.jobId) {
            window.open(`jobs.html?jobId=${data.jobId}`, '_blank');
            terminalEl.textContent = `Job started with ID ${data.jobId}. Open the Jobs List to view progress.`;
          } else {
            terminalEl.textContent = data.error || 'Printify request failed.';
            console.debug('Printify failed =>', terminalEl.textContent);
          }
        } catch (err) {
          console.error('Printify request error =>', err);
          terminalEl.textContent = 'Printify request failed.';
        }
      });
      async function loadJobs(){
        try {
          const res = await fetch('/api/jobs');
          const jobs = await res.json();
          const filtered = jobs.filter(j => j.file === file);
          jobsListEl.innerHTML = '';
          for(const j of filtered){
            const tr = document.createElement('tr');
            tr.style.cursor = 'pointer';
            tr.addEventListener('click', () => window.open(`jobs.html?jobId=${j.id}`, '_blank'));

            const tdId = document.createElement('td');
            tdId.textContent = j.id;
            const tdStatus = document.createElement('td');
            tdStatus.textContent = j.status;
            const tdPath = document.createElement('td');
            if(j.status === 'finished'){
              if(j.resultPath){
                tdPath.textContent = j.resultPath;
              } else {
                try{
                  const r = await fetch(`/api/upscale/result?file=${encodeURIComponent(j.file)}`);
                  const d = await r.json();
                  tdPath.textContent = d.url || '';
                }catch(e){
                  tdPath.textContent = '';
                }
              }
            } else {
              tdPath.textContent = '';
            }

            tr.appendChild(tdId);
            tr.appendChild(tdStatus);
            tr.appendChild(tdPath);
            jobsListEl.appendChild(tr);
          }
        } catch(err){
          console.error('Failed to load jobs =>', err);
        }
      }
      loadJobs();
      setInterval(loadJobs, 5000);
      checkUpscaled();
      setInterval(checkUpscaled, 5000);
    } else {
      upscaleBtn.disabled = true;
      printifyBtn.disabled = true;
      console.debug('No file parameter found => Upscale disabled');
    }
  </script>
</body>
</html>
