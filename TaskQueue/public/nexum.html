<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Nexum Chat</title>
  <style>
    body {
      background:#1e1e1e;
      color:#ddd;
      font-family:sans-serif;
      margin:0;
    }
    .app {
      display:flex;
      height:100vh;
      overflow:hidden;
    }
    #sidebar {
      width:200px;
      background:#2d2d2d;
      padding:1rem;
      overflow-y:auto;
      border-right:1px solid #444;
    }
    #tabsList button {
      display:block;
      width:100%;
      background:#333;
      border:1px solid #444;
      color:#ddd;
      padding:4px 6px;
      margin-bottom:4px;
      text-align:left;
      cursor:pointer;
    }
    #tabsList button.active {
      background:#555;
      border-color:#aaa;
      color:#fff;
    }
    main {
      flex:1;
      padding:1rem;
      display:flex;
      flex-direction:column;
      overflow:hidden;
    }
    #chat {
      flex:1;
      max-width:800px;
      margin:0 auto 1rem auto;
      display:flex;
      flex-direction:column;
      gap:0.5rem;
      overflow-y:auto;
    }
    #suggestions {
      max-width:800px;
      margin:0 auto 1rem auto;
      display:grid;
      grid-template-columns:repeat(2,1fr);
      gap:0.5rem;
    }
    #suggestions button {
      background:#333;
      color:#ddd;
      border:1px solid #444;
      padding:6px 8px;
      text-align:left;
      cursor:pointer;
    }
    .msg {
      border:1px solid #444;
      padding:8px;
      border-radius:6px;
      white-space:pre-wrap;
    }
    .user { background:#3b3b3b; align-self:flex-end; }
    .ai   { background:#2a2a2a; align-self:flex-start; }
    #inputArea {
      max-width:800px;
      margin:0 auto;
      display:flex;
      gap:0.5rem;
    }
    #prompt {
      flex:1;
      background:#2a2a2a;
      color:#ddd;
      border:1px solid #444;
      padding:8px;
      font-family:monospace;
      resize:vertical;
    }
    button {
      padding:8px 12px;
    }

    /* View tabs above chat panel */
    .view-tab {
      background:#333;
      color:#ddd;
      border:1px solid #444;
      padding:4px 8px;
      cursor:pointer;
    }

    .view-tab.active {
      background:#555;
      border-color:#aaa;
      color:#fff;
    }
  </style>
</head>
<body>
  <div class="app">
    <aside id="sidebar">
      <h2>Chat Tabs</h2>
      <div id="tabsList"></div>
      <button id="newTabBtn">New Tab</button>
    </aside>
    <main>
      <div id="viewTabsBar" style="display:flex;gap:0.5rem;margin-bottom:0.5rem;">
        <button id="viewTabChat" class="view-tab active">Chat</button>
        <button id="viewTabTasks" class="view-tab">Tasks</button>
        <button id="viewTabArchive" class="view-tab">Archive</button>
      </div>
      <h1>Nexum Chat</h1>
      <div id="modelInfo" style="margin-bottom:0.5rem; color:#aaa;"></div>
      <div id="taskListPanel" style="display:none;border:1px dashed #666; padding:8px; margin:8px 0;">
        <h2 style="margin:0;font-size:1.1rem;">Task List</h2>
        <div id="markdownContainer" style="margin-top:8px;border:1px solid #444; padding:8px;">
          <label for="markdownInput" style="font-weight:bold;">Markdown Contents:</label>
          <textarea id="markdownInput" style="width:100%; height:150px; background:#2b2b2b; color:#ddd;"></textarea>
          <div style="margin-top:8px;">
            <button id="saveMdBtn">Save</button>
          </div>
        </div>
      </div>
      <div id="suggestions"></div>
      <div id="chat"></div>
      <div id="inputArea">
        <textarea id="prompt" rows="3" placeholder="Enter your message"></textarea>
        <button id="sendBtn">Send</button>
      </div>
    </main>
  </div>
  <script>
    let tabs = [];
    let currentTabId = 1;
    let currentView = 'chat';
    const suggestions = [
      'Code a Pong Clone in JavaScript',
      'Create a basic to-do list in Python',
      'Explain how recursion works',
      'Design a responsive navbar'
    ];
    const urlParams = new URLSearchParams(location.search);
    const startTab = parseInt(urlParams.get('tabId'), 10);
    if(!Number.isNaN(startTab)) currentTabId = startTab;

    function updateView(view){
      currentView = view;
      document.getElementById('viewTabChat').classList.toggle('active', view === 'chat');
      document.getElementById('viewTabTasks').classList.toggle('active', view === 'tasks');
      document.getElementById('viewTabArchive').classList.toggle('active', view === 'archive');
      const showTasks = view !== 'chat';
      document.getElementById('taskListPanel').style.display = showTasks ? '' : 'none';
    }

    async function loadModelInfo(){
      try{
        const res = await fetch('/api/model');
        if(!res.ok) return;
        const data = await res.json();
        document.getElementById('modelInfo').textContent = 'Model: ' + (data.model || 'unknown');
      }catch(e){console.error(e);}
    }

    async function loadTabs(){
      try{
        const res = await fetch('/api/chat/tabs?nexum=1');
        if(res.ok){
          tabs = await res.json();
        } else {
          tabs = [{id:1,name:'Tab 1'}];
        }
      }catch(e){ tabs = [{id:1,name:'Tab 1'}]; console.error(e); }
    }

    function renderTabs(){
      const container = document.getElementById('tabsList');
      container.innerHTML = '';
      tabs.forEach(t => {
        const b = document.createElement('button');
        b.textContent = t.name;
        if(t.id === currentTabId) b.classList.add('active');
        b.addEventListener('click', () => { currentTabId = t.id; loadHistory(); renderTabs(); });
        b.addEventListener('contextmenu', e => { e.preventDefault(); renameTab(t.id); });
        container.appendChild(b);
      });
    }

    function renderSuggestions(){
      const container = document.getElementById('suggestions');
      if(!container) return;
      container.innerHTML = '';
      suggestions.forEach(text => {
        const b = document.createElement('button');
        b.textContent = text;
        b.addEventListener('click', () => {
          document.getElementById('prompt').value = text;
          document.getElementById('prompt').focus();
        });
        container.appendChild(b);
      });
    }

    async function loadHistory(){
      try{
        const res = await fetch(`/api/chat/history?tabId=${currentTabId}&limit=20&offset=0`);
        if(!res.ok) return;
        const data = await res.json();
        const chatDiv = document.getElementById('chat');
        chatDiv.innerHTML = '';
        (data.pairs || []).reverse().forEach(p => {
          addMsg('user', p.user_text);
          if(p.ai_text) addMsg('ai', p.ai_text);
        });
        chatDiv.scrollTop = chatDiv.scrollHeight;
      }catch(e){console.error(e);}
    }
    function addMsg(role,text){
      const el=document.createElement('div');
      el.className='msg '+(role==='user'?'user':'ai');
      el.textContent=text;
      document.getElementById('chat').appendChild(el);
    }
    async function newTab(){
      const name = prompt('Tab name:','New Tab');
      if(!name) return;
      const r = await fetch('/api/chat/tabs/new',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name, nexum:1})});
      if(r.ok){
        await loadTabs();
        if(tabs.length>0){
          currentTabId = tabs[tabs.length-1].id;
        }
        renderTabs();

        loadHistory();
      }
    }
    async function renameTab(tabId){
      const t = tabs.find(tt => tt.id === tabId);
      const newName = prompt("New name:", t ? t.name : "");
      if(!newName) return;
      try{
        const r = await fetch("/api/chat/tabs/rename",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({tabId,newName})});
        if(r.ok){
          await loadTabs();
          renderTabs();
        }
      }catch(e){console.error(e);}
    }


    async function send(){
      const promptEl=document.getElementById('prompt');
      const text=promptEl.value.trim();
      if(!text) return;
      addMsg('user',text);
      promptEl.value='';
      const aiEl=document.createElement('div');
      aiEl.className='msg ai';
      aiEl.textContent='...';
      document.getElementById('chat').appendChild(aiEl);
      document.getElementById('chat').scrollTop=document.getElementById('chat').scrollHeight;
      try{
        const resp=await fetch('/api/chat',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({message:text,tabId:currentTabId})});
        if(!resp.ok||!resp.body){aiEl.textContent='[error]';return;}
        const reader=resp.body.getReader();
        const dec=new TextDecoder();
        let done=false;let result='';
        while(!done){
          const {value,done:doneR}=await reader.read();
          done=doneR;
          if(value){result+=dec.decode(value);aiEl.textContent=result;document.getElementById('chat').scrollTop=document.getElementById('chat').scrollHeight;}
        }
      }catch(e){aiEl.textContent='[error]';console.error(e);}
    }
    document.getElementById('sendBtn').addEventListener('click',send);
    document.getElementById('prompt').addEventListener('keydown',e=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();send();}});
    document.getElementById('newTabBtn').addEventListener('click', newTab);
    document.getElementById('viewTabChat').addEventListener('click', () => updateView('chat'));
    document.getElementById('viewTabTasks').addEventListener('click', () => updateView('tasks'));
    document.getElementById('viewTabArchive').addEventListener('click', () => updateView('archive'));

    async function init(){
      loadModelInfo();
      await loadTabs();
      if(tabs.length>0){
        if(!Number.isNaN(startTab) && tabs.some(t=>t.id===startTab)){
          currentTabId = startTab;
        }else{
          currentTabId = tabs[0].id;
        }
      }
      renderTabs();
      renderSuggestions();
      loadHistory();
      updateView('chat');
    }
    init();
  </script>
</body>
</html>
