<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Alfe AI</title>
  <link id="themeStylesheet" rel="stylesheet" href="nexum.css" />
</head>
<body>
  <div class="app">
    <img id="sidebarToggle" class="sidebar-toggle-icon" src="alfe_favicon_clean_64x64.ico" alt="Toggle sidebar" title="Toggle sidebar"/>
    <aside id="sidebar">
      <div id="tabsList" style="position:relative; top: 40px;"></div>
      <button id="newTabBtn" style="position:relative; top: 40px;">New Tab</button>
    </aside>
    <main>
      <div id="viewTabsBar" style="display:flex;gap:0.5rem;margin-bottom:0.5rem;align-items:center;">
        <button id="viewTabChat" class="view-tab active" style="position:relative; left: 40px;">Chat</button>
        <button id="viewTabTasks" class="view-tab" style="position:relative; left: 40px;">Tasks</button>
        <button id="viewTabArchive" class="view-tab" style="position:relative; left: 40px;" hidden>Archive</button>
        <button id="settingsBtn" title="Settings" style="margin-left:auto;background:none;border:none;color:#ddd;font-size:1.2rem;cursor:pointer;">&#9881;</button>
      </div>
<!--      <h1>Nexum Chat</h1>-->
      <div id="modelInfo" style="margin-bottom:0.5rem; color:#aaa;"></div>
      <div id="chatPanel">
        <div id="suggestions"></div>
        <div id="chat"></div>
        <div id="inputArea">
          <textarea id="prompt" rows="12" placeholder="Enter your message" style="width:400px;"></textarea>
          <button id="sendBtn"><span id="sendBtnText">Send</span></button>
          <div id="taskBtns">
            <button id="askBtn" style="display:none;">Ask</button>
            <button id="codeBtn" style="display:none;">Code</button>
          </div>
        </div>
      </div>
      <div id="taskListPanel" style="display:none;">
        <h2 style="margin:0;font-size:1.1rem;">Tasks</h2>
        <table id="tasks">
          <thead><tr id="headerRow"></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </main>
  </div>
  <div id="settingsModal">
    <div class="modal-content">
      <h3>Nexum Settings</h3>
      <div>
        <h4>Nexum Feature Flags</h4>
        <label><input type="checkbox" id="flagHideChat"> Hide Chat Tab</label>
      </div>
      <div style="margin-top:0.5rem;">
        <label>Color:
          <select id="themeColorSelect">
            <option value="purple">Purple</option>
            <option value="lightblue">Light Blue</option>
            <option value="red">Red</option>
            <option value="green">Green</option>
            <option value="orange">Orange</option>
            <option value="teal">Teal</option>
            <option value="pink">Pink</option>
          </select>
        </label>
        <label style="margin-left:0.5rem;">Mode:
          <select id="themeModeSelect">
            <option value="dark">Dark</option>
            <option value="light">Light</option>
          </select>
        </label>
      </div>
      <button id="closeSettingsBtn" style="margin-top:1rem;">Close</button>
    </div>
  </div>
  <div id="tabConfigModal">
    <div class="modal-content">
      <h3>Tab Configuration</h3>
      <label>Project Name:<br/>
        <input type="text" id="tabProjectInput" style="width:100%;" />
      </label>
      <label style="margin-top:8px;">Git Repo SSH URL:<br/>
        <input type="text" id="tabRepoInput" style="width:100%;" />
      </label>
      <div style="margin-top:1rem;text-align:right;">
        <button id="tabConfigSaveBtn">Save</button>
        <button id="tabConfigCancelBtn">Cancel</button>
      </div>
    </div>
  </div>
  <script>
    let tabs = [];
    let currentTabId = 1;
    let currentView = 'chat';
    let currentTasks = [];
    let taskSortColumn = 'priority';
    let taskSortAsc = true;
    const taskColumns = [
      {key:'priority', label:'Prio'},
      {key:'status', label:'Status'},
      {key:'number', label:'#'},
      {key:'title', label:'Title'},
      {key:'dependencies', label:'Depends On'},
      {key:'project', label:'Project'},
      {key:'created', label:'Created'}
    ];
    const suggestions = [
      'Code a Pong Clone in JavaScript',
      'Create a basic to-do list in Python',
      'Explain how recursion works',
      'Design a responsive navbar'
    ];

    let currentColor = 'purple';
    let currentMode = 'dark';

    async function loadTheme(){
      try{
        const resColor = await fetch('/api/settings/nexum_theme_color');
        const resMode = await fetch('/api/settings/nexum_theme_mode');
        if(resColor.ok){
          const data = await resColor.json();
          currentColor = data.value || 'purple';
        } else { currentColor = 'purple'; }
        if(resMode.ok){
          const data = await resMode.json();
          currentMode = data.value || 'dark';
        } else { currentMode = 'dark'; }
        const selColor = document.getElementById('themeColorSelect');
        if(selColor) selColor.value = currentColor;
        const selMode = document.getElementById('themeModeSelect');
        if(selMode) selMode.value = currentMode;
        applyTheme(currentColor, currentMode);
      }catch(e){ applyTheme('purple','dark'); console.error(e); }
    }

    function applyTheme(color, mode){
      const link = document.getElementById('themeStylesheet');
      if(!link) return;
      const files = {
        purple: {dark:'nexum.css', light:'nexum_purple_light.css'},
        lightblue: {dark:'nexum_lightblue.css', light:'nexum_lightblue_light.css'},
        red: {dark:'nexum_red.css', light:'nexum_red_light.css'},
        green: {dark:'nexum_green.css', light:'nexum_green_light.css'},
        orange: {dark:'nexum_orange.css', light:'nexum_orange_light.css'},
        teal: {dark:'nexum_teal.css', light:'nexum_teal_light.css'},
        pink: {dark:'nexum_pink.css', light:'nexum_pink_light.css'}
      };
      link.href = files[color]?.[mode] || 'nexum.css';
    }
    const urlParams = new URLSearchParams(location.search);
    const startTab = parseInt(urlParams.get('tabId'), 10);
    if(!Number.isNaN(startTab)) currentTabId = startTab;


    async function loadModelInfo(){
      try{
        const res = await fetch('/api/model');
        if(!res.ok) return;
        const data = await res.json();
        document.getElementById('modelInfo').textContent = 'Model: ' + (data.model || 'unknown');
      }catch(e){console.error(e);}
    }

    async function loadTabs(){
      try{
        const res = await fetch('/api/chat/tabs?nexum=1');
        if(res.ok){
          tabs = await res.json();
        } else {
          tabs = [{id:1,name:'Tab 1'}];
        }
      }catch(e){ tabs = [{id:1,name:'Tab 1'}]; console.error(e); }
    }

    function renderTabs(){
      const container = document.getElementById('tabsList');
      container.innerHTML = '';
      tabs.forEach(t => {
        const item = document.createElement('div');
        item.className = 'tab-item';

        const b = document.createElement('button');
        b.textContent = t.name;
        if(t.id === currentTabId) b.classList.add('active');
        b.addEventListener('click', () => {
          currentTabId = t.id;
          if(currentView === 'chat') loadHistory();
          if(currentView === 'tasks') loadTasksForCurrentProject();
          renderTabs();
        });
        b.addEventListener('contextmenu', e => {
          e.preventDefault();
          const choice = prompt("Type 'rename' or 'delete':", "");
          if(choice === 'rename') renameTab(t.id);
          else if(choice === 'delete') deleteTab(t.id);
        });

        const gear = document.createElement('button');
        gear.innerHTML = '&#9881;';
        gear.className = 'config-btn';
        gear.addEventListener('click', (e) => { e.stopPropagation(); openTabConfig(t.id); });

        item.appendChild(b);
        item.appendChild(gear);
        container.appendChild(item);
      });
    }

    function isoDate(d){
      return new Date(d).toLocaleDateString([], {year:'2-digit',month:'2-digit',day:'2-digit'});
    }

    function sortTasks(){
      currentTasks.sort((a,b)=>{
        let va = a[taskSortColumn];
        let vb = b[taskSortColumn];
        if(taskSortColumn === 'created'){
          va = new Date(a.created_at);
          vb = new Date(b.created_at);
        }
        if(typeof va === 'string') va = va.toLowerCase();
        if(typeof vb === 'string') vb = vb.toLowerCase();
        if(va < vb) return taskSortAsc ? -1 : 1;
        if(va > vb) return taskSortAsc ? 1 : -1;
        return 0;
      });
    }

    function renderTaskHeader(){
      const tr = document.getElementById('headerRow');
      if(!tr) return;
      tr.innerHTML = '';
      taskColumns.forEach(col => {
        const th = document.createElement('th');
        th.textContent = col.label;
        th.dataset.key = col.key;
        th.style.cursor = 'pointer';
        if(taskSortColumn === col.key) th.textContent += taskSortAsc ? ' \u25B2' : ' \u25BC';
        th.addEventListener('click', () => {
          if(taskSortColumn === col.key){
            taskSortAsc = !taskSortAsc;
          } else {
            taskSortColumn = col.key;
            taskSortAsc = true;
          }
          sortTasks();
          renderTaskHeader();
          renderTasks(currentTasks);
        });
        tr.appendChild(th);
      });
    }

    function renderTasks(tasks){
      const tbody = document.querySelector('#tasks tbody');
      if(!tbody) return;
      tbody.innerHTML = '';
      tasks.forEach(t => {
        const tr = document.createElement('tr');
        taskColumns.forEach(col => {
          const td = document.createElement('td');
          switch(col.key){
            case 'number':
              td.innerHTML = `<a href="${t.html_url}" target="_blank">#${t.number}</a>`;
              break;
            case 'created':
              td.textContent = isoDate(t.created_at);
              break;
            default:
              td.textContent = t[col.key] || '';
          }
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });
    }

    async function loadTasksForCurrentProject(){
      const t = tabs.find(tt => tt.id === currentTabId);
      if(!t || !t.project_name){
        currentTasks = [];
        renderTasks([]);
        return;
      }
      try{
        const res = await fetch('/api/projects/' + encodeURIComponent(t.project_name));
        if(res.ok){
          currentTasks = await res.json();
          sortTasks();
          renderTaskHeader();
          renderTasks(currentTasks);
        }else{
          currentTasks = [];
          renderTasks([]);
        }
      }catch(e){
        console.error(e);
        currentTasks = [];
        renderTasks([]);
      }
    }

    function renderSuggestions(show = true){
      const container = document.getElementById('suggestions');
      if(!container) return;
      container.innerHTML = '';
      container.style.display = show ? 'grid' : 'none';
      if(!show) return;
      suggestions.forEach(text => {
        const b = document.createElement('button');
        b.textContent = text;
        b.addEventListener('click', () => {
          document.getElementById('prompt').value = text;
          document.getElementById('prompt').focus();
        });
        container.appendChild(b);
      });
    }

    async function loadHistory(){
      try{
        const res = await fetch(`/api/chat/history?tabId=${currentTabId}&limit=20&offset=0`);
        if(!res.ok) return;
        const data = await res.json();
        const chatDiv = document.getElementById('chat');
        chatDiv.innerHTML = '';
        (data.pairs || []).reverse().forEach(p => {
          addMsg('user', p.user_text);
          if(p.ai_text) addMsg('ai', p.ai_text);
        });
        chatDiv.scrollTop = chatDiv.scrollHeight;
        renderSuggestions((data.pairs || []).length === 0);
      }catch(e){console.error(e);}
    }
    function addMsg(role,text){
      const el=document.createElement('div');
      el.className='msg '+(role==='user'?'user':'ai');
      el.textContent=text;
      document.getElementById('chat').appendChild(el);
    }
    async function newTab(){
      const name = prompt('Tab name:','New Tab');
      if(!name) return;
      const r = await fetch('/api/chat/tabs/new',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name, nexum:1})});
      if(r.ok){
        await loadTabs();
        if(tabs.length>0){
          currentTabId = tabs[tabs.length-1].id;
          openTabConfig(currentTabId);
        }
        renderTabs();

        if(currentView === 'chat') loadHistory();
        if(currentView === 'tasks') loadTasksForCurrentProject();
      }
    }
    async function renameTab(tabId){
      const t = tabs.find(tt => tt.id === tabId);
      const newName = prompt("New name:", t ? t.name : "");
      if(!newName) return;
      try{
        const r = await fetch("/api/chat/tabs/rename",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({tabId,newName})});
        if(r.ok){
          await loadTabs();
          renderTabs();
        }
      }catch(e){console.error(e);}
    }

    async function deleteTab(tabId){
      if(!confirm('Are you sure you want to delete this tab (and all its messages)?')) return;
      try{
        const r = await fetch('/api/chat/tabs/' + tabId,{method:'DELETE'});
        if(r.ok){
          await loadTabs();
          if(tabs.length>0){
            currentTabId = tabs[0].id;
          }else{
            currentTabId = 1;
          }
          renderTabs();
          if(currentView === 'chat') loadHistory();
          if(currentView === 'tasks') loadTasksForCurrentProject();
        }
      }catch(e){console.error(e);}
    }

    function openTabConfig(tabId){
      const t = tabs.find(tt => tt.id === tabId) || {};
      document.getElementById('tabProjectInput').value = t.project_name || '';
      document.getElementById('tabRepoInput').value = t.repo_ssh_url || '';
      const modal = document.getElementById('tabConfigModal');
      modal.dataset.tabId = tabId;
      modal.style.display = 'flex';
    }

    function updateView(v){
      currentView = v;
      document.getElementById('viewTabChat').classList.toggle('active', v === 'chat');
      document.getElementById('viewTabTasks').classList.toggle('active', v === 'tasks');
      document.getElementById('viewTabArchive').classList.toggle('active', v === 'archive');

      const sendBtn = document.getElementById('sendBtn');
      const askBtn = document.getElementById('askBtn');
      const codeBtn = document.getElementById('codeBtn');
      if(sendBtn && askBtn && codeBtn){
        if(v === 'chat'){
          sendBtn.style.display = '';
          askBtn.style.display = 'none';
          codeBtn.style.display = 'none';
        } else {
          sendBtn.style.display = 'none';
          askBtn.style.display = '';
          codeBtn.style.display = '';
        }
      }

      const taskPanel = document.getElementById('taskListPanel');
      if(taskPanel) taskPanel.style.display = v === 'tasks' ? '' : 'none';

      const chatEl = document.getElementById('chat');
      if(chatEl) chatEl.style.display = v === 'tasks' ? 'none' : '';
      const suggestionsEl = document.getElementById('suggestions');
      if(suggestionsEl) suggestionsEl.style.display = v === 'tasks' ? 'none' : '';

      const chatPanel = document.getElementById('chatPanel');
      if(chatPanel){
        chatPanel.classList.toggle('tasks-view', v === 'tasks');
        chatPanel.style.display = '';
      }

      if(v === 'chat') {
        loadHistory();
      }
      if(v === 'tasks') {
        renderTaskHeader();
        loadTasksForCurrentProject();
      }
    }


    async function send(){
      const promptEl=document.getElementById('prompt');
      const text=promptEl.value.trim();
      if(!text) return;
      renderSuggestions(false);
      addMsg('user',text);
      promptEl.value='';
      const aiEl=document.createElement('div');
      aiEl.className='msg ai';
      aiEl.textContent='...';
      document.getElementById('chat').appendChild(aiEl);
      document.getElementById('chat').scrollTop=document.getElementById('chat').scrollHeight;
      try{
        const resp=await fetch('/api/chat',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({message:text,tabId:currentTabId})});
        if(!resp.ok||!resp.body){aiEl.textContent='[error]';return;}
        const reader=resp.body.getReader();
        const dec=new TextDecoder();
        let done=false;let result='';
        while(!done){
          const {value,done:doneR}=await reader.read();
          done=doneR;
          if(value){result+=dec.decode(value);aiEl.textContent=result;document.getElementById('chat').scrollTop=document.getElementById('chat').scrollHeight;}
        }
      }catch(e){aiEl.textContent='[error]';console.error(e);}
    }
    async function createTask(){
      const promptEl=document.getElementById('prompt');
      const text=promptEl.value.trim();
      if(!text) return;
      const tab=tabs.find(tt=>tt.id===currentTabId) || {};
      const project=tab.project_name || '';
      promptEl.value='';
      try{
        await fetch('/api/tasks/new',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({title:text, project})});
        await loadTasksForCurrentProject();
      }catch(e){console.error(e);}
    }
    document.getElementById('sendBtn').addEventListener('click',send);
    document.getElementById('askBtn').addEventListener('click',send);
    document.getElementById('codeBtn').addEventListener('click',createTask);
    document.getElementById('prompt').addEventListener('keydown',e=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();send();}});
    document.getElementById('newTabBtn').addEventListener('click', newTab);
    document.getElementById('viewTabChat').addEventListener('click', () => updateView('chat'));
    document.getElementById('viewTabTasks').addEventListener('click', () => updateView('tasks'));
    document.getElementById('viewTabArchive').addEventListener('click', () => updateView('archive'));

    function applyFeatureFlags(){
      const hideChat = localStorage.getItem('flagHideChat') === 'true';
      const chatBtn = document.getElementById('viewTabChat');
      if(chatBtn) chatBtn.style.display = hideChat ? 'none' : '';
      const cb = document.getElementById('flagHideChat');
      if(cb) cb.checked = hideChat;
    }

    document.getElementById('flagHideChat').addEventListener('change', e => {
      localStorage.setItem('flagHideChat', e.target.checked);
      applyFeatureFlags();
    });

    document.getElementById('themeColorSelect').addEventListener('change', async e => {
      currentColor = e.target.value;
      applyTheme(currentColor, currentMode);
      await fetch('/api/settings', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({key:'nexum_theme_color', value: currentColor})});
    });
    document.getElementById('themeModeSelect').addEventListener('change', async e => {
      currentMode = e.target.value;
      applyTheme(currentColor, currentMode);
      await fetch('/api/settings', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({key:'nexum_theme_mode', value: currentMode})});
    });

    document.getElementById('settingsBtn').addEventListener('click', () => {
      document.getElementById('settingsModal').style.display = 'flex';
    });
    document.getElementById('closeSettingsBtn').addEventListener('click', () => {
      document.getElementById('settingsModal').style.display = 'none';
    });
    document.getElementById('settingsModal').addEventListener('click', e => {
      if(e.target === e.currentTarget) e.currentTarget.style.display = 'none';
    });

    document.getElementById('tabConfigSaveBtn').addEventListener('click', async () => {
      const modal = document.getElementById('tabConfigModal');
      const tabId = parseInt(modal.dataset.tabId, 10);
      const project = document.getElementById('tabProjectInput').value;
      const repo = document.getElementById('tabRepoInput').value;
      await fetch('/api/chat/tabs/config', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({tabId, project, repo})});
      modal.style.display = 'none';
      await loadTabs();
      renderTabs();
      if(currentView === 'tasks') loadTasksForCurrentProject();
    });
    document.getElementById('tabConfigCancelBtn').addEventListener('click', () => {
      document.getElementById('tabConfigModal').style.display = 'none';
    });
    document.getElementById('tabConfigModal').addEventListener('click', e => {
      if(e.target === e.currentTarget) e.currentTarget.style.display = 'none';
    });

    async function init(){
      loadModelInfo();
      await loadTheme();
      await loadTabs();
      if(tabs.length>0){
        if(!Number.isNaN(startTab) && tabs.some(t=>t.id===startTab)){
          currentTabId = startTab;
        }else{
          currentTabId = tabs[0].id;
        }
      }
      renderTabs();
      applyFeatureFlags();
      renderSuggestions(false); // show/hide after history loads
      updateView('tasks');
    }
    init();

    document.getElementById('sidebarToggle').addEventListener('click', () => {
      const sb = document.getElementById('sidebar');
      if(sb.style.display === 'none') sb.style.display = '';
      else sb.style.display = 'none';
    });
  </script>
</body>
</html>
