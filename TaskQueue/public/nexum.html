<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Alfe AI</title>
  <style>
    body {
      background:#1e1e1e;
      color:#ddd;
      font-family:sans-serif;
      margin:0;
    }
    .app {
      display:flex;
      height:100vh;
      overflow:hidden;
    }
    #sidebar {
      width:200px;
      background:#2d2d2d;
      padding:1rem;
      overflow-y:auto;
      border-right:1px solid #444;
    }
    #tabsList .tab-item {
      display:flex;
      align-items:center;
      margin-bottom:4px;
    }
    #tabsList button {
      flex:1;
      background:#333;
      border:1px solid #444;
      color:#ddd;
      padding:4px 6px;
      text-align:left;
      cursor:pointer;
    }
    #tabsList button.active {
      background:#555;
      border-color:#aaa;
      color:#fff;
    }
    #tabsList .config-btn {
      background:none;
      border:none;
      color:#ddd;
      cursor:pointer;
      margin-left:4px;
    }
    main {
      flex:1;
      padding:1rem;
      display:flex;
      flex-direction:column;
      overflow:hidden;
    }
    #chatPanel {
      display:flex;
      flex-direction:column;
      flex:1;
      overflow:hidden;
    }
    #chat {
      flex:1;
      max-width:800px;
      margin:0 auto 1rem auto;
      display:flex;
      flex-direction:column;
      gap:0.5rem;
      overflow-y:auto;
    }
    #suggestions {
      max-width:800px;
      margin:0 auto 1rem auto;
      display:grid;
      grid-template-columns:repeat(2,1fr);
      gap:0.5rem;
    }
    #suggestions button {
      background:#333;
      color:#ddd;
      border:1px solid #444;
      padding:6px 8px;
      text-align:left;
      cursor:pointer;
    }
    .msg {
      border:1px solid #444;
      padding:8px;
      border-radius:6px;
      white-space:pre-wrap;
    }
    .user { background:#3b3b3b; align-self:flex-end; }
    .ai   { background:#2a2a2a; align-self:flex-start; }
    #inputArea {
      max-width:800px;
      margin:0 auto;
      display:flex;
      gap:0.5rem;
    }
    #prompt {
      flex:1;
      background:#2a2a2a;
      color:#ddd;
      border:1px solid #444;
      padding:8px;
      font-family:monospace;
      resize:vertical;
    }
    button {
      padding:8px 12px;
    }

    /* View tabs above chat panel */
    .view-tab {
      background:#333;
      color:#ddd;
      border:1px solid #444;
      padding:4px 8px;
      cursor:pointer;
    }
    .view-tab.active {
      background:#555;
      border-color:#aaa;
      color:#fff;
    }

    #settingsBtn {
      background:none;
      border:none;
      color:#ddd;
      cursor:pointer;
      font-size:1.2rem;
    }

    #settingsModal {
      position:fixed;
      top:0;
      left:0;
      width:100%;
      height:100%;
      background:rgba(0,0,0,0.6);
      display:none;
      justify-content:center;
      align-items:center;
    }

    #settingsModal .modal-content {
      background:#2d2d2d;
      border:1px solid #444;
      padding:1rem;
      width:300px;
      color:#ddd;
    }

    #tabConfigModal {
      position:fixed;
      top:0;
      left:0;
      width:100%;
      height:100%;
      background:rgba(0,0,0,0.6);
      display:none;
      justify-content:center;
      align-items:center;
    }
    #tabConfigModal .modal-content {
      background:#2d2d2d;
      border:1px solid #444;
      padding:1rem;
      width:300px;
      color:#ddd;
    }
  </style>
</head>
<body>
  <div class="app">
    <aside id="sidebar">
      <h2>Chat Tabs</h2>
      <div id="tabsList"></div>
      <button id="newTabBtn">New Tab</button>
    </aside>
    <main>
      <div id="viewTabsBar" style="display:flex;gap:0.5rem;margin-bottom:0.5rem;align-items:center;">
        <button id="viewTabChat" class="view-tab active">Chat</button>
        <button id="viewTabTasks" class="view-tab">Tasks</button>
        <button id="viewTabArchive" class="view-tab">Archive</button>
        <button id="settingsBtn" title="Settings" style="margin-left:auto;background:none;border:none;color:#ddd;font-size:1.2rem;cursor:pointer;">&#9881;</button>
      </div>
<!--      <h1>Nexum Chat</h1>-->
      <div id="modelInfo" style="margin-bottom:0.5rem; color:#aaa;"></div>
      <div id="chatPanel">
        <div id="suggestions"></div>
        <div id="chat"></div>
        <div id="inputArea">
          <textarea id="prompt" rows="3" placeholder="Enter your message"></textarea>
          <button id="sendBtn"><span id="sendBtnText">Send</span></button>
          <button id="askBtn" style="display:none;">Ask</button>
          <button id="codeBtn" style="display:none;">Code</button>
        </div>
      </div>
      <div id="taskListPanel" style="display:none;border:1px dashed #666; padding:8px; margin:8px 0;">
        <h2 style="margin:0;font-size:1.1rem;">Tasks</h2>
        <table id="tasks">
          <thead><tr id="headerRow"></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </main>
  </div>
  <div id="settingsModal">
    <div class="modal-content">
      <h3>Nexum Settings</h3>
      <div>
        <h4>Nexum Feature Flags</h4>
        <label><input type="checkbox" id="flagHideChat"> Hide Chat Tab</label>
      </div>
      <button id="closeSettingsBtn" style="margin-top:1rem;">Close</button>
    </div>
  </div>
  <div id="tabConfigModal">
    <div class="modal-content">
      <h3>Tab Configuration</h3>
      <label>Project Name:<br/>
        <input type="text" id="tabProjectInput" style="width:100%;" />
      </label>
      <label style="margin-top:8px;">Git Repo SSH URL:<br/>
        <input type="text" id="tabRepoInput" style="width:100%;" />
      </label>
      <div style="margin-top:1rem;text-align:right;">
        <button id="tabConfigSaveBtn">Save</button>
        <button id="tabConfigCancelBtn">Cancel</button>
      </div>
    </div>
  </div>
  <script>
    let tabs = [];
    let currentTabId = 1;
    let currentView = 'chat';
    const taskColumns = [
      {key:'priority', label:'Prio'},
      {key:'status', label:'Status'},
      {key:'number', label:'#'},
      {key:'title', label:'Title'},
      {key:'dependencies', label:'Depends On'},
      {key:'project', label:'Project'},
      {key:'created', label:'Created'}
    ];
    const suggestions = [
      'Code a Pong Clone in JavaScript',
      'Create a basic to-do list in Python',
      'Explain how recursion works',
      'Design a responsive navbar'
    ];
    const urlParams = new URLSearchParams(location.search);
    const startTab = parseInt(urlParams.get('tabId'), 10);
    if(!Number.isNaN(startTab)) currentTabId = startTab;


    async function loadModelInfo(){
      try{
        const res = await fetch('/api/model');
        if(!res.ok) return;
        const data = await res.json();
        document.getElementById('modelInfo').textContent = 'Model: ' + (data.model || 'unknown');
      }catch(e){console.error(e);}
    }

    async function loadTabs(){
      try{
        const res = await fetch('/api/chat/tabs?nexum=1');
        if(res.ok){
          tabs = await res.json();
        } else {
          tabs = [{id:1,name:'Tab 1'}];
        }
      }catch(e){ tabs = [{id:1,name:'Tab 1'}]; console.error(e); }
    }

    function renderTabs(){
      const container = document.getElementById('tabsList');
      container.innerHTML = '';
      tabs.forEach(t => {
        const item = document.createElement('div');
        item.className = 'tab-item';

        const b = document.createElement('button');
        b.textContent = t.name;
        if(t.id === currentTabId) b.classList.add('active');
        b.addEventListener('click', () => {
          currentTabId = t.id;
          if(currentView === 'chat') loadHistory();
          if(currentView === 'tasks') loadTasksForCurrentProject();
          renderTabs();
        });
        b.addEventListener('contextmenu', e => { e.preventDefault(); renameTab(t.id); });

        const gear = document.createElement('button');
        gear.innerHTML = '&#9881;';
        gear.className = 'config-btn';
        gear.addEventListener('click', (e) => { e.stopPropagation(); openTabConfig(t.id); });

        item.appendChild(b);
        item.appendChild(gear);
        container.appendChild(item);
      });
    }

    function isoDate(d){
      return new Date(d).toLocaleDateString([], {year:'2-digit',month:'2-digit',day:'2-digit'});
    }

    function renderTaskHeader(){
      const tr = document.getElementById('headerRow');
      if(!tr) return;
      tr.innerHTML = '';
      taskColumns.forEach(col => {
        const th = document.createElement('th');
        th.textContent = col.label;
        tr.appendChild(th);
      });
    }

    function renderTasks(tasks){
      const tbody = document.querySelector('#tasks tbody');
      if(!tbody) return;
      tbody.innerHTML = '';
      tasks.forEach(t => {
        const tr = document.createElement('tr');
        taskColumns.forEach(col => {
          const td = document.createElement('td');
          switch(col.key){
            case 'number':
              td.innerHTML = `<a href="${t.html_url}" target="_blank">#${t.number}</a>`;
              break;
            case 'created':
              td.textContent = isoDate(t.created_at);
              break;
            default:
              td.textContent = t[col.key] || '';
          }
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });
    }

    async function loadTasksForCurrentProject(){
      const t = tabs.find(tt => tt.id === currentTabId);
      if(!t || !t.project_name){
        renderTasks([]);
        return;
      }
      try{
        const res = await fetch('/api/projects/' + encodeURIComponent(t.project_name));
        if(res.ok){
          const data = await res.json();
          renderTasks(data);
        }else{
          renderTasks([]);
        }
      }catch(e){
        console.error(e);
        renderTasks([]);
      }
    }

    function renderSuggestions(show = true){
      const container = document.getElementById('suggestions');
      if(!container) return;
      container.innerHTML = '';
      container.style.display = show ? 'grid' : 'none';
      if(!show) return;
      suggestions.forEach(text => {
        const b = document.createElement('button');
        b.textContent = text;
        b.addEventListener('click', () => {
          document.getElementById('prompt').value = text;
          document.getElementById('prompt').focus();
        });
        container.appendChild(b);
      });
    }

    async function loadHistory(){
      try{
        const res = await fetch(`/api/chat/history?tabId=${currentTabId}&limit=20&offset=0`);
        if(!res.ok) return;
        const data = await res.json();
        const chatDiv = document.getElementById('chat');
        chatDiv.innerHTML = '';
        (data.pairs || []).reverse().forEach(p => {
          addMsg('user', p.user_text);
          if(p.ai_text) addMsg('ai', p.ai_text);
        });
        chatDiv.scrollTop = chatDiv.scrollHeight;
        renderSuggestions((data.pairs || []).length === 0);
      }catch(e){console.error(e);}
    }
    function addMsg(role,text){
      const el=document.createElement('div');
      el.className='msg '+(role==='user'?'user':'ai');
      el.textContent=text;
      document.getElementById('chat').appendChild(el);
    }
    async function newTab(){
      const name = prompt('Tab name:','New Tab');
      if(!name) return;
      const r = await fetch('/api/chat/tabs/new',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name, nexum:1})});
      if(r.ok){
        await loadTabs();
        if(tabs.length>0){
          currentTabId = tabs[tabs.length-1].id;
          openTabConfig(currentTabId);
        }
        renderTabs();

        if(currentView === 'chat') loadHistory();
        if(currentView === 'tasks') loadTasksForCurrentProject();
      }
    }
    async function renameTab(tabId){
      const t = tabs.find(tt => tt.id === tabId);
      const newName = prompt("New name:", t ? t.name : "");
      if(!newName) return;
      try{
        const r = await fetch("/api/chat/tabs/rename",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({tabId,newName})});
        if(r.ok){
          await loadTabs();
          renderTabs();
        }
      }catch(e){console.error(e);}
    }

    function openTabConfig(tabId){
      const t = tabs.find(tt => tt.id === tabId) || {};
      document.getElementById('tabProjectInput').value = t.project_name || '';
      document.getElementById('tabRepoInput').value = t.repo_ssh_url || '';
      const modal = document.getElementById('tabConfigModal');
      modal.dataset.tabId = tabId;
      modal.style.display = 'flex';
    }

    function updateView(v){
      currentView = v;
      document.getElementById('viewTabChat').classList.toggle('active', v === 'chat');
      document.getElementById('viewTabTasks').classList.toggle('active', v === 'tasks');
      document.getElementById('viewTabArchive').classList.toggle('active', v === 'archive');

      const sendBtn = document.getElementById('sendBtn');
      const askBtn = document.getElementById('askBtn');
      const codeBtn = document.getElementById('codeBtn');
      if(sendBtn && askBtn && codeBtn){
        if(v === 'chat'){
          sendBtn.style.display = '';
          askBtn.style.display = 'none';
          codeBtn.style.display = 'none';
        } else {
          sendBtn.style.display = 'none';
          askBtn.style.display = '';
          codeBtn.style.display = '';
        }
      }

      const taskPanel = document.getElementById('taskListPanel');
      if(taskPanel) taskPanel.style.display = v === 'tasks' ? '' : 'none';

      const chatEl = document.getElementById('chat');
      if(chatEl) chatEl.style.display = v === 'tasks' ? 'none' : '';
      const suggestionsEl = document.getElementById('suggestions');
      if(suggestionsEl) suggestionsEl.style.display = v === 'tasks' ? 'none' : '';

      const chatPanel = document.getElementById('chatPanel');
      if(chatPanel) chatPanel.style.display = '';

      if(v === 'chat') {
        loadHistory();
      }
      if(v === 'tasks') {
        renderTaskHeader();
        loadTasksForCurrentProject();
      }
    }


    async function send(){
      const promptEl=document.getElementById('prompt');
      const text=promptEl.value.trim();
      if(!text) return;
      renderSuggestions(false);
      addMsg('user',text);
      promptEl.value='';
      const aiEl=document.createElement('div');
      aiEl.className='msg ai';
      aiEl.textContent='...';
      document.getElementById('chat').appendChild(aiEl);
      document.getElementById('chat').scrollTop=document.getElementById('chat').scrollHeight;
      try{
        const resp=await fetch('/api/chat',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({message:text,tabId:currentTabId})});
        if(!resp.ok||!resp.body){aiEl.textContent='[error]';return;}
        const reader=resp.body.getReader();
        const dec=new TextDecoder();
        let done=false;let result='';
        while(!done){
          const {value,done:doneR}=await reader.read();
          done=doneR;
          if(value){result+=dec.decode(value);aiEl.textContent=result;document.getElementById('chat').scrollTop=document.getElementById('chat').scrollHeight;}
        }
      }catch(e){aiEl.textContent='[error]';console.error(e);}
    }
    document.getElementById('sendBtn').addEventListener('click',send);
    document.getElementById('askBtn').addEventListener('click',send);
    document.getElementById('codeBtn').addEventListener('click',send);
    document.getElementById('prompt').addEventListener('keydown',e=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();send();}});
    document.getElementById('newTabBtn').addEventListener('click', newTab);
    document.getElementById('viewTabChat').addEventListener('click', () => updateView('chat'));
    document.getElementById('viewTabTasks').addEventListener('click', () => updateView('tasks'));
    document.getElementById('viewTabArchive').addEventListener('click', () => updateView('archive'));

    function applyFeatureFlags(){
      const hideChat = localStorage.getItem('flagHideChat') === 'true';
      const chatBtn = document.getElementById('viewTabChat');
      if(chatBtn) chatBtn.style.display = hideChat ? 'none' : '';
      const cb = document.getElementById('flagHideChat');
      if(cb) cb.checked = hideChat;
    }

    document.getElementById('flagHideChat').addEventListener('change', e => {
      localStorage.setItem('flagHideChat', e.target.checked);
      applyFeatureFlags();
    });

    document.getElementById('settingsBtn').addEventListener('click', () => {
      document.getElementById('settingsModal').style.display = 'flex';
    });
    document.getElementById('closeSettingsBtn').addEventListener('click', () => {
      document.getElementById('settingsModal').style.display = 'none';
    });
    document.getElementById('settingsModal').addEventListener('click', e => {
      if(e.target === e.currentTarget) e.currentTarget.style.display = 'none';
    });

    document.getElementById('tabConfigSaveBtn').addEventListener('click', async () => {
      const modal = document.getElementById('tabConfigModal');
      const tabId = parseInt(modal.dataset.tabId, 10);
      const project = document.getElementById('tabProjectInput').value;
      const repo = document.getElementById('tabRepoInput').value;
      await fetch('/api/chat/tabs/config', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({tabId, project, repo})});
      modal.style.display = 'none';
      await loadTabs();
      renderTabs();
      if(currentView === 'tasks') loadTasksForCurrentProject();
    });
    document.getElementById('tabConfigCancelBtn').addEventListener('click', () => {
      document.getElementById('tabConfigModal').style.display = 'none';
    });
    document.getElementById('tabConfigModal').addEventListener('click', e => {
      if(e.target === e.currentTarget) e.currentTarget.style.display = 'none';
    });

    async function init(){
      loadModelInfo();
      await loadTabs();
      if(tabs.length>0){
        if(!Number.isNaN(startTab) && tabs.some(t=>t.id===startTab)){
          currentTabId = startTab;
        }else{
          currentTabId = tabs[0].id;
        }
      }
      renderTabs();
      applyFeatureFlags();
      renderSuggestions(false); // show/hide after history loads
      updateView('tasks');
    }
    init();
  </script>
</body>
</html>
