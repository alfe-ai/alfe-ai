<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Printify Pipeline Queue</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    .img-dropdown {
      position: relative;
      min-width: 300px;
      width: 300px;
      cursor: pointer;
    }
    .img-dropdown .selected {
      border: 1px solid #444;
      padding: 4px;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      background-color: #222;
    }
    .img-dropdown .selected img {
      max-height: 40px;
    }
    .img-dropdown .options {
      position: absolute;
      left: 0;
      right: 0;
      top: 100%;
      background-color: #222;
      border: 1px solid #444;
      max-height: 200px;
      overflow-y: auto;
      width: 300px;
      z-index: 1000;
      display: none;
    }
    .img-dropdown .option {
      padding: 4px;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .img-dropdown .option img {
      max-height: 40px;
    }
    .img-dropdown .option:hover {
      background-color: #333;
    }
  </style>
</head>
<body style="padding:1rem;">
  <h2>Printify Pipeline Queue</h2>
  <div id="addJob" style="margin-bottom:1rem;display:flex;align-items:center;gap:0.5rem;">
    <label>Type:
      <select id="jobType">
        <option value="upscale">Upscale</option>
        <option value="printify">Printify</option>
      </select>
    </label>
    <label>Image:
      <div id="imageSelect" class="img-dropdown">
        <div class="selected">-- choose --</div>
        <div class="options"></div>
      </div>
    </label>
    <img id="imagePreview" style="display:none;max-height:80px;border:1px solid #444;" />
    <button id="enqueueBtn">Add to Queue</button>
  </div>
  <table id="queueTable" style="width:100%;border-collapse:collapse;">
    <thead>
      <tr>
        <th>ID</th>
        <th>File</th>
        <th>Type</th>
        <th>Status</th>
        <th>Job ID</th>
        <th>Result Path</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <script>
    async function loadQueue(){
      try{
        const res = await fetch('/api/pipelineQueue');
        const queue = await res.json();
        const tbody = document.querySelector('#queueTable tbody');
        tbody.innerHTML = '';
        queue.forEach(job => {
          const tr = document.createElement('tr');
          const jobLink = job.jobId ? `<a href="jobs.html?jobId=${job.jobId}" target="_blank">${job.jobId}</a>` : '';
          tr.innerHTML = `
            <td>${job.id}</td>
            <td>${job.file}</td>
            <td>${job.type}</td>
            <td>${job.status}</td>
            <td>${jobLink}</td>
            <td>${job.resultPath || ''}</td>
          `;
          tbody.appendChild(tr);
        });
      }catch(e){
        console.error('Failed to load queue', e);
      }
    }
    const dropdown = document.getElementById('imageSelect');
    const selectedDiv = dropdown.querySelector('.selected');
    const optionsDiv = dropdown.querySelector('.options');

    async function loadImages(){
      try{
        const res = await fetch('/api/upload/list');
        const files = await res.json();
        optionsDiv.innerHTML = '';
        dropdown.dataset.value = '';
        selectedDiv.textContent = '-- choose --';
        files.forEach(f => {
          const item = document.createElement('div');
          item.className = 'option';
          item.dataset.value = f.name;
          item.innerHTML = `<img src="/uploads/${encodeURIComponent(f.name)}" /> <span>${f.index}: ${f.name}</span>`;
          item.addEventListener('click', () => {
            selectedDiv.innerHTML = `<img src="/uploads/${encodeURIComponent(f.name)}" /> <span>${f.index}: ${f.name}</span>`;
            dropdown.dataset.value = f.name;
            optionsDiv.style.display = 'none';
            updatePreview(f.name);
          });
          optionsDiv.appendChild(item);
        });
      }catch(e){
        console.error('Failed to load images', e);
      }
    }

    dropdown.addEventListener('click', () => {
      optionsDiv.style.display = optionsDiv.style.display === 'block' ? 'none' : 'block';
    });

    document.addEventListener('click', e => {
      if(!dropdown.contains(e.target)) optionsDiv.style.display = 'none';
    });

    function updatePreview(val){
      const img = document.getElementById('imagePreview');
      if(val){
        img.src = '/uploads/' + encodeURIComponent(val);
        img.style.display = '';
      }else{
        img.style.display = 'none';
      }
    }

    document.getElementById('enqueueBtn').addEventListener('click', async () => {
      const file = document.getElementById('imageSelect').dataset.value;
      const type = document.getElementById('jobType').value;
      if(!file) return;
      try{
        await fetch('/api/pipelineQueue', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ file, type })
        });
        await loadQueue();
      }catch(e){
        console.error('Failed to enqueue job', e);
      }
    });

    loadQueue();
    loadImages();
    setInterval(loadQueue, 5000);
  </script>
</body>
</html>
