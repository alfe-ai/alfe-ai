<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Sterling Â· Repositories</title>
    <link rel="stylesheet" href="/styles.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
    <style>
        :root {
            color-scheme: dark;
            --nexum-bg-outer: #050713;
            --nexum-bg-inner: #111528;
            --nexum-panel: rgba(15, 20, 38, 0.85);
            --nexum-card: rgba(22, 28, 52, 0.92);
            --nexum-border: rgba(124, 144, 196, 0.22);
            --nexum-text: #e2e8f0;
            --nexum-muted: #94a3b8;
            --nexum-accent: #7c3aed;
            --nexum-accent-soft: rgba(124, 58, 237, 0.28);
            --nexum-accent-bright: #8b5cf6;
            --nexum-table-alt: rgba(31, 41, 71, 0.55);
            --nexum-hover: rgba(124, 58, 237, 0.24);
            --shadow-strong: 0 32px 68px rgba(3, 7, 18, 0.65);
            --shadow-soft: 0 24px 48px rgba(7, 11, 25, 0.4);
        }
        body { font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; margin: 0; padding: 48px 24px; background: linear-gradient(135deg, var(--nexum-bg-outer), var(--nexum-bg-inner)); color: var(--nexum-text); min-height:100vh; }
        .page { max-width: 1100px; margin: 0 auto; }
        header { padding: 20px; border-radius: 16px; background: linear-gradient(145deg, rgba(17,24,39,0.8), rgba(17,24,39,0.6)); border:1px solid var(--nexum-border); box-shadow: var(--shadow-soft); margin-bottom:24px; }
        header h1 { margin:0; font-size:1.8rem; }
        header p { margin:6px 0 0; color:var(--nexum-muted); }
        ul.repo-list { list-style:none; padding:0; margin:20px 0; display:grid; grid-template-columns: repeat(auto-fit, minmax(280px,1fr)); gap:14px; }
        li.repo { padding:0; border-radius:12px; background: linear-gradient(135deg, rgba(17,24,39,0.92), rgba(15,23,42,0.78)); border:1px solid var(--nexum-border); box-shadow: var(--shadow-soft); }
        li.repo.is-hidden { display:none; }
        .repo-card { display:flex; align-items:center; gap:12px; padding:14px; }
        a.repo-link { display:flex; align-items:center; gap:12px; color:var(--nexum-accent-bright); font-weight:600; text-decoration:none; border-radius:12px; flex:1; min-width:0; }
        a.repo-link:hover { color:#fff; text-decoration:underline; }
        .repo-name { flex:1; min-width:0; }
        .demo-badge { padding:4px 10px; border-radius:999px; font-size:0.75rem; letter-spacing:0.04em; text-transform:uppercase; font-weight:700; color:#f8fafc; background:rgba(124, 58, 237, 0.35); border:1px solid rgba(124, 58, 237, 0.6); box-shadow: 0 0 16px rgba(124, 58, 237, 0.35); }
        .repo-meta { margin-top:8px; color:var(--nexum-muted); font-size:0.95rem; }
        .repo-delete-form { margin:0; }
        .repo-delete-button { width:34px; height:34px; border-radius:999px; border:1px solid var(--nexum-border); background: rgba(15, 23, 42, 0.6); color:var(--nexum-muted); display:flex; align-items:center; justify-content:center; cursor:pointer; transition: border-color 0.2s ease, color 0.2s ease, background 0.2s ease, transform 0.2s ease; }
        .repo-delete-button:hover { color:#f87171; border-color: rgba(248, 113, 113, 0.6); background: rgba(248, 113, 113, 0.12); transform: translateY(-1px); }
        .repo-delete-button:focus-visible { outline:2px solid rgba(248, 113, 113, 0.6); outline-offset:2px; }
        footer { margin-top:28px; color:var(--nexum-muted); }
        .actions { margin-top:12px; display:flex; gap:12px; flex-wrap:wrap; }
        .button { display:inline-block; padding:10px 14px; border-radius:999px; background: linear-gradient(135deg, #7c3aed 0%, #8b5cf6 100%); color: #ffffff; border: none; text-decoration:none; font-weight:600; }
        .button.secondary { background: rgba(17,24,39,0.65); border:1px solid var(--nexum-border); color:var(--nexum-text); }
        .button.secondary:hover { background: rgba(17,24,39,0.85); color:#fff; }
    </style>
</head>
<body>
    <%- include('partials/session_banner') %>
    <div class="page">
        <header>
            <div class="actions">
                <a class="button add-repo-button" href="/repositories/add" role="button">Connect Git Repository</a>
            </div>
        </header>

        <ul class="repo-list">
            <% repos.forEach(function(repo) { %>
                <li class="repo" data-is-demo="<%= repo.isDemo ? 'true' : 'false' %>">
                    <div class="repo-card">
                        <a class="repo-link" href="/agent?repo_directory=<%- encodeURIComponent(repo.gitRepoLocalPath || '') %>&repo_name=<%- encodeURIComponent(repo.name) %>" target="_blank" rel="noopener noreferrer">
                            <span class="repo-name"><%= repo.name %></span>
                            <% if (repo.isDemo) { %>
                                <span class="demo-badge">Demo</span>
                            <% } %>
                        </a>
                        <% if (!repo.isDemo) { %>
                            <form class="repo-delete-form" action="/repositories/delete" method="POST" data-repo-name="<%- repo.name %>">
                                <input type="hidden" name="repoName" value="<%- repo.name %>">
                                <button type="submit" class="repo-delete-button" aria-label="Delete repository <%- repo.name %>" title="Delete repository">
                                    <svg viewBox="0 0 24 24" width="16" height="16" aria-hidden="true" focusable="false">
                                        <path d="M9 3h6l1 2h4v2H4V5h4l1-2zm1 6h2v8h-2V9zm4 0h2v8h-2V9zM7 9h2v8H7V9z" fill="currentColor"/>
                                    </svg>
                                </button>
                            </form>
                        <% } %>
                    </div>
                </li>
            <% }); %>
        </ul>
        <footer>
            <div
                class="how-it-works"
                data-how-it-works
                style="
                    margin-top: 18px;
                    padding: 18px;
                    border-radius: 12px;
                    background: linear-gradient(135deg, rgba(17, 24, 39, 0.92), rgba(15, 23, 42, 0.78));
                    border: 1px solid var(--nexum-border);
                    color: var(--nexum-muted);
                "
            ></div>
        </footer>
        <div style="margin-top:12px;color:var(--nexum-muted);font-size:0.9rem;">Session ID: <%= sessionId %></div>

        <div style="margin-top:8px;"><a href="/about.html" class="button secondary">About</a></div>

        <script>
            (function(){
                function parseBooleanFlag(value){
                    if (Array.isArray(value)) return parseBooleanFlag(value[value.length-1]);
                    if (typeof value === 'boolean') return value;
                    if (typeof value === 'number') return value===1;
                    if (typeof value === 'string'){
                        var n=value.trim().toLowerCase();
                        if(!n) return false;
                        return ['1','true','yes','y','on'].includes(n);
                    }
                    return false;
                }
                var params = new URLSearchParams(window.location.search);
                var iframeParam = params.get('iframe');
                var isIframeMode = (iframeParam===null) ? false : parseBooleanFlag(iframeParam);
                var howItWorksContainer = document.querySelector('[data-how-it-works]');
                if(isIframeMode){
                    if(howItWorksContainer) howItWorksContainer.style.display='none';
                } else if (howItWorksContainer) {
                    fetch('/how-it-works.html')
                        .then(function(response){
                            return response.ok ? response.text() : '';
                        })
                        .then(function(html){
                            if (html) howItWorksContainer.innerHTML = html;
                        });
                }

                var addRepoButton = document.querySelector('.add-repo-button');
                var tooltipMessage = document.querySelector('.tooltip-message');
                if (addRepoButton && tooltipMessage) {
                    var tooltipTimeout;
                    var showTooltip = function() {
                        tooltipMessage.classList.add('visible');
                        if (tooltipTimeout) clearTimeout(tooltipTimeout);
                        tooltipTimeout = setTimeout(function() {
                            tooltipMessage.classList.remove('visible');
                        }, 2000);
                    };

                    addRepoButton.addEventListener('click', function(event) {
                        event.preventDefault();
                        showTooltip();
                    });

                    addRepoButton.addEventListener('mouseenter', showTooltip);
                    addRepoButton.addEventListener('focus', showTooltip);
                }

                document.querySelectorAll('.repo-delete-form').forEach(function(form){
                    form.addEventListener('submit', function(event){
                        var repoName = form.dataset.repoName || '';
                        var message = repoName
                            ? 'Remove ' + repoName + ' from your repositories list? This will not delete local files.'
                            : 'Remove this repository from your list? This will not delete local files.';
                        if (!window.confirm(message)) {
                            event.preventDefault();
                        }
                    });
                });

                try {
                    var demoPreference = localStorage.getItem('showDemoRepos');
                    var showDemoRepos = (demoPreference === null) ? true : demoPreference === 'true';
                    if (!showDemoRepos) {
                        document.querySelectorAll('.repo[data-is-demo="true"]').forEach(function(card){
                            card.classList.add('is-hidden');
                        });
                    }
                } catch (e) {
                    /* noop */
                }
            })();
        </script>
    </div>
</body>
</html>
