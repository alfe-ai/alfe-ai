<div class="ai-selectors">
    <select name="aiProvider" id="aiProvider" onchange="this.form.submit()">
        <option value="openrouter" <%= chatData.aiProvider.toLowerCase() === 'openrouter' ? 'selected' : '' %>>OpenRouter</option>
        <option value="litellm" <%= chatData.aiProvider.toLowerCase() === 'litellm' ? 'selected' : '' %>>LiteLLM</option>
        <option value="deepseek api" <%= chatData.aiProvider.toLowerCase() === 'deepseek api' ? 'selected' : '' %>>DeepSeek API</option>
        <option value="deepseek local" <%= chatData.aiProvider.toLowerCase() === 'deepseek local' ? 'selected' : '' %>>DeepSeek Local</option>
    </select>
    <select name="aiModel" id="aiModel" onchange="this.form.submit()">
        <%
            const userPlan = chatData.plan || 'Lite'; // Default to Lite if not present
            const filtered = (AIModels || []).filter(m => {
                const id = m && typeof m.id === 'string' ? m.id : '';
                // Check if the model is allowed based on the user's plan
                if (userPlan === 'Lite') {
                    return !m.plus_model; // Only show models that are not plus_model
                } else {
                    return true; // Show all models for Plus/Pro
                }
            });
        %>
        <% if (filtered && filtered.length > 0) { %>
            <% filtered.forEach(function(model) { %>
                <option value="<%= model.id %}" <%= model.id === aiModel ? 'selected' : '' %>>
                    <%= model.name || model.id %><% if (model.contextLimitLabel && model.contextLimitLabel !== 'N/A') { %> (<span class="context-limit"><%= model.contextLimitLabel %></span>)<% } %>
                </option>
            <% }); %>
        <% } else { %>
            <option value="<%= aiModel %}" selected><%= aiModel %></option>
        <% } %>
    </select>
</div>