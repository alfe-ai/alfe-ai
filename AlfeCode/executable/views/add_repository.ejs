<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Alfe AI - Add Repository</title>
    <link rel="stylesheet" href="/styles.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
    <style>
        :root {
            color-scheme: dark;
            --nexum-bg-outer: #050713;
            --nexum-bg-inner: #111528;
            --nexum-panel: rgba(15, 20, 38, 0.85);
            --nexum-card: rgba(22, 28, 52, 0.92);
            --nexum-border: rgba(124, 144, 196, 0.22);
            --nexum-text: #e2e8f0;
            --nexum-muted: #94a3b8;
            --nexum-accent: #7c3aed;
            --nexum-accent-soft: rgba(124, 58, 237, 0.28);
            --nexum-accent-bright: #8b5cf6;
            --shadow-strong: 0 32px 68px rgba(3, 7, 18, 0.65);
            --shadow-soft: 0 24px 48px rgba(7, 11, 25, 0.4);
        }
        body {
            font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            margin: 0;
            padding: 48px 24px;
            background: linear-gradient(135deg, var(--nexum-bg-outer), var(--nexum-bg-inner));
            color: var(--nexum-text);
            min-height: 100vh;
        }
        .page {
            max-width: 860px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 24px;
        }
        header {
            padding: 24px;
            border-radius: 16px;
            background: linear-gradient(145deg, rgba(17,24,39,0.8), rgba(17,24,39,0.6));
            border: 1px solid var(--nexum-border);
            box-shadow: var(--shadow-soft);
        }
        header h1 {
            margin: 0 0 6px;
            font-size: 1.9rem;
        }
        header p {
            margin: 0;
            color: var(--nexum-muted);
            line-height: 1.5;
        }
        .card {
            padding: 24px;
            border-radius: 18px;
            background: linear-gradient(135deg, rgba(17, 24, 39, 0.92), rgba(15, 23, 42, 0.78));
            border: 1px solid var(--nexum-border);
            box-shadow: var(--shadow-strong);
        }
        .meta {
            margin: 0 0 18px;
            color: var(--nexum-muted);
            font-size: 0.95rem;
        }
        .meta-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            flex-wrap: wrap;
            margin-bottom: 18px;
        }
        .meta-row .meta {
            margin: 0;
        }
        .meta-action {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--nexum-muted);
            font-size: 0.95rem;
        }
        .alert {
            padding: 14px 16px;
            border-radius: 12px;
            border: 1px solid rgba(248, 113, 113, 0.4);
            background: rgba(127, 29, 29, 0.2);
            color: #fecaca;
            margin-bottom: 18px;
        }
        .ssh-card {
            border-radius: 14px;
            border: 1px solid rgba(124, 58, 237, 0.35);
            background: rgba(30, 27, 75, 0.35);
            padding: 16px;
            margin-bottom: 18px;
        }
        .ssh-card h3 {
            margin: 0 0 8px;
            font-size: 1.1rem;
        }
        .ssh-card p {
            margin: 0 0 12px;
            color: var(--nexum-muted);
        }
        .ssh-key-output {
            width: 100%;
            min-height: 88px;
            padding: 10px 12px;
            border-radius: 10px;
            border: 1px solid rgba(148, 163, 184, 0.4);
            background: rgba(15, 23, 42, 0.75);
            color: var(--nexum-text);
            font-family: "JetBrains Mono", "SFMono-Regular", ui-monospace, monospace;
            font-size: 0.9rem;
            resize: vertical;
            box-sizing: border-box;
        }
        .ssh-status {
            font-size: 0.9rem;
            color: var(--nexum-muted);
            margin-top: 8px;
        }
        .ssh-status .ssh-link {
            color: #22d3ee;
            font-weight: 600;
            text-decoration: none;
        }
        .ssh-status .ssh-link:hover,
        .ssh-status .ssh-link:focus {
            color: #67e8f9;
            text-decoration: underline;
        }
        form label {
            font-weight: 600;
        }
        .inline-edit-row {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }
        .inline-edit-display {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 6px 0;
        }
        .inline-edit-value {
            font-weight: 500;
        }
        .inline-edit-value.placeholder {
            color: var(--nexum-muted);
            font-style: italic;
            font-weight: 400;
        }
        .inline-edit-input {
            margin-top: 8px;
        }
        .icon-button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            border-radius: 8px;
            border: 1px solid var(--nexum-border);
            background: rgba(15, 23, 42, 0.6);
            color: var(--nexum-text);
            cursor: pointer;
        }
        .icon-button:hover {
            background: rgba(30, 41, 59, 0.75);
        }
        .is-hidden {
            display: none;
        }
        form input[type="text"] {
            width: 100%;
            box-sizing: border-box;
            margin-top: 6px;
            padding: 12px 14px;
            border-radius: 10px;
            border: 1px solid rgba(148, 163, 184, 0.4);
            background: rgba(15, 23, 42, 0.75);
            color: var(--nexum-text);
            font-size: 0.95rem;
        }
        form input[type="text"]::placeholder {
            color: rgba(148, 163, 184, 0.7);
        }
        form small {
            display: block;
            margin-top: 8px;
            color: var(--nexum-muted);
            line-height: 1.4;
        }
        .field {
            margin-bottom: 20px;
        }
        .button-row {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-top: 18px;
        }
        button,
        .button-link {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 10px 18px;
            border-radius: 999px;
            border: none;
            background: linear-gradient(135deg, #7c3aed 0%, #8b5cf6 100%);
            color: #fff;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
        }
        button.secondary {
            background: rgba(17,24,39,0.65);
            border: 1px solid var(--nexum-border);
            color: var(--nexum-text);
        }
        button.secondary:hover,
        .button-link.secondary:hover {
            background: rgba(17,24,39,0.85);
            color: #fff;
        }
        footer {
            display: flex;
            justify-content: flex-start;
        }
        footer a {
            color: var(--nexum-accent-bright);
            text-decoration: none;
            font-weight: 600;
        }
        footer a:hover {
            text-decoration: underline;
        }
        .logged-out-card {
            display: flex;
            flex-direction: column;
            gap: 16px;
            align-items: flex-start;
        }
        .logged-out-message {
            margin: 0;
            font-size: 1.1rem;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <%- include('partials/session_banner') %>
    <%- include('partials/cookie_banner') %>
    <div class="page">
        <% if (showLoggedOutMessage) { %>
            <div class="card logged-out-card">
                <p class="logged-out-message">Log in to connect Git repositories.</p>
                <a class="button-link" href="/" role="button">Log In / Sign Up</a>
            </div>
        <% } else { %>
            <header>
                <h1>Connect Git Repository</h1>
            </header>

            <div class="card">
                <div class="meta-row">
                    <% if (showCreateRepoLink) { %>
                        <div class="meta-action">
                            <span>Or</span>
                            <a class="button-link secondary" href="/repositories/new-default">Create a New Repository</a>
                        </div>
                    <% } %>
                </div>
                <form action="/repositories/add" method="POST" id="addRepoForm">
                    <% if (cloneError) { %>
                        <div class="alert"><%= cloneError %></div>
                    <% } %>
                    <% if (sshKeyRequired) { %>
                        <div class="ssh-card">
                            <h3>Copy Git SSH public key</h3>
                            <div class="button-row">
                                <button type="button" class="secondary" id="copySshKey" disabled>Copy key</button>
                            </div>
                            <textarea
                                class="ssh-key-output"
                                id="sshPublicKey"
                                readonly
                                placeholder="Your public key will appear here after generation."
                            ></textarea>
                            <div class="ssh-status" id="sshKeyStatus">
                                Generating SSH key... For GitHub, paste the key here:
                                <a
                                    class="ssh-link"
                                    id="githubKeyLink"
                                    href="https://github.com/settings/keys"
                                    target="_blank"
                                    rel="noopener noreferrer"
                                >https://github.com/settings/keys</a>
                                <br>
                                Need help?
                                <a
                                    class="ssh-link"
                                    href="/support"
                                    target="_blank"
                                    rel="noopener noreferrer"
                                >Click here for support.</a>
                            </div>
                        </div>
                    <% } %>
                    <div class="field">
                        <label for="gitRepoURL">Git repository URL:</label>
                        <input
                            type="text"
                            id="gitRepoURL"
                            name="gitRepoURL"
                            placeholder="git@github.com:example-org/example-repo.git"
                            value="<%= gitRepoURLValue || '' %>"
                        >
                        <small>Accepted formats include SSH, HTTPS, and git+ssh URLs (e.g. git@github.com:example-org/example-repo.git, https://github.com/example-org/example-repo.git, git+ssh://git@github.com/example-org/example-repo.git).</small>
                    </div>

                    <div class="field">
                        <div class="inline-edit-row">
                            <label for="repoName">Project name:</label>
                            <div class="inline-edit-display" id="repoNameDisplay">
                                <span class="inline-edit-value" id="repoNameValue"></span>
                                <button type="button" class="icon-button" id="editRepoName" aria-label="Edit project name">
                                    <span aria-hidden="true">âœŽ</span>
                                </button>
                            </div>
                        </div>
                        <input
                            type="text"
                            id="repoName"
                            name="repoName"
                            value="<%= repoNameValue || '' %>"
                            class="inline-edit-input is-hidden"
                            required
                        >
                    </div>

                    <div class="field">
                        <div class="button-row">
                            <button type="submit">Add Repository</button>
                        </div>
                    </div>
                </form>
            </div>

            <footer>
            </footer>
        <% } %>
    </div>

    <script>
        const addRepoForm = document.getElementById('addRepoForm');
        if (addRepoForm) {
            const repoNameInput = document.getElementById('repoName');
            const gitRepoURLInput = document.getElementById('gitRepoURL');
            const repoNameDisplay = document.getElementById('repoNameDisplay');
            const repoNameValue = document.getElementById('repoNameValue');
            const editRepoNameButton = document.getElementById('editRepoName');
            const copySshKeyButton = document.getElementById('copySshKey');
            const sshPublicKeyField = document.getElementById('sshPublicKey');
            const sshKeyStatus = document.getElementById('sshKeyStatus');
            const githubKeyLinkHtml = '<a class="ssh-link" href="https://github.com/settings/keys" target="_blank" rel="noopener noreferrer">https://github.com/settings/keys</a>';
            const supportLinkHtml = '<a class="ssh-link" href="/support" target="_blank" rel="noopener noreferrer">Click here for support.</a>';
            const shouldResetInputs = <%= cloneError ? 'false' : 'true' %>;

            const getRepoNameFromUrl = (url) => {
                const trimmed = url.trim();
                if (!trimmed) {
                    return '';
                }

                const sanitized = trimmed.split('#')[0].split('?')[0];
                const patterns = [
                    /^git@[^:\s]+:([^/\s]+)\/([^/\s]+?)(\.git)?\/?$/i,
                    /^https?:\/\/[^/\s]+\/([^/\s]+)\/([^/\s]+?)(\.git)?\/?$/i,
                    /^git\+ssh:\/\/git@[^/\s]+\/([^/\s]+)\/([^/\s]+?)(\.git)?\/?$/i,
                    /^(?:www\.)?github\.com\/([^/\s]+)\/([^/\s]+?)(\.git)?\/?$/i,
                ];

                for (const pattern of patterns) {
                    const match = sanitized.match(pattern);
                    if (match) {
                        return match[2];
                    }
                }

                return '';
            };

            const updateRepoNameDisplay = () => {
                const trimmedValue = repoNameInput.value.trim();
                if (trimmedValue) {
                    repoNameValue.textContent = trimmedValue;
                    repoNameValue.classList.remove('placeholder');
                    if (editRepoNameButton) {
                        editRepoNameButton.classList.remove('is-hidden');
                    }
                    return;
                }

                repoNameValue.textContent = 'Not set';
                repoNameValue.classList.add('placeholder');
                if (editRepoNameButton) {
                    editRepoNameButton.classList.add('is-hidden');
                }
            };

            const showRepoNameReadOnly = () => {
                repoNameInput.setAttribute('readonly', 'readonly');
                repoNameInput.classList.add('is-hidden');
                repoNameDisplay.classList.remove('is-hidden');
            };

            const showRepoNameEditor = () => {
                repoNameInput.removeAttribute('readonly');
                repoNameInput.classList.remove('is-hidden');
                repoNameDisplay.classList.add('is-hidden');
                repoNameInput.focus();
                repoNameInput.select();
            };

            const clearFormInputs = () => {
                repoNameInput.value = '';
                gitRepoURLInput.value = '';
                repoNameInput.removeAttribute('aria-invalid');
                updateRepoNameDisplay();
                showRepoNameReadOnly();
            };

            window.addEventListener('pageshow', () => {
                if (shouldResetInputs) {
                    clearFormInputs();
                }
            });

            updateRepoNameDisplay();
            showRepoNameReadOnly();

            let repoNameEdited = Boolean(repoNameInput.value.trim());

            repoNameInput.addEventListener('input', () => {
                repoNameEdited = repoNameInput.value.trim().length > 0;
                if (repoNameInput.value.trim()) {
                    repoNameInput.removeAttribute('aria-invalid');
                }
                updateRepoNameDisplay();
            });

            if (editRepoNameButton) {
                editRepoNameButton.addEventListener('click', () => {
                    repoNameEdited = true;
                    showRepoNameEditor();
                });
            }

            gitRepoURLInput.addEventListener('input', () => {
                if (repoNameEdited) {
                    return;
                }

                const derivedName = getRepoNameFromUrl(gitRepoURLInput.value);
                if (derivedName) {
                    repoNameInput.value = derivedName;
                    repoNameInput.removeAttribute('aria-invalid');
                } else {
                    repoNameInput.value = '';
                }
                updateRepoNameDisplay();
            });

            const convertHttpsToSsh = (url) => {
                const trimmed = url.trim();
                if (!trimmed) {
                    return trimmed;
                }

                const sanitized = trimmed.split('#')[0].split('?')[0];
                const httpsMatch = sanitized.match(/^https?:\/\/([^/\s]+)\/([^/\s]+)\/([^/\s]+?)(\.git)?\/?$/i);
                const bareMatch = sanitized.match(/^(?:www\.)?([^/\s]+)\/([^/\s]+)\/([^/\s]+?)(\.git)?\/?$/i);
                const match = httpsMatch || bareMatch;
                if (!match) {
                    return trimmed;
                }

                const host = match[1];
                const owner = match[2];
                const repo = match[3];
                return `git@${host}:${owner}/${repo}.git`;
            };

            addRepoForm.addEventListener('submit', () => {
                const convertedUrl = convertHttpsToSsh(gitRepoURLInput.value);
                if (convertedUrl !== gitRepoURLInput.value.trim()) {
                    gitRepoURLInput.value = convertedUrl;
                }

                if (!repoNameInput.value.trim()) {
                    repoNameInput.setAttribute('aria-invalid', 'true');
                    showRepoNameEditor();
                }
            });

            const setSshStatus = (message, includeLink = false) => {
                if (!sshKeyStatus) {
                    return;
                }
                if (includeLink) {
                    sshKeyStatus.innerHTML = `${message} For GitHub, paste the key here: ${githubKeyLinkHtml}<br>Need help? ${supportLinkHtml}`;
                } else {
                    sshKeyStatus.textContent = message;
                }
            };

            const generateSshKey = async () => {
                if (!sshKeyStatus || !sshPublicKeyField || !copySshKeyButton) {
                    return;
                }
                setSshStatus('Generating SSH key...', true);
                try {
                    const response = await fetch('/repositories/generate-ssh-key', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                    });
                    const payload = await response.json();
                    if (!response.ok) {
                        throw new Error(payload.error || 'Unable to generate SSH key.');
                    }
                    sshPublicKeyField.value = payload.publicKey || '';
                    copySshKeyButton.disabled = !sshPublicKeyField.value;
                    const generatedMessage = payload.addedToAgent
                        ? 'SSH key generated and added to the agent.'
                        : 'SSH key generated.';
                    setSshStatus(generatedMessage, true);
                } catch (error) {
                    setSshStatus(error.message);
                }
            };

            if (sshPublicKeyField && sshKeyStatus) {
                generateSshKey();
            }

            if (copySshKeyButton) {
                copySshKeyButton.addEventListener('click', async () => {
                    if (!sshPublicKeyField.value) {
                        return;
                    }
                    try {
                        await navigator.clipboard.writeText(sshPublicKeyField.value);
                        setSshStatus('SSH key copied to clipboard.', true);
                    } catch (error) {
                        setSshStatus('Copy failed. Select the key text and copy manually.', true);
                    }
                });
            }
        }
    </script>
</body>
</html>
