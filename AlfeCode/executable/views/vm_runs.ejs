<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>AlfeCode Â· VM Runs</title>
    <link rel="stylesheet" href="/styles.css">
    <style>
        :root {
            color-scheme: dark;
        }
        body {
            margin: 0;
            background: radial-gradient(circle at top left, rgba(59,130,246,0.25), transparent 45%),
                radial-gradient(circle at 80% 10%, rgba(129,140,248,0.2), transparent 45%),
                #020617;
            font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            color: #e2e8f0;
        }
        .vm-page {
            min-height: 100vh;
            padding: 40px 32px 60px;
            max-width: 1200px;
            margin: 0 auto;
        }
        .vm-header {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: flex-start;
            gap: 16px;
            margin-bottom: 28px;
        }
        .vm-clone-card {
            background: rgba(15, 23, 42, 0.7);
            border: 1px solid rgba(148, 163, 184, 0.2);
            border-radius: 20px;
            padding: 24px;
            margin-bottom: 28px;
            box-shadow: 0 18px 50px rgba(2, 6, 23, 0.45);
        }
        .vm-clone-header {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            gap: 16px;
            margin-bottom: 18px;
        }
        .vm-clone-header h2 {
            margin: 0;
            font-size: 1.6rem;
        }
        .vm-clone-header p {
            margin: 8px 0 0;
            color: #94a3b8;
            max-width: 720px;
        }
        .vm-clone-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 12px;
        }
        .vm-clone-status {
            margin-top: 12px;
            min-height: 1.4rem;
            color: #fcd34d;
            font-weight: 500;
        }
        .vm-header-actions {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 12px;
        }
        .vm-input,
        .vm-select {
            background: rgba(15, 23, 42, 0.9);
            border: 1px solid rgba(148, 163, 184, 0.4);
            color: #e2e8f0;
            padding: 0.65rem 0.75rem;
            border-radius: 10px;
            min-width: 180px;
        }
        .vm-select {
            min-width: 140px;
        }
        .vm-header h1 {
            margin: 0;
            font-size: 2.2rem;
            letter-spacing: 0.03em;
        }
        .vm-header p {
            margin: 8px 0 0;
            color: #94a3b8;
            max-width: 640px;
            line-height: 1.4;
        }
        .primary-action {
            border: none;
            background: linear-gradient(135deg, #6366f1, #22d3ee);
            color: #020617;
            padding: 0.9rem 1.75rem;
            border-radius: 999px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 15px 40px rgba(13, 42, 148, 0.4);
            transition: transform 0.15s ease, box-shadow 0.15s ease;
        }
        .primary-action:disabled {
            opacity: 0.6;
            cursor: progress;
            box-shadow: none;
        }
        .primary-action:not(:disabled):hover {
            transform: translateY(-2px);
            box-shadow: 0 18px 45px rgba(13, 42, 148, 0.5);
        }
        .vm-status {
            min-height: 1.5rem;
            margin-bottom: 24px;
            color: #fcd34d;
            font-weight: 500;
        }
        .vm-table-wrapper {
            background: rgba(15, 23, 42, 0.85);
            border-radius: 20px;
            padding: 1px;
            box-shadow: 0 20px 60px rgba(2, 6, 23, 0.55);
        }
        table.vm-table {
            width: 100%;
            border-collapse: collapse;
            border-radius: 20px;
            overflow: hidden;
            background: rgba(15, 23, 42, 0.7);
        }
        table.vm-table thead {
            background: rgba(30, 41, 59, 0.9);
        }
        table.vm-table th,
        table.vm-table td {
            padding: 14px 16px;
            font-size: 0.95rem;
            text-align: left;
            border-bottom: 1px solid rgba(148, 163, 184, 0.18);
        }
        table.vm-table th {
            font-size: 0.75rem;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            color: #94a3b8;
        }
        table.vm-table tbody tr:last-child td {
            border-bottom: none;
        }
        table.vm-table tbody tr.running {
            background: rgba(34, 197, 94, 0.08);
        }
        .vm-action-button {
            border: 1px solid rgba(148, 163, 184, 0.4);
            background: rgba(30, 41, 59, 0.8);
            color: #e2e8f0;
            padding: 6px 12px;
            border-radius: 999px;
            font-size: 0.8rem;
            cursor: not-allowed;
        }
        small.status-note {
            display: block;
            margin-top: 4px;
            color: #fda4af;
        }
        @media (max-width: 960px) {
            .vm-header h1 {
                font-size: 1.8rem;
            }
            table.vm-table th,
            table.vm-table td {
                padding: 10px 12px;
            }
        }
    </style>
</head>
<body>
    <div class="vm-page">
        <section class="vm-clone-card">
            <div class="vm-clone-header">
                <div>
                    <h2>Clone VM from Snapshot</h2>
                    <p>Launch a Lightsail clone using <code>CreateInstancesFromSnapshot</code>. Once created, the instance IP is fetched and the VM is added to the list automatically. Defaults can be set via <code>VM_CLONE_REGION</code>, <code>VM_CLONE_AVAILABILITY_ZONE</code>, <code>VM_CLONE_SNAPSHOT_NAME</code>, <code>VM_CLONE_BUNDLE_ID</code>, <code>VM_CLONE_KEY_PAIR_NAME</code>, and <code>VM_CLONE_IP_ADDRESS_TYPE</code>.</p>
                </div>
                <button id="cloneVmBtn" class="primary-action" type="button">Clone VM</button>
            </div>
            <div class="vm-clone-grid">
                <input id="cloneRegion" class="vm-input" type="text" placeholder="Region (e.g. us-west-2)" value="<%= cloneDefaults?.region || '' %>">
                <input id="cloneAz" class="vm-input" type="text" placeholder="Availability zone (e.g. us-west-2a)" value="<%= cloneDefaults?.availabilityZone || '' %>">
                <input id="cloneInstanceName" class="vm-input" type="text" placeholder="New instance name">
                <input id="cloneSnapshotName" class="vm-input" type="text" placeholder="Snapshot name" value="<%= cloneDefaults?.instanceSnapshotName || '' %>">
                <input id="cloneBundleId" class="vm-input" type="text" placeholder="Bundle ID (e.g. medium_3_0)" value="<%= cloneDefaults?.bundleId || '' %>">
                <input id="cloneKeyPairName" class="vm-input" type="text" placeholder="Key pair name (optional)" value="<%= cloneDefaults?.keyPairName || '' %>">
                <select id="cloneIpType" class="vm-select">
                    <option value="dualstack" <%= cloneDefaults?.ipAddressType === 'dualstack' ? 'selected' : '' %>>dualstack</option>
                    <option value="ipv4" <%= cloneDefaults?.ipAddressType === 'ipv4' ? 'selected' : '' %>>ipv4</option>
                </select>
            </div>
            <div id="cloneStatus" class="vm-clone-status" role="status" aria-live="polite"></div>
        </section>
        <header class="vm-header">
            <div>
                <h1>VM Runs</h1>
            </div>
            <div class="vm-header-actions">
                <input id="vmIpInput" class="vm-input" type="text" inputmode="decimal" placeholder="Public IPv4 address">
                <select id="vmStatusSelect" class="vm-select">
                    <option value="Running">Running</option>
                    <option value="Stopped">Stopped</option>
                </select>
                <button id="startVmBtn" class="primary-action" type="button">Add VM</button>
            </div>
        </header>
        <div id="vmStatus" class="vm-status" role="status" aria-live="polite"></div>
        <div class="vm-table-wrapper">
            <table class="vm-table">
                <thead>
                    <tr>
                        <th>IPv4 Address</th>
                        <th>Machine Status</th>
                        <th>User Session</th>
                        <th>Started</th>
                        <th>Last Modified</th>
                        <th>PROJECT LIST</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <% if (sessions && sessions.length) { %>
                        <% sessions.forEach((session) => { %>
                            <% const startedAt = session.startTimestamp ? new Date(session.startTimestamp).toLocaleString('en-US', { dateStyle: 'medium', timeStyle: 'short' }) : '-'; %>
                            <% const lastUsedAt = session.lastUsedTimestamp ? new Date(session.lastUsedTimestamp).toLocaleString('en-US', { dateStyle: 'medium', timeStyle: 'short' }) : '-'; %>
                            <% const projectList = session.projectList && Object.keys(session.projectList).length ? JSON.stringify(session.projectList) : '-'; %>
                            <tr class=<%= session.machineStatus === 'Running' ? 'running' : '' %>>
                                <td><%= session.ipAddress %></td>
                                <td>
                                    <span><%= session.machineStatus || '-' %></span>
                                    <% if (session.errorMessage) { %>
                                        <small class="status-note"><%= session.errorMessage %></small>
                                    <% } %>
                                </td>
                                <td><%= session.userSessionId || '-' %></td>
                                <td><%= startedAt %></td>
                                <td><%= lastUsedAt %></td>
                                <td><%= projectList %></td>
                                <td><button class="vm-action-button" type="button" disabled>Restart</button></td>
                            </tr>
                        <% }); %>
                    <% } else { %>
                        <tr>
                            <td colspan="7" style="text-align:center;color:#94a3b8;">No VMs have been added yet.</td>
                        </tr>
                    <% } %>
                </tbody>
            </table>
        </div>
    </div>
    <script>
        (function () {
            const button = document.getElementById('startVmBtn');
            const statusEl = document.getElementById('vmStatus');
            const ipInput = document.getElementById('vmIpInput');
            const statusSelect = document.getElementById('vmStatusSelect');
            const cloneButton = document.getElementById('cloneVmBtn');
            const cloneStatusEl = document.getElementById('cloneStatus');
            const cloneRegion = document.getElementById('cloneRegion');
            const cloneAz = document.getElementById('cloneAz');
            const cloneInstanceName = document.getElementById('cloneInstanceName');
            const cloneSnapshotName = document.getElementById('cloneSnapshotName');
            const cloneBundleId = document.getElementById('cloneBundleId');
            const cloneKeyPairName = document.getElementById('cloneKeyPairName');
            const cloneIpType = document.getElementById('cloneIpType');

            function isValidIpv4(ip) {
                if (!ip) {
                    return false;
                }
                const parts = ip.trim().split('.');
                if (parts.length !== 4) {
                    return false;
                }
                return parts.every((segment) => {
                    if (!/^\d{1,3}$/.test(segment)) {
                        return false;
                    }
                    const value = Number(segment);
                    return value >= 0 && value <= 255;
                });
            }

            async function addVm() {
                const ipAddress = ipInput.value.trim();
                const machineStatus = statusSelect.value;
                if (!isValidIpv4(ipAddress)) {
                    statusEl.textContent = 'Enter a valid public IPv4 address before adding.';
                    return;
                }
                button.disabled = true;
                statusEl.textContent = 'Adding VM...';
                try {
                    const response = await fetch('/vm_runs/start', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ ipAddress, machineStatus }),
                    });
                    const payload = await response.json();
                    if (!response.ok || !payload.ok) {
                        throw new Error(payload.error || payload.message || 'Unable to add VM');
                    }
                    statusEl.textContent = `VM ${payload.session.ipAddress} added. Reloading...`;
                    ipInput.value = '';
                    statusSelect.value = 'Running';
                    setTimeout(() => window.location.reload(), 800);
                } catch (err) {
                    const message = err.message || 'Failed to add VM';
                    statusEl.textContent = message;
                } finally {
                    button.disabled = false;
                }
            }

            async function cloneVm() {
                const region = cloneRegion.value.trim();
                const availabilityZone = cloneAz.value.trim();
                const instanceName = cloneInstanceName.value.trim();
                const instanceSnapshotName = cloneSnapshotName.value.trim();
                const bundleId = cloneBundleId.value.trim();
                const keyPairName = cloneKeyPairName.value.trim();
                const ipAddressType = cloneIpType.value;

                if (!region || !availabilityZone || !instanceName || !instanceSnapshotName || !bundleId) {
                    cloneStatusEl.textContent = 'Region, availability zone, instance name, snapshot name, and bundle ID are required.';
                    return;
                }

                cloneButton.disabled = true;
                cloneStatusEl.textContent = 'Cloning VM from snapshot...';
                try {
                    const response = await fetch('/vm_runs/clone', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            region,
                            availabilityZone,
                            instanceName,
                            instanceSnapshotName,
                            bundleId,
                            keyPairName,
                            ipAddressType,
                        }),
                    });
                    const payload = await response.json();
                    if (!response.ok || !payload.ok) {
                        throw new Error(payload.error || payload.message || 'Unable to clone VM');
                    }
                    cloneStatusEl.textContent = `Clone created for ${payload.instance.name}. IP: ${payload.instance.ipAddress}. Reloading...`;
                    setTimeout(() => window.location.reload(), 1200);
                } catch (err) {
                    const message = err.message || 'Failed to clone VM';
                    cloneStatusEl.textContent = message;
                } finally {
                    cloneButton.disabled = false;
                }
            }

            button.addEventListener('click', addVm);
            cloneButton.addEventListener('click', cloneVm);
        })();
    </script>
</body>
</html>
