<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Alfe: <%= gitRepoNameCLI %><% if (debugMode) { %> DEV<% } %> | <%= aiModel %></title>
    <link id="favicon" rel="icon" href="/alfe_favicon.ico">
    <link
      rel="alternate icon"
      href="/alfe_favicon.ico"
      type="image/x-icon"
    >
    <link rel="stylesheet" href="/styles.css">
    <link rel="stylesheet" href="/CSS/chat.css">
    <script src="https://d3js.org/d3.v5.min.js"></script>
</head>
<body class="aurora-theme">
<%- include('partials/session_banner') %>
<div class="app-shell">
<aside id="sidebar" class="sidebar-panel">
    
<div class="sidebar-header">
    <div class="sidebar-brand-icon">
        <a href="https://app.alfe.sh" target="_blank" rel="noopener noreferrer"><img src="/alfe_favicon_chat_mountain_rect_purple_WHITEBG_64x64.png" alt="Alfe AI logo">
    </a></div>
    <div class="sidebar-brand-text">
        <h1 class="sidebar-brand-heading">
            <% if (environment !== 'unknown') { %>
                <span class="environment-indicator <%= environment %>"><%= environment %>:</span>
            <% } %>
            <a href="https://app.alfe.sh" class="sidebar-brand-name" target="_blank" rel="noopener noreferrer">
                <% if (debugMode) { %>
                    <span style="color:red;">Alfe AI</span>
                <% } else { %>
                    Alfe AI
                <% } %>
            </a>
        </h1>
        <% if (appVersion) { %>
            <p class="sidebar-version"><%= appVersion %></p>
        <% } %>
        <p class="breadcrumb">
            <a href="/agent/<%= gitRepoNameCLI %>" target="_blank">
                <%= gitRepoNameCLI %> Chats
            </a>
        </p>
        <p class="breadcrumb">
            <button
                type="button"
                class="github-link-button"
                onclick="window.open('<%= githubURL %>', '_blank', 'noopener,noreferrer');"
            >
                GitHub
                <span aria-hidden="true" class="github-link-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 256 256" focusable="false">
                        <g weight="bold">
                            <path d="M212.62,75.17A63.7,63.7,0,0,0,206.39,26,12,12,0,0,0,196,20a63.71,63.71,0,0,0-50,24H126A63.71,63.71,0,0,0,76,20a12,12,0,0,0-10.39,6,63.7,63.7,0,0,0-6.23,49.17A61.5,61.5,0,0,0,52,104v8a60.1,60.1,0,0,0,45.76,58.28A43.66,43.66,0,0,0,92,192v4H76a20,20,0,0,1-20-20,44.05,44.05,0,0,0-44-44,12,12,0,0,0,0,24,20,20,0,0,1,20,20,44.05,44.05,0,0,0,44,44H92v12a12,12,0,0,0,24,0V192a20,20,0,0,1,40,0v40a12,12,0,0,0,24,0V192a43.66,43.66,0,0,0-5.76-21.72A60.1,60.1,0,0,0,220,112v-8A61.5,61.5,0,0,0,212.62,75.17ZM196,112a36,36,0,0,1-36,36H112a36,36,0,0,1-36-36v-8a37.87,37.87,0,0,1,6.13-20.12,11.65,11.65,0,0,0,1.58-11.49,39.9,39.9,0,0,1-.4-27.72,39.87,39.87,0,0,1,26.41,17.8A12,12,0,0,0,119.82,68h32.35a12,12,0,0,0,10.11-5.53,39.84,39.84,0,0,1,26.41-17.8,39.9,39.9,0,0,1-.4,27.72,12,12,0,0,0,1.61,11.53A37.85,37.85,0,0,1,196,104Z"></path>
                        </g>
                    </svg>
                </span>
            </button>
        </p>
        <p class="breadcrumb">
            <a href="/<%= gitRepoNameCLI %>/diff">
                Diff
            </a>
        </p>
    </div>
</div>


    <div class="sidebar-action-buttons">
            <% if (editorEnabled) { %>
        <button
            id="openEditorButton"
            class="sidebar-button"
            onclick="window.open('/<%= gitRepoNameCLI %>/chat/<%= chatNumber %>/editor', '_blank')">
            Open in Editor
        </button>
    <% } %>
        <button
            id="openFileTreeButton"
            class="sidebar-button"
            onclick="window.open('/<%= gitRepoNameCLI %>/chat/<%= chatNumber %>/file-tree', '_blank')">
            File Tree
        </button>
        <% if (sterlingCodexLink) { %>
        <button
            type="button"
            class="sidebar-button open-agent-purple"
            onclick='window.open(<%- JSON.stringify(sterlingCodexLink) %>, "_blank", "noopener,noreferrer");' class='sidebar-button open-agent-purple'>
            Open in Agent
        </button>
        <% } %>
    </div>

    <button id="gitUpdatePullButton">git update/pull</button>

    <div class="collapsible-section collapsed repo-metadata">
        <div class="collapsible-header">
            <span class="triangle"></span>
            <h3>Metadata</h3>
        </div>
        <div class="collapsible-content">
            <ul class="metadata-list">
                <li class="metadata-item">
                    <span class="metadata-label">Commit Timestamp</span>
                    <span class="metadata-value"><%= gitTimestamp %></span>
                </li>
                <li class="metadata-item">
                    <span class="metadata-label">Branch</span>
                    <span class="metadata-value metadata-branch">
                        <span><%= gitBranchName %></span>
                        <button id="switchBranchButton" type="button">Switch Branch</button>
                    </span>
                </li>
            </ul>
        </div>
    </div>

    <div style="margin-top: 1em;">
        <form action="/<%= gitRepoNameCLI %>/chat/<%= chatNumber %>/toggle_push_after_commit" method="POST">
            <label>
                <input type="checkbox" name="pushAfterCommit" <%= chatData.pushAfterCommit ? 'checked' : '' %> onchange="this.form.submit()">
                Push after commit
            </label>
        </form>
    </div>

    <!-- Form to add additional repos -->
    <div style="margin: 1em 0;">
        <h3>Add Another Repo</h3>
        <% if (possibleReposToAdd.length === 0) { %>
            <p style="font-size: 0.9em;">No more repos to attach.</p>
        <% } else { %>
            <form action="/<%= gitRepoNameCLI %>/chat/<%= chatNumber %>/add_other_repo" method="POST">
                <select name="otherRepoName">
                    <% possibleReposToAdd.forEach(function(r){ %>
                        <option value="<%= r %>"><%= r %></option>
                    <% }); %>
                </select>
                <button type="submit">Attach Repo</button>
            </form>
        <% } %>
    </div>

    <div class="collapsible-section expanded">
        <div class="collapsible-header">
            <span class="triangle"></span>
            <h3>Main Repo: <%= gitRepoNameCLI %></h3>
        </div>
        <div class="collapsible-content directory-tree" data-repo="<%= gitRepoNameCLI %>">
            <%- directoryTreeHTML %>
        </div>
    </div>

    <% additionalReposTrees.forEach(function(rep) { %>
        <div class="collapsible-section collapsed">
            <div class="collapsible-header">
                <span class="triangle"></span>
                <h3>Attached Repo: <%= rep.repoName %></h3>
            </div>
            <div class="collapsible-content directory-tree" data-repo="<%= rep.repoName %>">
                <%- rep.directoryTreeHTML %>
            </div>
        </div>
    <% }); %>

    <!-- Version info at bottom left -->
    <div style="margin-top: 1em; font-size: 0.9em; color: #ccc;">
        <p class="repo-local-path"><strong>Alfe Sterling CWD:</strong> <%= appCWD %></p>
        <p class="repo-revision"><strong>Alfe Revision:</strong> <%= gitRevision %></p>
        <p class="repo-git-tag"><strong>Latest Git Tag:</strong> <%= gitTag %></p>
    </div>
    <script>
      (function(){
        try {
          var pathname = (typeof window !== 'undefined' && window.location && window.location.pathname) ? window.location.pathname : '';
          var isAgentExperience = pathname.indexOf('/environment') === 0 || pathname.indexOf('/agent') === 0;
          if (isAgentExperience) {
            document.body.classList.add('agent-route');
            document.documentElement.classList.add('agent-scale-80');
            document.querySelectorAll('.repo-local-path').forEach(function(el){ el.remove(); });
          }
        } catch(e) { console.error(e); }
      })();
    </script>
    </aside>

<main id="content" class="chat-panel">
    <div class="content-inner">
    <h2>
        Editing
        <a href="/<%= gitRepoNameCLI %>" target="_blank">
            <%= gitRepoNameCLI %>
        </a>
        with <%= aiModel %>,
        <a href="<%= chatGPTURL %>" target="_blank">
            chat #<%= chatNumber %>
        </a>
    </h2>

    <form id="aiModelForm" action="/set_chat_model" method="POST">
        <input type="hidden" name="gitRepoNameCLI" value="<%= gitRepoNameCLI %>">
        <input type="hidden" name="chatNumber" value="<%= chatNumber %>">
        <% include('./AIModelSelector.ejs') %>
        <div class="ai-selectors">
            <select name="aiProvider" id="aiProvider" onchange="this.form.submit()">
                <option value="openrouter" <%= chatData.aiProvider.toLowerCase() === 'openrouter' ? 'selected' : '' %>>OpenRouter</option>
                <option value="litellm" <%= chatData.aiProvider.toLowerCase() === 'litellm' ? 'selected' : '' %>>LiteLLM</option>
                <option value="deepseek api" <%= chatData.aiProvider.toLowerCase() === 'deepseek api' ? 'selected' : '' %>>DeepSeek API</option>
                <option value="deepseek local" <%= chatData.aiProvider.toLowerCase() === 'deepseek local' ? 'selected' : '' %>>DeepSeek Local</option>
            </select>
            <select name="aiModel" id="aiModel" onchange="this.form.submit()">
                <% if (AIModels && AIModels.length > 0) { %>
                    <% AIModels.forEach(function(model) { %>
                        <option value="<%= model.id %>" <%= model.id === aiModel ? 'selected' : '' %>>
                            <%= model.name || model.id %><% if (model.contextLimitLabel && model.contextLimitLabel !== 'N/A') { %> (<span class="context-limit"><%= model.contextLimitLabel %></span>)<% } %>
                        </option>
                    <% }); %>
                <% } else { %>
                    <option value="<%= aiModel %>" selected><%= aiModel %></option>
                <% } %>
            </select>
        </div>
    </form>

    <div class="collapsible-section">
        <div class="collapsible-header">
            <span class="triangle"></span>
            <h3>Metadata</h3>
        </div>
        <div class="collapsible-content">
            <p>
                <strong>Status:</strong> <%= status %>
                <% if (status === 'ACTIVE') { %>
            <form action="/<%= gitRepoNameCLI %>/chat/<%= chatNumber %>/deactivate"
                  method="POST"
                  style="display:inline;"
                  onsubmit="return confirm('Are you sure you want to deactivate this chat?');">
                <button type="submit" class="form-buttons">Deactivate</button>
            </form>
            <% } %>
            <% if (status !== 'ARCHIVED' && status !== 'ARCHIVED_CONTEXT') { %>
            <form action="/<%= gitRepoNameCLI %>/chat/<%= chatNumber %>/archive"
                  method="POST"
                  style="display:inline;"
                  onsubmit="return confirm('Archive this chat?');">
                <button type="submit" class="form-buttons">Archive</button>
            </form>
            <form action="/<%= gitRepoNameCLI %>/chat/<%= chatNumber %>/archive_plain"
                  method="POST"
                  style="display:inline;"
                  onsubmit="return confirm('Archive without context?');">
                <button type="submit" class="form-buttons">Archive Only</button>
            </form>
            <% } else { %>
            <form action="/<%= gitRepoNameCLI %>/chat/<%= chatNumber %>/unarchive"
                  method="POST"
                  style="display:inline;"
                  onsubmit="return confirm('Unarchive this chat?');">
                <button type="submit" class="form-buttons">Unarchive</button>
            </form>
            <% } %>
            </p>

            <p><strong>gitRepoNameCLI:</strong>
                <a href="<%= githubURL %>" target="_blank"><%= gitRepoNameCLI %></a>
            </p>
            <p><strong>gitRepoLocalPath:</strong>
                <a href="file://<%= gitRepoLocalPath.replace(/\\/g, '/') %>" target="_blank">
                    <%= gitRepoLocalPath %>
                </a>
            </p>
            <p><strong>githubURL:</strong>
                <a href="<%= githubURL %>" target="_blank"><%= githubURL %></a>
            </p>
            <br/>
            <p><strong>AI Model:</strong> <%= aiModel %></p>
            <p><strong>AI Provider:</strong> <%= chatData.aiProvider %></p>
            <p><strong>chatURL:</strong>
                <a href="<%= chatGPTURL %>" target="_blank"><%= chatGPTURL %></a>
            </p>
            <p><strong>chatNumber:</strong> <%= chatNumber %></p>
            <p><strong>openAIAccount:</strong>
                <a href="mailto:<%= openAIAccount %>"><%= openAIAccount %></a>
            </p>

            <div class="collapsible-section collapsed">
                <div class="collapsible-header">
                    <span class="triangle"></span>
                    <h3>Directory Analysis</h3>
                </div>
                <div class="collapsible-content">
                    <pre><%= directoryAnalysisText %></pre>
                </div>
            </div>

            <div class="collapsible-section collapsed">
                <div class="collapsible-header">
                    <span class="triangle"></span>
                    <h3>System Information</h3>
                </div>
                <div class="collapsible-content">
                    <pre><%= systemInformationText %></pre>
                </div>
            </div>

        </div>
    </div>

    <form id="chatForm"
          action="/<%= gitRepoNameCLI %>/chat/<%= chatNumber %>"
          method="POST"
          enctype="multipart/form-data">
        <label for="chatInput">Submit new chat input:</label><br/>
        <textarea id="chatInput" name="message" rows="5"></textarea><br/>

        <p id="tokenCountDisplay">Tokens: 0</p>

        <input type="hidden" id="chatGPTURL" name="chatGPTURL" value="<%= chatGPTURL %>">
        <input type="hidden" id="attachedFilesInput" name="attachedFiles"
               value='<%= JSON.stringify(chatData.attachedFiles || []) %>'>

        <div class="form-buttons">
            <button type="submit">Submit</button>
        </div>
    </form>
    <br/>

    <div class="collapsible-section expanded attached-files-section">
        <div class="collapsible-header">
            <span class="triangle"></span>
            <h3>Attached Files</h3>
        </div>
        <div class="collapsible-content">
            <ul id="attachedFilesList">
                <% if (chatData.attachedFiles && chatData.attachedFiles.length > 0) { %>
                    <% chatData.attachedFiles.forEach(function(file) { %>
                        <li>
                            <%= file %>
                            <button type="button" class="remove-file-button" data-file="<%= file %>">Remove</button>
                        </li>
                    <% }); %>
                <% } %>
            </ul>

            <form action="/<%= gitRepoNameCLI %>/chat/<%= chatNumber %>/save_state" method="POST">
                <input type="hidden" id="attachedFilesInputSaveState" name="attachedFiles" value="">
                <label for="stateName">State Name:</label>
                <input type="text" id="stateName" name="stateName" required>
                <div class="form-buttons">
                    <button type="submit">Save State</button>
                </div>
            </form>

            <form action="/<%= gitRepoNameCLI %>/chat/<%= chatNumber %>/load_state" method="POST">
                <label for="loadStateName">Load State:</label>
                <select id="loadStateName" name="stateName" required>
                    <% for (const sName in chatData.savedStates) { %>
                        <option value="<%= sName %>"><%= sName %></option>
                    <% } %>
                </select>
                <div class="form-buttons">
                    <button type="submit">Load State</button>
                </div>
            </form>
        </div>
    </div>

    <div class="tabs">
        <div class="tab-buttons">
            <button class="tablink active" data-tab="gitTreeTab">Git Commits</button>
            <button class="tablink" data-tab="gitLogTab">Git Log</button>
            <button class="tablink" data-tab="chatHistoryTab">Chat History</button>
            <button class="tablink" data-tab="outputFilesTab">Output Files</button>
            <button class="tablink" data-tab="summaryTab">Summaries</button>
        </div>

        <div id="gitTreeTab" class="tab-content active">
            <h3>Git Commits</h3>
            <ul>
                <% gitCommits.forEach(function(commit) { %>
                    <li><%= commit %></li>
                <% }); %>
            </ul>
        </div>

        <div id="gitLogTab" class="tab-content">
                        <div id="gitLogContainer"></div>
        </div>

        <div id="chatHistoryTab" class="tab-content">
            <form action="/<%= gitRepoNameCLI %>/chat/<%= chatNumber %>/delete_history" method="POST" onsubmit="return confirm('Are you sure you want to delete the chat history?');">
                <button type="submit" class="form-buttons">Delete Chat History</button>
            </form>

            <% if (!chatData.chatHistory || chatData.chatHistory.length === 0) { %>
                <p>No chat history available.</p>
            <% } else { %>
                <% const reversed = chatData.chatHistory.slice().reverse(); %>
                <% reversed.forEach(function(msg, index) { %>
                    <% const originalIndex = chatData.chatHistory.length - 1 - index; %>
                    <div class="collapsible-message collapsed">
                        <div class="message-header">
                            <span class="triangle"></span>
                            <span class="sender">
                                <%= msg.role.charAt(0).toUpperCase() + msg.role.slice(1) %>
                                <% if (msg.timestamp) { %>
                                    <span class="exec-time">
                                        (<%= new Date(msg.timestamp).toLocaleString() %>)
                                    </span>
                                <% } %>
                                <% if (msg.role === 'user' && msg.messagesSent) { %>
                                    <button onclick="window.open('/<%= gitRepoNameCLI %>/chat/<%= chatNumber %>/raw/<%= originalIndex %>', '_blank')">Raw</button>
                                    <button onclick="window.open('/<%= gitRepoNameCLI %>/chat/<%= chatNumber %>/json_viewer/<%= originalIndex %>', '_blank')">JSON Viewer</button>
                                <% } %>
                            </span>
                        </div>
                        <div class="message-content">
                            <pre><%= msg.content %></pre>
                        </div>
                    </div>
                <% }); %>
            <% } %>
        </div>

        <div id="queuedMessagesTab" class="tab-content">
            <% if (chatData.queuedMessages && chatData.queuedMessages.length > 0) { %>
                <ul>
                    <% chatData.queuedMessages.forEach(function(qMsg, i) { %>
                        <li>Message <%= i + 1 %>: <%= qMsg.message %></li>
                    <% }); %>
                </ul>
            <% } else { %>
                <p>No queued messages.</p>
            <% } %>
        </div>

        <div id="previousChatsTab" class="tab-content">
            <p>Feature under development.</p>
        </div>

        <div id="outputFilesTab" class="tab-content">
            <% if (chatData.extractedFiles && chatData.extractedFiles.length > 0) { %>
                <% chatData.extractedFiles.forEach(function(file) { %>
                    <div class="collapsible-section collapsed">
                        <div class="collapsible-header" style="background-color: #e0efff;">
                            <span class="triangle"></span>
                            <h3><%= file.filename %></h3>
                        </div>
                        <div class="collapsible-content">
                            <p><strong>Revision:</strong> <%= file.rev %></p>
                            <p><strong>Date:</strong> <%= file.dateStr %></p>
                            <pre><%= file.content %></pre>
                        </div>
                    </div>
                <% }); %>
            <% } else { %>
                <p>No output files available.</p>
            <% } %>
        </div>

        <div id="summaryTab" class="tab-content">
            <% if (!chatData.summaryHistory || chatData.summaryHistory.length === 0) { %>
                <p>No summaries available.</p>
            <% } else { %>
                <% const reversedSummaries = chatData.summaryHistory.slice().reverse(); %>
                <% reversedSummaries.forEach(function(sum, index) { %>
                    <div class="collapsible-message collapsed">
                        <div class="message-header">
                            <span class="triangle"></span>
                            <span class="sender">
                                Summary
                                <% if (sum.timestamp) { %>
                                    <span class="exec-time">
                                        (<%= new Date(sum.timestamp).toLocaleString() %>)
                                    </span>
                                <% } %>
                            </span>
                        </div>
                        <div class="message-content">
                            <pre><%= sum.content %></pre>
                        </div>
                    </div>
                <% }); %>
            <% } %>
        </div>
    </div>

    <div id="gitStatusModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Git Status</h2>
            <div class="git-status-output">
                <pre><%= chatData.gitStatus %></pre>
            </div>
        </div>
    </div>

    <!-- Switch Branch Modal -->
    <div id="switchBranchModal" class="modal">
        <div class="modal-content">
            <span class="close-switch-branch">&times;</span>
            <h2>Switch Branch</h2>
            <div id="branchSelectContainer">
                <label for="branchSelect">Select existing branch:</label>
                <select id="branchSelect"></select>
                <br><br>
                <label>
                    <input type="checkbox" id="createNewBranchCheckbox"> Create new branch
                </label>
                <br>
                <input type="text" id="newBranchName" placeholder="Enter new branch name" style="display:none;">
                <br><br>
                <button id="switchBranchSubmitButton">Switch</button>
                <div id="switchBranchMessage" style="margin-top: 1em; font-size: 0.9em;"></div>
            </div>
        </div>
    </div>

    </div>
</main>
</div>

<script src="/JS/chat.js"></script>

<!-- Favicon animation logic -->
<script>
    const sharedFavicon = "/alfe_favicon.ico";

    window.addEventListener("load", () => {
      const fav = document.getElementById("favicon");
      if (fav) {
        fav.href = sharedFavicon;
      }
    });

    const chatForm = document.getElementById("chatForm");
    if (chatForm) {
      chatForm.addEventListener("submit", () => {
        const fav = document.getElementById("favicon");
        if (fav) {
          fav.href = sharedFavicon;
        }
      });
    }
    </script>
</body>
</html>
