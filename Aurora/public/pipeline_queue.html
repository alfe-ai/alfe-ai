<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<!--  <title>Printify Pipeline Queue</title>-->
  <title>Design Production Queue</title>
  <link rel="stylesheet" href="/styles.css">
  <style>
    .img-dropdown {
      position: relative;
      min-width: 400px;
      width: 400px;
      cursor: pointer;
    }
    .img-dropdown .selected {
      border: 1px solid #444;
      padding: 4px;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      background-color: #222;
    }
    .img-dropdown .selected img {
      max-height: 240px;
    }
    .img-dropdown .options {
      position: absolute;
      left: 0;
      right: 0;
      top: 100%;
      background-color: #222;
      border: 1px solid #444;
      max-height: 600px;
      overflow-y: auto;
      width: 400px;
      z-index: 1000;
      display: none;
    }
    .img-dropdown .option {
      padding: 4px;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .img-dropdown .option img {
      max-height: 240px;
    }
    .img-dropdown .option:hover {
      background-color: #333;
    }
    .img-dropdown .hide-btn {
      margin-left: auto;
      background: none;
      border: 1px solid #444;
      color: #f33;
      cursor: pointer;
      padding: 2px 4px;
    }
    .upscaled-label {
      color: cyan;
      margin-left: 0.25rem;
    }
    .status-success {
      color: #0f0;
    }
    .status-failed {
      color: #f33;
    }
    .db-group td {
      background-color: #333;
      color: cyan;
      font-weight: bold;
    }
  </style>
</head>
<body style="padding:1rem;">
<!--  <h2>Printify Pipeline Queue</h2>-->
<h2>Design Production Queue</h2>
  <p><a href="/">‚Üê Back to tasks</a></p>
  <div id="addJob" style="margin-bottom:1rem;display:flex;align-items:center;gap:0.5rem;">
    <label>Type:
      <select id="jobType">
        <option value="upscale">Upscale</option>
        <option value="printify">Printify</option>
        <option value="printifyTitleFix">Printify Title Fix</option>
        <option value="printifyFixMockups">Printify Fix Mockups</option>
        <option value="printifyFinalize">Printify Finalize</option>
        <option value="all">All</option>
      </select>
    </label>
    <label>Image:
      <div id="imageSelect" class="img-dropdown">
        <div class="selected">-- choose --</div>
        <div class="options"></div>
      </div>
    </label>
    <img id="imagePreview" style="display:none;max-height:80px;border:1px solid #444;" />
    <div id="variantChoice" style="display:none;flex-direction:column;margin-left:0.5rem;">
      <label style="display:block;margin-bottom:0.25rem;">
        <input type="radio" id="choiceQueueNormal" name="queueVariant" value="normal" />
        Use 4096 image:
        <span id="queueNormalPath"></span>
      </label>
      <label style="display:block;">
        <input type="radio" id="choiceQueueNobg" name="queueVariant" value="nobg" />
        Use 4096 no background:
        <span id="queueNobgPath"></span>
      </label>
    </div>
    <button id="enqueueBtn">Add to Queue</button>
    <button id="stopAllBtn" style="margin-left:0.5rem;">Stop All</button>
  </div>
  <table id="queueTable">
    <thead>
      <tr>
        <th>ID</th>
        <th>DB ID</th>
        <th>Type</th>
        <th>Variant</th>
        <th>Status</th>
        <th>Job ID</th>
        <th>Result Path</th>
        <th>Product URL</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <script src="/session.js"></script>
  <script>
    async function loadQueue(){
      try{
        const res = await fetch('/api/pipelineQueue');
        const queue = await res.json();
        const tbody = document.querySelector('#queueTable tbody');
        tbody.innerHTML = '';
        const seen = new Set();
        queue.forEach(job => {
          if(job.dbId && !seen.has(job.dbId)){
            seen.add(job.dbId);
            const groupTr = document.createElement('tr');
            groupTr.className = 'db-group';
            groupTr.innerHTML = `<td colspan="9">DB ID: ${job.dbId} <button class="removeDbBtn" data-dbid="${job.dbId}" style="margin-left:0.5rem;">Remove All</button></td>`;
            tbody.appendChild(groupTr);
            groupTr.querySelector('.removeDbBtn').addEventListener('click', async () => {
              await removeJobsByDbId(job.dbId);
            });
          }

          const tr = document.createElement('tr');
          const jobLink = job.jobId ? `<a href="jobs.html?jobId=${job.jobId}" target="_blank">${job.jobId}</a>` : '';
          const dbLink = job.dbId
            ? `<a href="/Image.html?file=${encodeURIComponent(job.file)}" target="_blank">${job.dbId}</a>`
            : '';
          const statusHtml = (() => {
            if(job.status === 'running') return 'Running <span class="loading-spinner"></span>';
            if(job.status === 'finished') return '<span class="status-success">Finished</span>';
            if(job.status === 'failed' || job.status === 'error') return '<span class="status-failed">Failed</span>';
            return job.status;
          })();
          tr.innerHTML = `
            <td>${job.id}</td>
            <td>${dbLink}</td>
            <td>${job.type}</td>
            <td>${job.variant || ''}</td>
            <td>${statusHtml}</td>
            <td>${jobLink}</td>
            <td>${job.resultPath || ''}</td>
            <td>${job.productUrl ? `<a href="${job.productUrl}" target="_blank">${job.productUrl}</a>` : ''}</td>
            <td><button data-id="${job.id}" class="removeBtn">Remove</button></td>
          `;
          tbody.appendChild(tr);
          tr.querySelector('.removeBtn').addEventListener('click', async () => {
            await removeJob(job.id);
          });
        });
      }catch(e){
        console.error('Failed to load queue', e);
      }
    }
    const dropdown = document.getElementById('imageSelect');
    const selectedDiv = dropdown.querySelector('.selected');
    const optionsDiv = dropdown.querySelector('.options');

    let imgOffset = 0;
    let imgHasMore = true;
    let imgLoading = false;

    async function loadImages(reset=false){
      if(imgLoading) return;
      if(reset){
        imgOffset = 0;
        imgHasMore = true;
        optionsDiv.innerHTML = '';
        dropdown.dataset.value = '';
        dropdown.dataset.id = '';
        selectedDiv.textContent = '-- choose --';
      }
      if(!imgHasMore) return;
      imgLoading = true;
      try{
        const res = await fetch('/api/upload/list?sessionId=' + encodeURIComponent(sessionId) + `&limit=20&offset=${imgOffset}&showHidden=0`);
        const files = await res.json();
        files.forEach(f => {
          const item = document.createElement('div');
          item.className = 'option';
          item.dataset.value = f.name;
          item.dataset.id = f.id ?? '';
          const idx = (f.id !== null && f.id !== undefined) ? f.id : '';
          const upscaled = f.status && /upscaled/i.test(f.status);
          const label = upscaled ? '<span class="upscaled-label">[upscaled]</span>' : '';
          item.innerHTML = `<img src="/uploads/${encodeURIComponent(f.name)}" /> <span>${idx}${label}</span> <button class="hide-btn">Hide</button>`;
          const hideBtn = item.querySelector('.hide-btn');
          hideBtn.addEventListener('click', async ev => {
            ev.stopPropagation();
            try{
              await fetch('/api/upload/hidden', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name: f.name, hidden: true })
              });
              item.remove();
            }catch(err){
              console.error('Failed to hide image', err);
            }
          });
          item.addEventListener('click', () => {
            selectedDiv.innerHTML = `<img src="/uploads/${encodeURIComponent(f.name)}" /> <span>${idx}${label}</span>`;
            dropdown.dataset.value = f.name;
            dropdown.dataset.id = f.id ?? '';
            optionsDiv.style.display = 'none';
            updatePreview(f.name);
            const type = document.getElementById('jobType').value;
            if(type === 'printify' || type === 'printifyPrice' || type === 'printifyTitleFix' || type === 'printifyFixMockups' || type === 'printifyFinalize' || type === 'all'){
              updateVariantUI(f.name);
            }
          });
          optionsDiv.appendChild(item);
        });
        imgOffset += files.length;
        if(files.length < 20) imgHasMore = false;
      }catch(e){
        console.error('Failed to load images', e);
      }
      imgLoading = false;
    }

    dropdown.addEventListener('click', () => {
      optionsDiv.style.display = optionsDiv.style.display === 'block' ? 'none' : 'block';
      if(optionsDiv.style.display === 'block' && optionsDiv.innerHTML === ''){
        loadImages(true);
      }
    });

    document.addEventListener('click', e => {
      if(!dropdown.contains(e.target)) optionsDiv.style.display = 'none';
    });

    optionsDiv.addEventListener('scroll', () => {
      if(optionsDiv.scrollTop + optionsDiv.clientHeight >= optionsDiv.scrollHeight - 5){
        loadImages();
      }
    });

    function updatePreview(val){
      const img = document.getElementById('imagePreview');
      if(val){
        img.src = '/uploads/' + encodeURIComponent(val);
        img.style.display = '';
      }else{
        img.style.display = 'none';
      }
    }

    document.getElementById('jobType').addEventListener('change', () => {
      const type = document.getElementById('jobType').value;
      if(type === 'printify' || type === 'printifyPrice' || type === 'printifyTitleFix' || type === 'printifyFixMockups' || type === 'printifyFinalize' || type === 'all'){
        updateVariantUI(document.getElementById('imageSelect').dataset.value);
      } else {
        document.getElementById('variantChoice').style.display = 'none';
      }
    });

async function updateVariantUI(file){
  const choiceDiv = document.getElementById('variantChoice');
  const normalRadio = document.getElementById('choiceQueueNormal');
  const nobgRadio = document.getElementById('choiceQueueNobg');
  const normalPath = document.getElementById('queueNormalPath');
  const nobgPath = document.getElementById('queueNobgPath');
  const type = document.getElementById('jobType').value;

  if(!file){
    choiceDiv.style.display = 'none';
    normalRadio.disabled = nobgRadio.disabled = true;
    normalPath.textContent = nobgPath.textContent = '';
    return;
  }
  try{
    const res = await fetch(`/api/upscale/result?file=${encodeURIComponent(file)}`);
    const data = await res.json();
    const upPath = data.url || null;
    const nbPath = data.nobgUrl || (data.url && /(?:[_-](?:no)?[-_]?bg)/i.test(data.url) ? data.url : null);
    if(upPath){
      normalPath.textContent = upPath;
      normalRadio.disabled = false;
    }else{
      normalPath.textContent = type === 'all' ? '(will be generated)' : '(not found)';
      normalRadio.disabled = type !== 'all';
    }
    if(nbPath){
      nobgPath.textContent = nbPath;
      nobgRadio.disabled = false;
    }else{
      nobgPath.textContent = type === 'all' ? '(will be generated)' : '(not found)';
      nobgRadio.disabled = type !== 'all';
    }
    if(upPath || nbPath || type === 'all'){
      choiceDiv.style.display = '';
      if(nbPath){
        nobgRadio.checked = true;
      } else if(type === 'all'){
        nobgRadio.checked = true;
        normalRadio.checked = false;
      } else if(upPath){
        normalRadio.checked = true;
      } else {
        normalRadio.checked = nobgRadio.checked = false;
      }
    }else{
      choiceDiv.style.display = 'none';
    }
  }catch(e){
    console.error('Failed to check variant paths', e);
    choiceDiv.style.display = 'none';
  }
}

    document.getElementById('enqueueBtn').addEventListener('click', async () => {
      const file = document.getElementById('imageSelect').dataset.value;
      const dbId = document.getElementById('imageSelect').dataset.id;
      const type = document.getElementById('jobType').value;
      const variantChoice = document.querySelector('input[name="queueVariant"]:checked');
      const variant = variantChoice ? variantChoice.value : null;
      if(!file) return;
      try{
        if(type === 'all'){
          const steps = ['upscale','printify','printifyTitleFix','printifyFixMockups','printifyFinalize'];
          for(const step of steps){
            await fetch('/api/pipelineQueue', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ file, type: step, dbId, variant })
            });
          }
        } else {
          await fetch('/api/pipelineQueue', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ file, type, dbId, variant })
          });
        }
        await loadQueue();
      }catch(e){
        console.error('Failed to enqueue job', e);
      }
    });

    async function removeJob(id){
      try{
        await fetch(`/api/pipelineQueue/${id}`, { method: 'DELETE' });
        await loadQueue();
      }catch(e){
        console.error('Failed to remove job', e);
      }
    }

    async function removeJobsByDbId(dbId){
      try{
        await fetch(`/api/pipelineQueue/db/${encodeURIComponent(dbId)}`, { method: 'DELETE' });
        await loadQueue();
      }catch(e){
        console.error('Failed to remove jobs', e);
      }
    }

    document.getElementById('stopAllBtn').addEventListener('click', async () => {
      if(!confirm('Stop all jobs?')) return;
      try{
        await fetch('/api/pipelineQueue/stopAll', { method: 'POST' });
        await loadQueue();
      }catch(e){
        console.error('Failed to stop all jobs', e);
      }
    });

    loadQueue();
    loadImages(true);
    document.getElementById('jobType').dispatchEvent(new Event('change'));
    setInterval(loadQueue, 5000);
  </script>
</body>
</html>
