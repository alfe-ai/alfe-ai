<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Jobs Log</title>
  <link rel="stylesheet" href="/styles.css">
  <link
    id="favicon"
    rel="icon"
    type="image/svg+xml"
    href="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'><polygon points='32,4 4,60 60,60' fill='black' /></svg>"
  >
</head>
<body style="padding:1rem;">
  <h2>Jobs Log</h2>
  <table id="historyTable">
    <thead>
      <tr>
        <th>ID</th>
        <th>DB ID</th>
        <th>Type</th>
        <th>Location</th>
        <th>Variant</th>
        <th>Start</th>
        <th>Finish</th>
        <th>Status</th>
        <th>Result Path</th>
        <th>Product URL</th>
      </tr>
    </thead>
    <tbody id="jobsList"></tbody>
  </table>
  <pre id="terminal" style="background:#000;color:#0f0;padding:0.5rem;margin-top:0.5rem;height:80vh;overflow:auto;font-family:monospace;resize:vertical;"></pre>
  <dialog id="printifyDialog" style="padding:1rem;"></dialog>
<script>
const defaultFavicon = "data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'><polygon points='32,4 4,60 60,60' fill='black' /></svg>";
const rotatingFavicon = "data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'><polygon points='10,4 58,32 10,60' fill='black' /><path d='M32,4 A28,28 0 0 1 32,60' stroke='black' stroke-width='4' fill='none'><animateTransform attributeName='transform' type='rotate' from='0 32 32' to='360 32 32' dur='1s' repeatCount='indefinite' /></path></svg>";
let favElement = document.getElementById('favicon');
if(favElement) favElement.href = defaultFavicon;
const printifyDialog = document.getElementById('printifyDialog');
if(printifyDialog){
  printifyDialog.addEventListener('click', () => printifyDialog.close());
}

let lastPrintifyMsg = '';
function checkPrintifyStatus(msg){
  if(!printifyDialog) return;
  const match = msg.match(/Product URL:\s*(https?:\/\/\S+)/i);
  if(match){
    const url = match[1];
    if(lastPrintifyMsg !== url){
      printifyDialog.innerHTML = `Printify Product URL: <a href="${url}" target="_blank">${url}</a>`;
      printifyDialog.showModal();
      lastPrintifyMsg = url;
    }
    return;
  }
  if(/setting printify product url/i.test(msg)){
    if(lastPrintifyMsg !== 'setting'){
      printifyDialog.textContent = msg.trim();
      printifyDialog.showModal();
      lastPrintifyMsg = 'setting';
    }
  }
}
function toUrl(p){
  if(!p) return null;
  const idx = p.lastIndexOf('/uploads/');
  if(idx !== -1){
    const rel = p.slice(idx + 9).split('/').map(encodeURIComponent).join('/');
    return '/uploads/' + rel;
  }
  return p;
}
async function loadJobs() {
  const res = await fetch('/api/jobHistory');
  const jobs = await res.json();
  const tbody = document.getElementById('jobsList');
  tbody.innerHTML = '';
  jobs.forEach(j => {
    const tr = document.createElement('tr');
    const startStr = j.startTime ? new Date(j.startTime).toLocaleString() : '';
    const finishStr = j.finishTime ? new Date(j.finishTime).toLocaleString() : '';
    tr.innerHTML = `
      <td>${j.id}</td>
      <td>${j.dbId || ''}</td>
      <td>${j.type || ''}</td>
      <td>${j.location || ''}</td>
      <td>${j.variant || ''}</td>
      <td>${startStr}</td>
      <td>${finishStr}</td>
      <td>${j.status}</td>
      <td>${j.resultPath ? `<a href="${toUrl(j.resultPath)}" target="_blank">${j.resultPath}</a>` : ''}</td>
      <td>${j.productUrl ? `<a href="${j.productUrl}" target="_blank">${j.productUrl}</a>` : ''}</td>
    `;
    tr.style.cursor = 'pointer';
    tr.addEventListener('click', () => openJob(j.id));
    tbody.appendChild(tr);
  });
}
let currentJobId = null;
async function openJob(id) {
  currentJobId = id;
  const term = document.getElementById('terminal');
  const logRes = await fetch(`/api/jobHistory/${id}/log`);
  term.textContent = await logRes.text();
}

loadJobs();
setInterval(loadJobs, 5000);

const params = new URLSearchParams(window.location.search);
const initialJob = params.get('jobId');
if(initialJob){
  openJob(initialJob);
}
</script>
</body>
</html>
