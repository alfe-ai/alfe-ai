<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Upscale Image to 2048x2048</title>
  <link rel="stylesheet" href="/styles.css" />
  <style>
    body { padding: 1rem; }
    #result canvas { max-width: 100%; border: 1px solid #444; }
  </style>
</head>
<body>
  <h1>Upscale Image to 2048x2048</h1>
  <input type="file" id="fileInput" accept="image/*" />
  <button id="uploadBtn">Upload & Upscale</button>
  <div id="status" style="margin-top:0.5rem;"></div>
  <div id="result" style="margin-top:1rem;"></div>
  <script src="/session.js"></script>
  <script>
    const fileInput = document.getElementById('fileInput');
    const uploadBtn = document.getElementById('uploadBtn');
    const statusDiv = document.getElementById('status');
    const resultDiv = document.getElementById('result');
    let uploadedName = null;

    uploadBtn.addEventListener('click', async () => {
      const file = fileInput.files[0];
      if (!file) { alert('Select an image first'); return; }
      statusDiv.textContent = 'Uploading...';
      const form = new FormData();
      form.append('myfile', file);
      try {
        const resp = await fetch('/api/upload', { method: 'POST', body: form });
        const data = await resp.json().catch(() => ({}));
        if (!resp.ok || !data.file) {
          statusDiv.textContent = data.error || 'Upload failed';
          return;
        }
        uploadedName = data.file.filename;
        statusDiv.textContent = 'Upscaling...';
        const upResp = await fetch('/api/upscale', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ file: uploadedName })
        });
        const upData = await upResp.json().catch(() => ({}));
        if (!upResp.ok) {
          statusDiv.textContent = upData.error || 'Upscale start failed';
          return;
        }
        pollResult();
      } catch (err) {
        statusDiv.textContent = 'Error: ' + err.message;
      }
    });

    async function pollResult() {
      try {
        const resp = await fetch('/api/upscale/result?file=' + encodeURIComponent(uploadedName));
        const data = await resp.json();
        if (data.url) {
          statusDiv.textContent = 'Processing complete.';
          showImage(data.url);
        } else {
          setTimeout(pollResult, 3000);
        }
      } catch (err) {
        statusDiv.textContent = 'Error: ' + err.message;
      }
    }

    function showImage(url) {
      const img = new Image();
      img.crossOrigin = 'anonymous';
      img.onload = () => {
        const canvas = document.createElement('canvas');
        canvas.width = 2048;
        canvas.height = 2048;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, 2048, 2048);
        canvas.toBlob(blob => {
          const dl = document.createElement('a');
          dl.href = URL.createObjectURL(blob);
          dl.download = 'upscaled_2048.png';
          dl.textContent = 'Download 2048x2048';
          resultDiv.innerHTML = '';
          resultDiv.appendChild(canvas);
          resultDiv.appendChild(document.createElement('br'));
          resultDiv.appendChild(dl);
        }, 'image/png');
      };
      img.src = url;
    }
  </script>
</body>
</html>
