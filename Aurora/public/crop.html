<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Crop Image</title>
  <link rel="stylesheet" href="/styles.css">
  <style>
    #canvas{ cursor:crosshair; max-width:100%; border:1px solid #444; }
  </style>
</head>
<body style="padding:1rem;">
  <h2>Crop Image</h2>
  <canvas id="canvas"></canvas>
  <div style="margin-top:0.5rem;">
    <button id="downloadBtn">Download Crop</button>
    <button id="resetBtn">Reset</button>
  </div>
  <img id="sourceImg" style="display:none;"/>
  <script src="/session.js"></script>
  <script>
  const params = new URLSearchParams(window.location.search);
  const file = params.get('file');
  const img = document.getElementById('sourceImg');
  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d');
  let scale = 1;
  let isDown = false;
  let cropRect = null;
  let startX=0, startY=0;

  img.onload = () => {
    const maxWidth = 800;
    scale = img.width > maxWidth ? maxWidth / img.width : 1;
    canvas.width = img.width * scale;
    canvas.height = img.height * scale;
    draw();
  };
  img.src = `/uploads/${encodeURIComponent(file)}`;

  function draw(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.drawImage(img,0,0,canvas.width,canvas.height);
    if(cropRect){
      ctx.save();
      ctx.strokeStyle = 'red';
      ctx.lineWidth = 2;
      ctx.setLineDash([6]);
      const {x,y,w,h} = cropRect;
      ctx.strokeRect(x,y,w,h);
      ctx.restore();
    }
  }

  canvas.addEventListener('mousedown',e=>{
    const r = canvas.getBoundingClientRect();
    startX = e.clientX - r.left;
    startY = e.clientY - r.top;
    isDown = true;
    cropRect = {x:startX,y:startY,w:0,h:0};
    draw();
  });
  canvas.addEventListener('mousemove',e=>{
    if(!isDown) return;
    const r=canvas.getBoundingClientRect();
    cropRect.w = (e.clientX - r.left) - startX;
    cropRect.h = (e.clientY - r.top) - startY;
    draw();
  });
  canvas.addEventListener('mouseup',()=>{ isDown=false; });
  canvas.addEventListener('mouseleave',()=>{ isDown=false; });

  document.getElementById('resetBtn').addEventListener('click',()=>{ cropRect=null; draw(); });
  document.getElementById('downloadBtn').addEventListener('click',()=>{
    if(!cropRect) return;
    const sx = Math.min(cropRect.x, cropRect.x+cropRect.w) / scale;
    const sy = Math.min(cropRect.y, cropRect.y+cropRect.h) / scale;
    const sw = Math.abs(cropRect.w) / scale;
    const sh = Math.abs(cropRect.h) / scale;
    const temp = document.createElement('canvas');
    temp.width = sw;
    temp.height = sh;
    temp.getContext('2d').drawImage(img,sx,sy,sw,sh,0,0,sw,sh);
    const a=document.createElement('a');
    a.href=temp.toDataURL('image/png');
    a.download='cropped-'+file;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
  });
  </script>
</body>
</html>

