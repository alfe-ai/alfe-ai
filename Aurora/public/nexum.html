<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Nexum Code Chat</title>
  <link id="themeStylesheet" rel="stylesheet" href="/nexum.css" />
  <link id="favicon" rel="icon" type="image/x-icon" href="/alfe_favicon_64x64.ico" />
  <style>
    .loading-spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      margin-left: 6px;
      border: 2px solid currentColor;
      border-radius: 50%;
      border-right-color: transparent;
      animation: loading-spin 0.75s linear infinite;
    }

    @keyframes loading-spin {
      to { transform: rotate(360deg); }
    }

    .page-loader {
      display: none;
      position: fixed;
      z-index: 10002;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      align-items: center;
      justify-content: center;
      color: var(--accent-light);
    }

    .page-loader.show {
      display: flex;
    }
  </style>
</head>
<body>
  <div class="app" style="display:none;">
    <img id="sidebarToggle" class="sidebar-toggle-icon" src="/alfe_favicon_64x64.ico" alt="Toggle sidebar" title="Toggle sidebar"/>
    <span id="logoText" style="position:absolute; top:12px; left:60px; font-size:1.4rem; color:var(--text-color);">Alfe AI</span>
    <a id="aboutLink" style="position:absolute; top:18px; left:130px; font-size:0.8rem; color:var(--text-color); cursor:pointer;">About</a>
    <a id="searchLink" href="https://dev.alfe.sh/search?q=" target="_blank" style="position:absolute; top:18px; left:175px; font-size:0.8rem; color:var(--text-color);">Search</a>
    <aside id="sidebar">
      <div id="tabsList" style="position:relative; top: 40px;"></div>
      <div id="archiveList" style="position:relative; top: 40px; display:none;"></div>
      <button id="newTabBtn" style="position:relative; top: 40px;">New Tab</button>
    </aside>
    <img id="collapsedSidebarLogo" src="/alfe_favicon_64x64.ico" title="Expand sidebar" alt="Alfe AI logo" style="height:32px; position:absolute; top:8px; left:8px; cursor:pointer; display:none; z-index:1000;"/>
    <span id="expandSidebarArrow" title="Expand sidebar" style="position:absolute; top:20px; left:48px; font-size:1.4rem; cursor:pointer; display:none; z-index:1000;">&raquo;</span>
    <main>
      <div id="viewTabsBar" style="display:flex;gap:0.5rem;margin-bottom:0.5rem;align-items:center;">
        <button id="viewTabChat" class="view-tab active" style="position:relative; left: 40px;">üí¨ Chat</button>
        <button id="viewTabTasks" class="view-tab" style="position:relative; left: 40px;">‚òëÔ∏è Tasks</button>
        <button id="viewTabArchive" class="view-tab" style="position:relative; left: 40px;">Archive</button>
        <button id="settingsBtn" title="Settings" style="margin-left:auto;background:none;border:none;color:#ddd;font-size:1.2rem;cursor:pointer;">&#9881;</button>
        <button id="projectNewTabBtn" title="New Chat Tab" style="background:none;border:none;color:#ddd;font-size:1.2rem;cursor:pointer;margin-left:0.5rem;">‚ûï</button>
        <button id="feedbackBtn" title="Send Feedback" style="background:none;border:none;color:#ddd;font-size:1.2rem;cursor:pointer;margin-left:0.5rem;">üìù</button>
      </div>
<!--      <h1>Nexum Chat</h1>-->
      <div id="modelInfo" style="margin-bottom:0.5rem; color:#aaa;"></div>
      <div id="chatPanel">
        <div id="suggestions"></div>
        <div id="chat"></div>
        <div id="inputArea">
          <div id="promptWrapper" style="position:relative;display:inline-block;">
            <textarea id="prompt" rows="12" placeholder="Enter your message" style="width:100%;max-width:600px;"></textarea>
            <div id="taskBtns">
              <button id="askBtn" style="display:none;">Ask</button>
              <button id="codeBtn" style="display:none;">Code</button>
              <button id="renderBtn" style="display:none;">Render</button>
            </div>
          </div>
          <button id="sendBtn"><span id="sendBtnText">Chat</span></button>
        </div>
      </div>
      <div id="taskListPanel" style="display:none;">
        <h2 style="margin:0;font-size:1.1rem;">Tasks</h2>
        <table id="tasks">
          <thead><tr id="headerRow"></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </main>
  </div>
  <div id="settingsModal">
    <div class="modal-content">
      <h3>Nexum Settings</h3>
      <div>
        <h4>Nexum Feature Flags</h4>
        <!-- Chat and task tabs are now always visible -->
        <label style="display:block;"><input type="checkbox" id="flagShowDependencies"> Show "Depends On" Column</label>
        <label style="display:block;margin-top:0.25rem;"><input type="checkbox" id="flagShowArchived"> Show Archived Chats</label>
        <label style="display:block;margin-top:0.25rem;"><input type="checkbox" id="flagShowFeedback"> Show Feedback Button</label>
        <label style="display:block;margin-top:0.25rem;"><input type="checkbox" id="flagAuroraStart"> Use Aurora for New Chat</label>
        <label style="display:block;margin-top:0.25rem;"><input type="checkbox" id="flagSplashAlways"> Always Show Splash</label>
      </div>
      <button id="closeSettingsBtn" style="margin-top:1rem;">Close</button>
    </div>
  </div>
  <div id="feedbackModal" style="display:none;" class="modal">
    <div class="modal-content">
      <h3>Send Feedback</h3>
      <label>Type:
        <select id="feedbackTypeSelect" style="width:100%;">
          <option value="feature">Feature Request</option>
          <option value="bug">Bug Report</option>
          <option value="misc">Misc</option>
        </select>
      </label>
      <textarea id="feedbackText" rows="4" style="width:100%;"></textarea>
      <div style="margin-top:1rem;text-align:right;">
        <button id="feedbackSubmitBtn">Submit</button>
        <button id="feedbackCancelBtn">Close</button>
      </div>
    </div>
  </div>
  <div id="tabConfigModal">
    <div class="modal-content">
      <h3>Tab Configuration</h3>
      <label>Project Name:<br/>
        <input type="text" id="tabProjectInput" style="width:100%;" />
      </label>
      <label style="margin-top:8px;">Git Repo SSH URL:<br/>
        <input type="text" id="tabRepoInput" style="width:100%;" />
      </label>
      <label style="margin-top:8px;">Tab Type:<br/>
        <select id="tabTypeSelect" style="width:100%;">
          <option value="chat">Chat</option>
          <option value="code">Code</option>
          <option value="design">Design</option>
          <option value="pm_agi">PM AGI</option>
          <option value="search">Search</option>
          <option value="task">Project</option>
        </select>
      </label>
      <label style="margin-top:8px;">Codex Chat URL:<br/>
        <input type="text" id="codexChatUrlInput" style="width:100%;" />
      </label>
      <button id="codexImportBtn" style="margin-top:8px;">Codex/GitHub Import</button>
      <div style="margin-top:1rem;text-align:right;">
        <button id="tabConfigSaveBtn">Save</button>
        <button id="tabConfigCancelBtn">Cancel</button>
      </div>
    </div>
  </div>
  <div id="newTabModal" style="display:none;" class="modal">
    <div class="modal-content">
      <h3>New Tab</h3>
      <div>
        <div id="newTabTypeButtons">
          <button data-type="code" class="start-type-btn selected">
            <div class="icon">üíª</div>
            <div>Code</div>
          </button>
        </div>
        <label style="margin-top:8px;">Message:<br/>
          <textarea id="newTabChatInput" rows="3" style="width:100%;" placeholder="Start chatting..."></textarea>
        </label>
        <div id="newTabRepoSection" style="margin-top:8px; display:none;">
          <label>Git Repo SSH URL:<br/>
            <input type="text" id="newTabRepoInput" style="width:100%;" />
          </label>
          <div style="font-size:0.9rem; margin-top:4px;">
            note: We will update to do setup with GitHub connector/other external connectors/self host git/ AND THE URL SPECIFICATION FOR MANUAL REMOTE WILL ALSO BE AN OPTION AT THIS STEP, BUT AT THIS POINT, IT IS THE ONLY OPTION
          </div>
        </div>
      </div>
      <div style="margin-top:1rem;text-align:right;">
        <button id="newTabCreateBtn">Create</button>
        <button id="newTabCancelBtn">Close</button>
      </div>
    </div>
  </div>
  <div id="renameTabModal" class="modal" style="display:none;">
    <div class="modal-content">
      <h3>Rename Chat</h3>
      <label>New name:<br/>
        <input type="text" id="renameTabInput" style="width:100%;" />
      </label>
      <label style="margin-top:8px;">Assign to project:<br/>
        <select id="renameProjectSelect" style="width:100%;"></select>
      </label>
      <label style="margin-top:8px;">Tertiary projects:<br/>
        <input type="text" id="renameExtraProjectsInput" style="width:100%;" placeholder="proj2, proj3" />
      </label>
      <div class="modal-buttons">
        <button id="renameTabSaveBtn">Save</button>
        <button id="renameTabCancelBtn">Cancel</button>
      </div>
    </div>
  </div>
  <div id="projectSettingsModal" class="modal" style="display:none;">
    <div class="modal-content">
      <h3>Project Settings</h3>
      <label>Project name:<br/>
        <input type="text" id="projectSettingsNameInput" style="width:100%;" />
      </label>
      <div class="modal-buttons">
        <button id="projectSettingsSaveBtn">Save</button>
        <button id="projectSettingsArchiveBtn">Archive</button>
        <button id="projectSettingsCancelBtn">Cancel</button>
      </div>
    </div>
  </div>
  <div id="startDialog" class="modal" style="display:flex;">
    <a href="/about.html" target="_blank" style="position:absolute; top:8px; left:8px; font-size:0.8rem; color:var(--text-color);">About</a>
    <a href="https://dev.alfe.sh/search?q=" target="_blank" style="position:absolute; top:8px; left:60px; font-size:0.8rem; color:var(--text-color);">Search</a>
    <div id="splashAnim">
      <div id="splashTitle">Alfe AI</div>
        <div id="splashYour">AI Project Management, Image Design, and Software Development</div>
    </div>
    <div class="modal-content">
      <h3>Get Started</h3>
      <div>
        <div id="startTypeButtons">
          <button data-type="code" class="start-type-btn">
            <div class="icon">üíª</div>
            <div>Code</div>
          </button>
        </div>
        <div id="startRepoSection" style="margin-top:8px; display:none;">
          <label>Git Repo SSH URL:<br/>
            <input type="text" id="startRepoInput" style="width:100%;" />
          </label>
          <div style="font-size:0.9rem; margin-top:4px;">
            note: We will update to do setup with GitHub connector/other external connectors/self host git/ AND THE URL SPECIFICATION FOR MANUAL REMOTE WILL ALSO BE AN OPTION AT THIS STEP, BUT AT THIS POINT, IT IS THE ONLY OPTION
          </div>
        </div>
      </div>
      <div id="startSocialLinks" style="margin-top:0.5rem; text-align:center;">
        <a href="/about.html" target="_blank">About</a> |
        <a href="https://github.com/alfe-ai/alfe-ai-2.0_beta">GitHub</a> |
        <a href="https://bsky.app/profile/alfeai.bsky.social">Bluesky</a><!-- | -->
        <!--<a href="https://mastodon.social/@alfeai">Mastodon</a>--><!-- | -->
        <!-- <a href="https://www.reddit.com/">Reddit</a> | -->
        <!-- <a href="https://www.linkedin.com/">LinkedIn</a> | -->
        <!-- <a href="https://x.com/">X (Twitter)</a> -->
        <!-- Discord -->
        <!-- Matrix -->
      </div>
    </div>
  </div>
  <script src="/session.js"></script>
  <script>
    // default feature flags / state vars
    let enableStartAdvanced = true;
    let startInAurora = false;

    function showPageLoader(color){
      const loader = document.getElementById('pageLoader');
      if(!loader) return;
      loader.style.color = color || '';
      loader.classList.add('show');
    }

    function hidePageLoader(){
      const loader = document.getElementById('pageLoader');
      if(loader) loader.classList.remove('show');
    }

    function applyTheme(){ /* theming disabled */ }
    const urlParams = new URLSearchParams(location.search);
    const startTab = parseInt(urlParams.get('tabId'), 10);
    if(!Number.isNaN(startTab)) currentTabId = startTab;


    async function loadModelInfo(){
      try{
        const res = await fetch('/api/model');
        if(!res.ok) return;
        const data = await res.json();
        document.getElementById('modelInfo').textContent = 'Model: ' + (data.model || 'unknown');
      }catch(e){console.error(e);}
    }

    async function loadTabs(){
      try{
        const res = await fetch('/api/chat/tabs?nexum=1&showArchived=' + (showArchived ? '1' : '0'));
        if(res.ok){
          tabs = await res.json();
        } else {
          tabs = [];
        }
      }catch(e){ tabs = []; console.error(e); }
    }

  function renderTabs(){
    const container = document.getElementById('tabsList');
    container.innerHTML = '';
    tabs.forEach(t => {
        const item = document.createElement('div');
        item.className = 'tab-item';

        const b = document.createElement('button');
        const icon = document.createElement('span');
        icon.className = 'type-icon';
        icon.textContent = t.tab_type === 'task' ? '</>' : 'üí¨';
        b.appendChild(document.createTextNode(t.name));
        b.appendChild(icon);
        if(t.id === currentTabId) b.classList.add('active');
        b.addEventListener('click', () => {
          currentTabId = t.id;
          applyTabView();
          renderTabs();
        });
        b.addEventListener('contextmenu', e => {
          e.preventDefault();
          const choice = prompt("Type 'rename' or 'delete':", "");
          if(choice === 'rename') renameTab(t.id);
          else if(choice === 'delete') deleteTab(t.id);
        });

        const gear = document.createElement('button');
        gear.innerHTML = '&#9881;';
        gear.className = 'config-btn';
        gear.addEventListener('click', (e) => { e.stopPropagation(); openTabConfig(t.id); });

        const renameBtn = document.createElement('button');
        renameBtn.innerHTML = '&#9881;';
        renameBtn.className = 'config-btn';
        renameBtn.addEventListener('click', e => { e.stopPropagation(); openRenameTabModal(t.id); });

        const archBtn = document.createElement('button');
        archBtn.innerHTML = t.archived ? 'Unarchive' : '&#128452;';
        archBtn.title = t.archived ? 'Unarchive' : 'Archive';
        archBtn.className = 'config-btn';
        archBtn.addEventListener('click', e => {
          e.stopPropagation();
          toggleArchiveTab(t.id, !t.archived);
        });

        const taskIdSpan = document.createElement('span');
        taskIdSpan.className = 'task-id';
        if (t.task_id) {
          taskIdSpan.textContent = `#${t.task_id}`;
        }

        item.appendChild(b);
        item.appendChild(gear);
        item.appendChild(renameBtn);
        item.appendChild(archBtn);
        if (t.task_id) item.appendChild(taskIdSpan);
      container.appendChild(item);
    });
    checkNoTabsDialog();
  }

  function checkNoTabsDialog(){
    const dlg = document.getElementById('startDialog');
    if(!dlg) return;
    const noTabs = tabs.length === 0;
    const showDialog = alwaysShowSplash || noTabs;
    dlg.style.display = showDialog ? 'flex' : 'none';
    // Show splash dialog without animated text
    const chatPanel = document.getElementById('chatPanel');
    if(chatPanel) chatPanel.style.display = showDialog ? 'none' : '';
    const taskPanel = document.getElementById('taskListPanel');
    if(taskPanel) taskPanel.style.display = showDialog ? 'none' : (currentView === 'tasks' ? '' : 'none');
  }

  async function loadArchivedTabs(){
    try{
      const res = await fetch('/api/chat/tabs?nexum=1&showArchived=1');
      if(res.ok){
        archivedTabs = (await res.json()).filter(t => t.archived);
      }else{
        archivedTabs = [];
      }
    }catch(e){ archivedTabs = []; console.error(e); }
  }

  function renderArchivedTabs(){
    const container = document.getElementById('archiveList');
    container.innerHTML = '';
    archivedTabs.forEach(t => {
      const item = document.createElement('div');
      item.className = 'tab-item';

      const info = document.createElement('div');
      info.style.display = 'flex';
      info.style.flexDirection = 'column';
      info.style.flexGrow = '1';

      const label = document.createElement('span');
      label.textContent = t.name;

      const date = document.createElement('span');
      date.className = 'tab-date';
      date.style.fontSize = '0.8rem';
      date.style.opacity = '0.8';
      date.textContent = `Created ${isoDateTime(t.created_at)} \u2022 Archived ${isoDateTime(t.archived_at)}`;

      info.appendChild(label);
      info.appendChild(date);
      const unarch = document.createElement('button');
      unarch.textContent = 'Unarchive';
      unarch.className = 'config-btn';
      unarch.addEventListener('click', () => toggleArchiveTab(t.id, false));
      const taskIdSpan = document.createElement('span');
      taskIdSpan.className = 'task-id';
      if (t.task_id) {
        taskIdSpan.textContent = `#${t.task_id}`;
      }
      item.appendChild(info);
      item.appendChild(unarch);
      if (t.task_id) item.appendChild(taskIdSpan);
      container.appendChild(item);
    });
  }

    function isoDate(d){
      return new Date(d).toLocaleDateString([], {year:'2-digit',month:'2-digit',day:'2-digit'});
    }

    function isoDateTime(d){
      const date = new Date(d);
      const dateStr = date.toLocaleDateString([], {year:'2-digit',month:'2-digit',day:'2-digit'});
      const timeStr = date.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit',hour12:true}).toLowerCase();
      return `${dateStr} ${timeStr}`;
    }

    function sortTasks(){
      if(!showDependencies && taskSortColumn === 'dependencies'){
        taskSortColumn = 'priority';
      }
      currentTasks.sort((a,b)=>{
        let va = a[taskSortColumn];
        let vb = b[taskSortColumn];
        if(taskSortColumn === 'created'){
          va = new Date(a.created_at);
          vb = new Date(b.created_at);
        }
        if(typeof va === 'string') va = va.toLowerCase();
        if(typeof vb === 'string') vb = vb.toLowerCase();
        if(va < vb) return taskSortAsc ? -1 : 1;
        if(va > vb) return taskSortAsc ? 1 : -1;
        return 0;
      });
    }

    function renderTaskHeader(){
      const tr = document.getElementById('headerRow');
      if(!tr) return;
      tr.innerHTML = '';
      taskColumns.forEach(col => {
        if(!showDependencies && col.key === 'dependencies') return;
        const th = document.createElement('th');
        th.textContent = col.label;
        th.dataset.key = col.key;
        th.style.cursor = 'pointer';
        if(taskSortColumn === col.key) th.textContent += taskSortAsc ? ' \u25B2' : ' \u25BC';
        th.addEventListener('click', () => {
          if(taskSortColumn === col.key){
            taskSortAsc = !taskSortAsc;
          } else {
            taskSortColumn = col.key;
            taskSortAsc = true;
          }
          sortTasks();
          renderTaskHeader();
          renderTasks(currentTasks);
        });
        tr.appendChild(th);
      });
    }

    function renderTasks(tasks){
      const tbody = document.querySelector('#tasks tbody');
      if(!tbody) return;
      tbody.innerHTML = '';
      tasks.forEach(t => {
        const tr = document.createElement('tr');
        taskColumns.forEach(col => {
          if(!showDependencies && col.key === 'dependencies') return;
          const td = document.createElement('td');
          switch(col.key){
            case 'number':
              td.innerHTML = `<a href="${t.html_url}" target="_blank">#${t.number}</a>`;
              break;
            case 'created':
              td.textContent = isoDate(t.created_at);
              break;
            default:
              td.textContent = t[col.key] || '';
          }
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });
    }

    async function loadTasksForCurrentProject(){
      const t = tabs.find(tt => tt.id === currentTabId);
      let url;
      if(!t || !t.project_name){
        url = '/api/tasks';
      }else{
        url = '/api/projects/' + encodeURIComponent(t.project_name);
      }
      try{
        const res = await fetch(url);
        if(res.ok){
          currentTasks = await res.json();
          sortTasks();
          renderTaskHeader();
          renderTasks(currentTasks);
        }else{
          currentTasks = [];
          renderTasks([]);
        }
      }catch(e){
        console.error(e);
        currentTasks = [];
        renderTasks([]);
      }
    }

    function renderSuggestions(show = true, id = 'suggestions', inputId = 'prompt'){
      const container = document.getElementById(id);
      if(!container) return;
      container.innerHTML = '';
      container.style.display = show ? 'grid' : 'none';
      if(!show) return;
      suggestions.forEach(text => {
        const b = document.createElement('button');
        b.textContent = text;
        b.addEventListener('click', () => {
          const inp = document.getElementById(inputId);
          if(inp){
            inp.value = text;
            inp.focus();
          }
        });
        container.appendChild(b);
      });
    }

    async function loadHistory(){
      try{
        const res = await fetch(`/api/chat/history?tabId=${currentTabId}&limit=20&offset=0`);
        if(!res.ok) return;
        const data = await res.json();
        const chatDiv = document.getElementById('chat');
        chatDiv.innerHTML = '';
        (data.pairs || []).reverse().forEach(p => {
          addMsg('user', p.user_text);
          if(p.ai_text) addMsg('ai', p.ai_text);
        });
        chatDiv.scrollTop = chatDiv.scrollHeight;
        renderSuggestions((data.pairs || []).length === 0, 'suggestions', 'prompt');
      }catch(e){console.error(e);}
    }
    function addMsg(role,text){
      const el=document.createElement('div');
      el.className='msg '+(role==='user'?'user':'ai');
      el.textContent=text;
      document.getElementById('chat').appendChild(el);
    }
    let newTabSelectedType = 'code';

    function openNewTabModal(){
      newTabSelectedType = 'code';
      document.getElementById('newTabChatInput').value = '';
      document.getElementById('newTabRepoInput').value = '';
      document.querySelectorAll('#newTabTypeButtons .start-type-btn').forEach(b => b.classList.remove('selected'));
      const first = document.querySelector('#newTabTypeButtons .start-type-btn[data-type="code"]');
      if(first) first.classList.add('selected');
      handleNewTabTypeChange();
      document.getElementById('newTabModal').style.display = 'flex';
    }
    async function createNewTab(){
      const type = newTabSelectedType;
      const message = document.getElementById('newTabChatInput').value.trim();
      const repo = document.getElementById('newTabRepoInput').value.trim();
      const body = { name:'New Tab', nexum:1, type, project:'', repo, sessionId };
      const r = await fetch('/api/chat/tabs/new',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
      if(r.ok){
        const data = await r.json();
        document.getElementById('newTabModal').style.display = 'none';
        await loadTabs();
        currentTabId = data.id;
        renderTabs();
        if(message){
          document.getElementById('prompt').value = message;
          await send();
        }
        applyTabView();
      }
    }

    function handleNewTabTypeChange(){
      const section = document.getElementById('newTabRepoSection');
      if(section) section.style.display = newTabSelectedType === 'code' ? '' : 'none';
    }

      async function createStartTab(type){
        const repoEl = document.getElementById('startRepoInput');
        const repo = repoEl ? repoEl.value.trim() : '';
        showPageLoader(startInAurora ? 'cyan' : null);
        const body = { name:'New Tab', nexum: startInAurora ? 0 : 1, type, project:'', repo, sessionId };
      try{
        const r = await fetch('/api/chat/tabs/new',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
        if(r.ok){
          const data = await r.json();
          document.getElementById('startDialog').style.display = 'none';
          if(startInAurora){
            await fetch('/api/settings', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({key:'last_chat_tab', value:data.id})});
            location.href = '/aurora.html';
            return;
          }
          await loadTabs();
          currentTabId = data.id;
          renderTabs();
          applyTabView();
        }
      } finally {
        if(!startInAurora) hidePageLoader();
      }
    }
    async function renameTab(tabId, newName){
      if(!newName){
        const t = tabs.find(tt => tt.id === tabId);
        newName = prompt("New name:", t ? t.name : "");
        if(!newName) return;
      }
      try{
        const r = await fetch("/api/chat/tabs/rename",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({tabId,newName})});
        if(r.ok){
          await loadTabs();
          renderTabs();
        }
      }catch(e){console.error(e);}
    }

    function openRenameTabModal(tabId){
      const t = tabs.find(tt => tt.id === tabId);
      document.getElementById('renameTabInput').value = t ? t.name : '';
      const modal = document.getElementById('renameTabModal');
      modal.dataset.tabId = tabId;
      modal.style.display = 'flex';
    }

    async function deleteTab(tabId){
      if(!confirm('Are you sure you want to delete this tab (and all its messages)?')) return;
      try{
        const r = await fetch('/api/chat/tabs/' + tabId,{method:'DELETE'});
        if(r.ok){
          await loadTabs();
          if(tabs.length>0){
            currentTabId = tabs[0].id;
          }else{
            currentTabId = 1;
          }
          renderTabs();
          if(currentView === 'chat') loadHistory();
          if(currentView === 'tasks') loadTasksForCurrentProject();
        }
      }catch(e){console.error(e);}
    }

    async function toggleArchiveTab(tabId, archived){
      try{
        const r = await fetch('/api/chat/tabs/archive',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({tabId, archived})});
        if(r.ok){
          const wasCurrent = archived && tabId === currentTabId;
          await loadTabs();
          if(wasCurrent){
            const idx = tabs.findIndex(t => t.id === tabId);
            let next = null;
            if(idx !== -1){
              for(let i = idx + 1; i < tabs.length; i++){
                if(!tabs[i].archived){ next = tabs[i]; break; }
              }
              if(!next){
                for(let i = 0; i < idx; i++){
                  if(!tabs[i].archived){ next = tabs[i]; break; }
                }
              }
            }
            if(next){
              currentTabId = next.id;
            }
          }
          renderTabs();
          if(currentView === 'archive') {
            await loadArchivedTabs();
            renderArchivedTabs();
          }
          if(currentView === 'chat') loadHistory();
          if(currentView === 'tasks') loadTasksForCurrentProject();
          applyTabView();
        }
      }catch(e){console.error(e);}
    }

    function openTabConfig(tabId){
      const t = tabs.find(tt => tt.id === tabId) || {};
      document.getElementById('tabProjectInput').value = t.project_name || '';
      document.getElementById('tabRepoInput').value = t.repo_ssh_url || '';
      document.getElementById('tabTypeSelect').value = t.tab_type || 'chat';
      const modal = document.getElementById('tabConfigModal');
      modal.dataset.tabId = tabId;
      modal.style.display = 'flex';
    }

    function updateView(v){
      currentView = v;
      document.getElementById('viewTabChat').classList.toggle('active', v === 'chat');
      document.getElementById('viewTabTasks').classList.toggle('active', v === 'tasks');
      document.getElementById('viewTabArchive').classList.toggle('active', v === 'archive');

      const sendBtn = document.getElementById('sendBtn');
      const askBtn = document.getElementById('askBtn');
      const renderBtn = document.getElementById('renderBtn');
      const codeBtn = document.getElementById('codeBtn');
      if(sendBtn && askBtn && renderBtn && codeBtn){
        const t = tabs.find(tt => tt.id === currentTabId) || {};
        const type = t.tab_type || 'chat';
        const hasRepo = !!(t.repo_ssh_url && t.repo_ssh_url.trim());
        const isCode = type === 'code';
        if(v === 'chat'){
          sendBtn.style.display = '';
          renderBtn.style.display = '';
          askBtn.style.display = isCode ? '' : 'none';
          codeBtn.style.display = isCode && hasRepo ? '' : 'none';
        } else {
          sendBtn.style.display = 'none';
          renderBtn.style.display = '';
          askBtn.style.display = isCode ? '' : 'none';
          codeBtn.style.display = isCode && hasRepo ? '' : 'none';
        }
      }

      async function quickAddProjectTab(){
        try{
          const project = await getSetting('sterling_project') || '';
          const body = { name:'New Tab', nexum:1, type:'chat', project, repo:'', sessionId };
          const r = await fetch('/api/chat/tabs/new',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
          if(r.ok){
            const data = await r.json();
            await loadTabs();
            currentTabId = data.id;
            renderTabs();
            applyTabView();
          }
        }catch(e){ console.error(e); }
      }

      const taskPanel = document.getElementById('taskListPanel');
      if(taskPanel) taskPanel.style.display = v === 'tasks' ? '' : 'none';
      const archiveList = document.getElementById('archiveList');
      if(archiveList) archiveList.style.display = v === 'archive' ? '' : 'none';
      const tabsListEl = document.getElementById('tabsList');
      if(tabsListEl) tabsListEl.style.display = v === 'archive' ? 'none' : '';
      const newTabBtnEl = document.getElementById('newTabBtn');
      if(newTabBtnEl) newTabBtnEl.style.display = v === 'archive' ? 'none' : '';

      const chatEl = document.getElementById('chat');
      if(chatEl) chatEl.style.display = v === 'tasks' || v === 'archive' ? 'none' : '';
      const suggestionsEl = document.getElementById('suggestions');
      if(suggestionsEl) suggestionsEl.style.display = v === 'tasks' || v === 'archive' ? 'none' : '';

      const chatPanel = document.getElementById('chatPanel');
      if(chatPanel){
        chatPanel.classList.toggle('tasks-view', v === 'tasks');
        chatPanel.style.display = v === 'archive' ? 'none' : '';
      }

      if(v === 'chat') {
        loadHistory();
      }
      if(v === 'tasks') {
        renderTaskHeader();
        loadTasksForCurrentProject();
      }
      if(v === 'archive') {
        loadArchivedTabs().then(renderArchivedTabs);
      }
    }

    function applyTabView(){
      if(tabs.length === 0){
        const chatPanel = document.getElementById('chatPanel');
        if(chatPanel) chatPanel.style.display = 'none';
        const taskPanel = document.getElementById('taskListPanel');
        if(taskPanel) taskPanel.style.display = 'none';
        return;
      }
      const t = tabs.find(tt => tt.id === currentTabId);
      const isTask = t && t.tab_type === 'task';
      updateView(isTask ? 'tasks' : 'chat');
    }


      async function send(){
        const promptEl=document.getElementById('prompt');
        const text=promptEl.value.trim();
        if(!text) return;
        inputHistory.push(text);
        inputHistoryPos = -1;
        renderSuggestions(false, 'suggestions', 'prompt');
        addMsg('user',text);
        promptEl.value='';
      const aiEl=document.createElement('div');
      aiEl.className='msg ai';
      aiEl.textContent='...';
      document.getElementById('chat').appendChild(aiEl);
      document.getElementById('chat').scrollTop=document.getElementById('chat').scrollHeight;
      try{
        const resp=await fetch('/api/chat',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({message:text,tabId:currentTabId,sessionId})});
        if(!resp.ok||!resp.body){aiEl.textContent='[error]';return;}
        const reader=resp.body.getReader();
        const dec=new TextDecoder();
        let done=false;let result='';
        while(!done){
          const {value,done:doneR}=await reader.read();
          done=doneR;
          if(value){result+=dec.decode(value);aiEl.textContent=result;document.getElementById('chat').scrollTop=document.getElementById('chat').scrollHeight;}
        }
      }catch(e){aiEl.textContent='[error]';console.error(e);}
    }
    async function createTask(){
      const promptEl=document.getElementById('prompt');
      const text=promptEl.value.trim();
      if(!text) return;
      inputHistory.push(text);
      inputHistoryPos = -1;
      const tab=tabs.find(tt=>tt.id===currentTabId) || {};
      const project=tab.project_name || '';
      promptEl.value='';
      try{
        await fetch('/api/tasks/new',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({title:text, project})});
        await loadTasksForCurrentProject();
      }catch(e){console.error(e);}
    }

    async function generateImage(){
      const promptEl=document.getElementById('prompt');
      const text=promptEl.value.trim();
      if(!text) return;
      inputHistory.push(text);
      inputHistoryPos = -1;
      addMsg('user', text);
      promptEl.value='';
      const aiEl=document.createElement('div');
      aiEl.className='msg ai';
      aiEl.textContent='...';
      document.getElementById('chat').appendChild(aiEl);
      document.getElementById('chat').scrollTop=document.getElementById('chat').scrollHeight;
      try{
        const payload={prompt:text, tabId:currentTabId, sessionId};
        console.debug('Sending /api/image/generate', payload);
        const resp=await fetch('/api/image/generate',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
        console.debug('/api/image/generate status', resp.status);
        const raw=await resp.clone().text().catch(()=>'' );
        console.debug('/api/image/generate body', raw);
        const data=await resp.json().catch(e=>{console.error('JSON parse error',e);return{}});
        if(resp.ok && data.url){
          aiEl.textContent='';
          const img=document.createElement('img');
          img.src=data.url;
          img.alt=text;
          img.style.maxWidth='100%';
          aiEl.appendChild(img);
        }else{
          aiEl.textContent=data.error||'[error]';
        }
      }catch(e){
        aiEl.textContent='[error]';
        console.error(e);
      }
    }
    document.addEventListener('DOMContentLoaded', () => {
      // Display the generated session ID in the About overlay
      const sessEl = document.getElementById('sessionIdText');
      if(sessEl) sessEl.textContent = sessionId;
      fetch('/api/settings/show_session_id')
        .then(r => r.ok ? r.json() : { value: false })
        .then(d => {
          const show = d.value !== false;
          const displayEl = document.getElementById('sessionIdDisplay');
          if(displayEl) displayEl.style.display = show ? 'block' : 'none';
        })
        .catch(() => {});

      document.getElementById('sendBtn').addEventListener('click',send);
      document.getElementById('askBtn').addEventListener('click',send);
      document.getElementById('codeBtn').addEventListener('click',createTask);
      document.getElementById('renderBtn').addEventListener('click',generateImage);
    document.getElementById('prompt').addEventListener('keydown', e => {
      if(e.key==='ArrowUp'){
        if(inputHistory.length>0){
          if(inputHistoryPos===-1) inputHistoryPos = inputHistory.length-1;
          else if(inputHistoryPos>0) inputHistoryPos--;
          e.target.value = inputHistory[inputHistoryPos] || '';
          setTimeout(()=>{e.target.setSelectionRange(e.target.value.length, e.target.value.length);},0);
        }
        e.preventDefault();
      } else if(e.key==='ArrowDown'){
        if(inputHistory.length>0){
          if(inputHistoryPos>=0 && inputHistoryPos<inputHistory.length-1){
            inputHistoryPos++;
            e.target.value = inputHistory[inputHistoryPos] || '';
          } else {
            inputHistoryPos = -1;
            e.target.value = '';
          }
          setTimeout(()=>{e.target.setSelectionRange(e.target.value.length, e.target.value.length);},0);
        }
        e.preventDefault();
      } else if(e.key==='Enter' && !e.shiftKey){
        e.preventDefault();
        send();
      }
    });
    document.getElementById('newTabBtn').addEventListener('click', openNewTabModal);
    document.getElementById('newTabCreateBtn').addEventListener('click', createNewTab);
    document.getElementById('newTabCancelBtn').addEventListener('click', () => {
      document.getElementById('newTabModal').style.display = 'none';
    });
    document.getElementById('newTabModal').addEventListener('click', e => {
      if(e.target === e.currentTarget) e.currentTarget.style.display = 'none';
    });
    document.getElementById('renameTabSaveBtn').addEventListener('click', async () => {
      const modal = document.getElementById('renameTabModal');
      const tabId = parseInt(modal.dataset.tabId, 10);
      const name = document.getElementById('renameTabInput').value.trim();
      if(name) await renameTab(tabId, name);
      modal.style.display = 'none';
    });
    document.getElementById('renameTabCancelBtn').addEventListener('click', () => {
      document.getElementById('renameTabModal').style.display = 'none';
    });
    document.getElementById('renameTabModal').addEventListener('click', e => {
      if(e.target === e.currentTarget) e.currentTarget.style.display = 'none';
    });
    document.querySelectorAll('#newTabTypeButtons .start-type-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        newTabSelectedType = btn.dataset.type;
        document.querySelectorAll('#newTabTypeButtons .start-type-btn').forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
        handleNewTabTypeChange();
      });
    });
    document.querySelectorAll('#startTypeButtons .start-type-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        if(btn.disabled) return;
        createStartTab(btn.dataset.type);
      });
    });
    document.getElementById('viewTabChat').addEventListener('click', () => updateView('chat'));
    document.getElementById('viewTabTasks').addEventListener('click', () => updateView('tasks'));
    document.getElementById('viewTabArchive').addEventListener('click', () => updateView('archive'));

    function applyFeatureFlags(){
      const chatBtn = document.getElementById('viewTabChat');
      if(chatBtn) chatBtn.style.display = '';
      const advanced = enableStartAdvanced;
      const disableTypes = advanced ? [] : ['code','task'];
      ['code','design','task','pm_agi','search'].forEach(t => {
        const disabled = disableTypes.includes(t);
        const btn = document.querySelector(`#startTypeButtons .start-type-btn[data-type="${t}"]`);
        if(btn){
          btn.classList.toggle('disabled', disabled);
          btn.disabled = disabled;
        }
        const newBtn = document.querySelector(`#newTabTypeButtons .start-type-btn[data-type="${t}"]`);
        if(newBtn){
          newBtn.classList.toggle('disabled', disabled);
          newBtn.disabled = disabled;
        }
      });
      showDependencies = localStorage.getItem('flagShowDependencies') === 'true';
      showArchived = localStorage.getItem('flagShowArchived') === 'true';
      showFeedbackButton = localStorage.getItem('flagShowFeedback') !== 'false';
      startInAurora = localStorage.getItem('flagAuroraStart') !== 'false';
      alwaysShowSplash = localStorage.getItem('flagSplashAlways') !== 'false';
      const cbDeps = document.getElementById('flagShowDependencies');
      if(cbDeps) cbDeps.checked = showDependencies;
      const cbArch = document.getElementById('flagShowArchived');
      if(cbArch) cbArch.checked = showArchived;
      const cbFeedback = document.getElementById('flagShowFeedback');
      if(cbFeedback) cbFeedback.checked = showFeedbackButton;
      const cbAurora = document.getElementById('flagAuroraStart');
      if(cbAurora) cbAurora.checked = startInAurora;
      const cbSplash = document.getElementById('flagSplashAlways');
      if(cbSplash) cbSplash.checked = alwaysShowSplash;
      const feedbackBtn = document.getElementById('feedbackBtn');
      if(feedbackBtn) feedbackBtn.style.display = showFeedbackButton ? '' : 'none';
      if(currentView === 'tasks'){
        renderTaskHeader();
        renderTasks(currentTasks);
      }
    }

    document.getElementById('flagShowDependencies').addEventListener('change', e => {
      localStorage.setItem('flagShowDependencies', e.target.checked);
      applyFeatureFlags();
    });

    document.getElementById('flagShowArchived').addEventListener('change', e => {
      localStorage.setItem('flagShowArchived', e.target.checked);
      applyFeatureFlags();
      loadTabs().then(renderTabs);
    });

    document.getElementById('flagShowFeedback').addEventListener('change', e => {
      localStorage.setItem('flagShowFeedback', e.target.checked);
      applyFeatureFlags();
    });

    document.getElementById('flagAuroraStart').addEventListener('change', e => {
      localStorage.setItem('flagAuroraStart', e.target.checked);
      applyFeatureFlags();
    });

    document.getElementById('flagSplashAlways').addEventListener('change', e => {
      localStorage.setItem('flagSplashAlways', e.target.checked);
      applyFeatureFlags();
      renderTabs();
    });


      document.getElementById('settingsBtn').addEventListener('click', () => {
        document.getElementById('settingsModal').style.display = 'flex';
      });
      document.getElementById('projectNewTabBtn').addEventListener('click', quickAddProjectTab);
      document.getElementById('closeSettingsBtn').addEventListener('click', () => {
        document.getElementById('settingsModal').style.display = 'none';
      });
    document.getElementById('settingsModal').addEventListener('click', e => {
      if(e.target === e.currentTarget) e.currentTarget.style.display = 'none';
    });

    document.getElementById('feedbackBtn').addEventListener('click', () => {
      document.getElementById('feedbackModal').style.display = 'flex';
    });
    document.getElementById('feedbackCancelBtn').addEventListener('click', () => {
      document.getElementById('feedbackModal').style.display = 'none';
    });
    document.getElementById('feedbackSubmitBtn').addEventListener('click', async () => {
      const msg = document.getElementById('feedbackText').value;
      const type = document.getElementById('feedbackTypeSelect').value;
      await fetch('/api/feedback', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({message: msg, type})});
      document.getElementById('feedbackModal').style.display = 'none';
      document.getElementById('feedbackText').value = '';
    });
    document.getElementById('feedbackModal').addEventListener('click', e => {
      if(e.target === e.currentTarget) e.currentTarget.style.display = 'none';
    });

    document.getElementById('aboutLink').addEventListener('click', () => {
      document.getElementById('aboutOverlay').style.display = 'flex';
    });
    document.getElementById('backToApp').addEventListener('click', () => {
      document.getElementById('aboutOverlay').style.display = 'none';
    });

    document.getElementById('tabConfigSaveBtn').addEventListener('click', async () => {
      const modal = document.getElementById('tabConfigModal');
      const tabId = parseInt(modal.dataset.tabId, 10);
      const project = document.getElementById('tabProjectInput').value;
      const repo = document.getElementById('tabRepoInput').value;
      const type = document.getElementById('tabTypeSelect').value;
      await fetch('/api/chat/tabs/config', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({tabId, project, repo, type})});
      modal.style.display = 'none';
      await loadTabs();
      renderTabs();
      applyTabView();
      if(currentView === 'tasks') loadTasksForCurrentProject();
    });
    document.getElementById('tabConfigCancelBtn').addEventListener('click', () => {
      document.getElementById('tabConfigModal').style.display = 'none';
    });
      document.getElementById('tabConfigModal').addEventListener('click', e => {
        if(e.target === e.currentTarget) e.currentTarget.style.display = 'none';
      });

      async function init(){
        loadModelInfo();
        applyFeatureFlags();
        await loadTabs();
        await loadArchivedTabs();
        if(tabs.length>0){
          if(!Number.isNaN(startTab) && tabs.some(t=>t.id===startTab)){
            currentTabId = startTab;
          }else{
            currentTabId = tabs[0].id;
          }
        }
        renderTabs();
        renderSuggestions(false, 'suggestions', 'prompt'); // show/hide after history loads
        applyTabView();
      }
      init();

      const collapsedLogo = document.getElementById('collapsedSidebarLogo');
      const expandArrow = document.getElementById('expandSidebarArrow');
      function toggleSidebar(){
        const sb = document.getElementById('sidebar');
        const hidden = sb.style.display === 'none';
        sb.style.display = hidden ? '' : 'none';
        if(collapsedLogo) collapsedLogo.style.display = hidden ? 'none' : 'block';
        if(expandArrow) expandArrow.style.display = hidden ? 'none' : 'block';
      }

      document.getElementById('sidebarToggle').addEventListener('click', toggleSidebar);
      collapsedLogo?.addEventListener('click', toggleSidebar);
      expandArrow?.addEventListener('click', toggleSidebar);

    });

  </script>
  <div id="cookieBanner">
    This site uses cookies to store your preferences.
    <button id="cookieMoreInfoBtn">More Info</button>
    <button id="cookieAcceptBtn">Accept</button>
  </div>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const banner = document.getElementById('cookieBanner');
      if(banner){
        if(!localStorage.getItem('cookieAccepted')) banner.style.display = 'block';
        document.getElementById('cookieAcceptBtn').addEventListener('click', () => {
          localStorage.setItem('cookieAccepted', 'yes');
          banner.style.display = 'none';
        });
        document.getElementById('cookieMoreInfoBtn').addEventListener('click', () => {
          window.open('/cookies.html', '_blank');
        });
      }
    });
  </script>
  <div id="pageLoader" class="page-loader"><span class="loading-spinner"></span></div>
</body>
</html>
