<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Local SKU Database</title>
  <link rel="stylesheet" href="/styles.css">
</head>
<body style="padding:1rem;">
  <h2>Local SKU Database</h2>
  <p>
    <a href="/">&larr; Back</a>
    |
    <a href="get_skus.html">Import SKUs</a>
  </p>
  <table id="skuTable" style="width:100%;border-collapse:collapse;">
    <thead>
      <tr>
        <th>ID</th>
        <th>SKU</th>
        <th>ASIN</th>
        <th>Title</th>
        <th>Created</th>
        <th>Prep Info</th>
        <th>Labeling</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <button id="refreshBtn" style="margin-top:1rem;">Refresh</button>
  <script src="/session.js"></script>
  <script>
    let sellerId = '';
    let marketplaceId = '';

    async function loadSettings(){
      try {
        const res = await fetch('/api/settings?keys=amazon_seller_id,amazon_marketplace_id');
        if(res.ok){
          const data = await res.json();
          (data.settings || []).forEach(s => {
            if(s.key === 'amazon_seller_id') sellerId = s.value || '';
            if(s.key === 'amazon_marketplace_id') marketplaceId = s.value || '';
          });
        }
      }catch(e){ console.error(e); }
    }

    async function loadSkus(){
      try {
        const res = await fetch('/api/local_skus');
        const data = await res.json();
        const tbody = document.querySelector('#skuTable tbody');
        tbody.innerHTML = '';
        (data.skus || []).forEach(s => {
          const tr = document.createElement('tr');
          const created = (s.created_at || '').replace('T',' ').split('.')[0];
          tr.innerHTML = `<td>${s.id}</td><td>${s.sku||''}</td><td>${s.asin||''}</td><td>${s.title||''}</td><td>${created}</td><td class="prep-info" data-sku="${s.sku||''}">-</td><td class="labeling-info" data-sku="${s.sku||''}">-</td><td><button class="prep-btn" data-sku="${s.sku||''}">Update Prep Info</button></td>`;
          const btn = tr.querySelector('.prep-btn');
          btn.addEventListener('click', () => updatePrep(btn.dataset.sku));
          tbody.appendChild(tr);
        });
      } catch(err){
        console.error(err);
      }
    }
    document.getElementById('refreshBtn').addEventListener('click', loadSkus);
    loadSettings().then(loadSkus);

    async function updatePrep(sku){
      if(!sellerId || !marketplaceId){
        alert('Missing Amazon seller or marketplace ID');
        return;
      }
      try {
        const resp = await fetch('/api/amazon/updatePrepInfo', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ sellerId, marketplaceId, sku })
        });
        const data = await resp.json();
        console.log('Update response:', data);
        if(data.success){
          const prepEl = document.querySelector(`.prep-info[data-sku="${sku}"]`);
          const labelEl = document.querySelector(`.labeling-info[data-sku="${sku}"]`);
          if(prepEl) prepEl.textContent = 'Prep not needed';
          if(labelEl) labelEl.textContent = 'seller labels units';
        }
      } catch(err){
        console.error('Update failed:', err);
      }
    }
  </script>
</body>
</html>
