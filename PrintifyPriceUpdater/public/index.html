<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>SKU Tracker</title>
</head>
<body>
  <h1>SKU Tracker</h1>
  <input id="sku-input" placeholder="Enter SKU" />
  <button id="add-btn">Add</button>
  <table id="sku-table">
    <thead>
      <tr>
        <th>ID</th>
        <th>SKU</th>
        <th>Title</th>
        <th>eBay ID</th>
        <th>Status</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <script>
    async function loadSkus() {
      const res = await fetch('/api/skus');
      const skus = await res.json();
      const tbody = document.querySelector('#sku-table tbody');
      tbody.innerHTML = '';
      skus.forEach(s => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${s.id}</td><td>${s.sku}</td><td>${s.title}</td><td>${s.ebayId || ''}</td><td>${s.status || 'Init'}</td>`;
        const actions = document.createElement('td');

        const btn = document.createElement('button');
        btn.textContent = s.ebayId ? 'Refresh eBay ID' : 'Fetch eBay ID';
        btn.addEventListener('click', async () => {
          try {
            const resp = await fetch(`/api/skus/${s.id}/ebay`, { method: 'POST' });
            if (resp.ok) {
              loadSkus();
            } else {
              const msg = await resp.text();
              alert('Failed to fetch eBay ID: ' + msg);
            }
          } catch (err) {
            alert('Failed to fetch eBay ID: ' + err.message);
          }
        });
        actions.appendChild(btn);

        const priceBtn = document.createElement('button');
        priceBtn.textContent = 'Price Update';
        priceBtn.addEventListener('click', async () => {
          try {
            const resp = await fetch(`/api/skus/${s.id}/price-update`, { method: 'POST' });
            if (resp.ok) {
              alert('Price updated');
              loadSkus();
            } else {
              const msg = await resp.text();
              alert('Failed to update price: ' + msg);
            }
          } catch (err) {
            alert('Failed to update price: ' + err.message);
          }
        });
        actions.appendChild(priceBtn);

        const shipBtn = document.createElement('button');
        shipBtn.textContent = 'Set Shipping Policy';
        shipBtn.disabled = !s.ebayId;
        shipBtn.addEventListener('click', async () => {
          if (!s.ebayId) return alert('Set eBay ID first');
          try {
            const resp = await fetch(`/api/skus/${s.id}/shipping-policy`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ listingId: s.ebayId })
            });
            if (resp.ok) {
              alert('Shipping policy updated');
              loadSkus();
            } else {
              const msg = await resp.text();
              console.error('Shipping policy update failed', resp.status, msg);
              alert('Failed to update policy: ' + msg);
            }
          } catch (err) {
            console.error('Shipping policy request failed', err);
            alert('Failed to update policy: ' + err.message);
          }
        });
        actions.appendChild(shipBtn);

        const doneBtn = document.createElement('button');
        doneBtn.textContent = 'Done';
        doneBtn.addEventListener('click', async () => {
          await fetch(`/api/skus/${s.id}/done`, { method: 'POST' });
          loadSkus();
        });
        actions.appendChild(doneBtn);

        const delBtn = document.createElement('button');
        delBtn.textContent = 'Delete';
        delBtn.addEventListener('click', async () => {
          if (!confirm('Delete this SKU?')) return;
          await fetch(`/api/skus/${s.id}`, { method: 'DELETE' });
          loadSkus();
        });
        actions.appendChild(delBtn);

        tr.appendChild(actions);
        tbody.appendChild(tr);
      });
    }
    document.getElementById('add-btn').addEventListener('click', async () => {
      const sku = document.getElementById('sku-input').value.trim();
      if (!sku) return;
      await fetch('/api/skus', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ sku })
      });
      document.getElementById('sku-input').value = '';
      loadSkus();
    });
    loadSkus();
  </script>
</body>
</html>
